<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FamLang – informell, familiär (FR ⇄ DE)</title>
<style>
  :root{
    --bg:#0f1115;--fg:#e8ebf0;--muted:#9aa3b2;--card:#151822;--chip:#232738;--ring:#2b3246;
    --accent:#5aa9ff;--ok:#45d483;--warn:#e6b84a;--bad:#e06b6b;--ink:#081217;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:980px;margin:20px auto;padding:0 16px}

  header h1{margin:0;font-weight:800;letter-spacing:.3px}
  header small{color:var(--muted);font-weight:600}
  header p{margin:8px 0 0;color:var(--muted)}

  /* Controls shell (collapsible) */
  #controls{margin-top:14px;border:1px solid var(--ring);background:var(--card);border-radius:14px}
  #controls .controls-header{
    display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid var(--ring)
  }
  #controls .controls-title{display:flex;gap:10px;align-items:center}
  #controls .controls-actions{display:flex;gap:8px;align-items:center}
  #controls .controls-body{padding:12px}
  .toggle{border:1px solid var(--ring);background:var(--chip);color:var(--fg);border-radius:12px;padding:8px 12px;font-weight:700;cursor:pointer}
  #controls.collapsed .controls-body{display:none}
  #controls.collapsed .toggle[data-for="controls"]::after{content:" anzeigen"}
  #controls:not(.collapsed) .toggle[data-for="controls"]::after{content:" ausblenden"}

  .bar{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
  .search{display:flex;gap:8px;align-items:center;background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:10px 12px}
  .search input{flex:1;background:transparent;border:0;outline:none;color:var(--fg);font-size:17px;min-height:40px}

  .filters{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 4px}
  select,button{background:var(--chip);color:var(--fg);border:1px solid var(--ring);border-radius:14px;padding:10px 14px;font-size:14px;cursor:pointer;min-height:40px}
  button[aria-pressed="true"]{outline:2px solid var(--accent)}

  #coach{display:grid;gap:10px;margin:8px 0}
  #coach .bar{display:flex;gap:8px;flex-wrap:wrap}
  #due-count{font-weight:800}
  #problems{display:flex;gap:8px;flex-wrap:wrap}
  .wchip{padding:8px 12px;border-radius:999px;border:1px solid var(--ring);background:#202638}
  .wchip.bad{background:#3b1c1c;border-color:#6e2e2e}
  .wchip.mid{background:#3b3417;border-color:#6e6126}

  #daily{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:12px;margin:10px 0}
  #daily .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  #daily .meter{height:10px;border-radius:8px;background:#2a2f3f;border:1px solid var(--ring);overflow:hidden;margin-top:8px}
  #daily .meter>span{display:block;height:100%;background:linear-gradient(90deg,var(--bad),#e39f3a,var(--ok));width:0%}
  .chip-mini{padding:4px 8px;border:1px solid var(--ring);border-radius:999px;background:#202638;font-size:12px}

  .grid{display:grid;grid-template-columns:1fr;gap:14px;margin:14px 0 40px}
  @media (min-width:720px){.grid{grid-template-columns:1fr 1fr}}

  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.25)}
  .cat{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--ring);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .top{justify-content:space-between;margin-bottom:6px}
  .txt-main{font-size:20px;margin:6px 0 2px;font-weight:800}
  .txt-sub{font-size:16px;margin:2px 0;color:#d7dbef}
  .txt-de{font-size:13px;margin:6px 0 10px;color:var(--muted)}
  .empty{margin:24px 0;color:var(--muted);text-align:center}

  .legend{display:flex;gap:14px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;vertical-align:middle;margin-right:6px}
  .ok{background:var(--ok)} .mid{background:var(--warn)} .bad{background:var(--bad)}

  .chips{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 8px}
  .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--ring);background:#202638;font-weight:700}
  .chip.ok{background:#173628;border-color:#245e3f}
  .chip.mid{background:#3b3417;border-color:#6e6126}
  .chip.bad{background:#3b1c1c;border-color:#6e2e2e}
  .chip.miss{background:#263045;border-color:#3a4a6b}

  .meter{height:10px;border-radius:8px;background:#2a2f3f;border:1px solid var(--ring);overflow:hidden}
  .meter>span{display:block;height:100%;background:linear-gradient(90deg,var(--bad),#e39f3a,var(--ok));width:0%}

  .heard{border:1px dashed var(--ring);background:#121724;border-radius:12px;padding:12px;margin:6px 0 10px}
  .heard h5{margin:0 0 6px;font-size:14px;color:var(--muted)}
  .heard .text{font-size:16px}
  .heard .sub{color:var(--muted);font-size:13px;margin-top:4px}

  .ipa{font-family:serif;font-style:italic;color:#cfe;padding-top:4px}
  .syl{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .syl .s{padding:4px 8px;border-radius:10px;border:1px solid var(--ring);background:#202638;cursor:pointer}

  .statsline{color:var(--muted);font-size:13px;margin:8px 0 6px}

  .actions{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
  .btn{border-radius:14px;border:1px solid var(--ring);background:var(--chip);padding:12px 10px;font-weight:700;text-align:center}
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:scale(.98)}
  .btn-ghost{opacity:.9}

  .record-wrap{margin-top:10px}
  .btn-record{width:100%;border-radius:14px;border:0;padding:14px 12px;font-weight:900;letter-spacing:.2px;text-align:center}
  .btn-record.ready{background:#2dd4bf;color:var(--ink)}
  .btn-record.recording{background:#e26666;color:#fff}
  .btn-record.disabled{background:#444;color:#999;cursor:not-allowed}

  .pack-title{grid-column:1/-1;margin:6px 0 2px;color:var(--muted);font-weight:600}
  #load-warn{margin:10px 0;padding:10px;border:1px solid #8b5;border-radius:10px;background:#1b2620;color:#cde;font-size:13px}

  /* Floating control */
  .floatbar{
    position:fixed; right:12px; bottom:12px; z-index:9999;
    display:flex; gap:8px; align-items:center;
    background:rgba(21,24,34,.9); border:1px solid var(--ring); border-radius:14px;
    padding:8px; backdrop-filter:saturate(120%) blur(6px);
  }
  .floatbar .fbtn{
    border:1px solid var(--ring); background:var(--chip); color:var(--fg);
    border-radius:12px; padding:10px 12px; font-weight:800; cursor:pointer;
  }
  .floatbar .stop{ background:#e26666; color:#fff; }
  .floatbar .next{ background:#2dd4bf; color:#081217; }
  .floatbar small{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>FamLang – informell, familiär <small>(FR ⇄ DE)</small></h1>
    <p>Französisch als Hauptsprache, deutsche Übersetzung als Hilfe. Alles läuft als Einzeldatei und ist GitHub-Pages-sicher.</p>
  </header>

  <!-- Collapsible controls -->
  <section id="controls" class="collapsed">
    <div class="controls-header">
      <div class="controls-title">
        <strong>Steuerung & Übersicht</strong>
        <span id="top-summary" class="chip-mini">Heute: <span id="sum-attempts">0</span> · Ø <span id="sum-avg">0</span>% · Streak <span id="sum-streak">0🔥</span></span>
      </div>
      <div class="controls-actions">
        <button class="toggle" data-for="controls" id="controls-toggle">Steuerung</button>
      </div>
    </div>
    <div class="controls-body">
      <div class="bar" style="margin-bottom:12px">
        <div class="search" role="search">
          <input id="q" type="search" placeholder="Suche (FR/DE)…" autocomplete="off" />
          <button id="mic" class="toggle" title="Spracherkennung starten/stoppen">Mikrofon</button>
        </div>
        <div class="controls-actions">
          <button id="start-sr" class="toggle">SR-Session starten</button>
          <button id="toggle-shadow" class="toggle" aria-pressed="false">Shadowing: Aus</button>
        </div>
      </div>

      <div class="filters">
        <select id="category"><option value="">Alle Kategorien</option></select>
        <button id="show-today" class="toggle" aria-pressed="false">Heute</button>
        <button id="show-all" class="toggle" aria-pressed="true">Alle</button>
        <button id="show-packs" class="toggle" aria-pressed="false">Packs</button>
        <button id="tts-toggle" class="toggle" aria-pressed="false" title="Vorlesen beim Antippen aktivieren/deaktivieren">Auto-TTS: Aus</button>
        <span id="due-count" class="chip-mini">0 fällig</span>
      </div>

      <div id="coach">
        <div id="problems" hidden></div>
      </div>

      <div id="daily" hidden>
        <div class="row">
          <strong>Heute:</strong>
          <span id="d-attempts">0 Versuche</span> ·
          <span id="d-average">Ø 0%</span> ·
          <span id="d-target">Ziel: 30</span>
          <span class="chip-mini" id="streak-day">Tages-Streak: 0🔥</span>
          <span class="chip-mini" id="streak-week">Wochen-Streak: 0🔥</span>
        </div>
        <div class="meter" aria-label="Tagesziel Fortschritt"><span id="d-meter" style="width:0%"></span></div>
        <div class="bar" style="margin-top:10px">
          <button id="export-log" class="toggle">Log exportieren</button>
          <button id="reset-log" class="toggle">Log zurücksetzen</button>
        </div>
      </div>
    </div>
  </section>

  <div id="load-warn" hidden></div>

  <div id="results" class="grid" aria-live="polite"></div>
  <div id="empty" class="empty" hidden>Keine Einträge gefunden.</div>
</div>

<!-- Floating global controls -->
<div class="floatbar" id="floatbar" hidden>
  <button class="fbtn stop" id="fb-stop">◼ Stop</button>
  <button class="fbtn next" id="fb-next">▶ Nächste</button>
  <small id="fb-status">Shadow aktiv</small>
</div>

<script>
(()=>{
/* ================= Config ================= */
const TARGET_DAILY_ATTEMPTS = 30;
const STORAGE_KEY = 'famlang_logs_v1';
const SR_KEY = 'famlang_sr_v1';
const PREFS_KEY = 'famlang_prefs_v1';
const SHADOW_GAP_AFTER_FAST = 1500;
const SHADOW_GAP_AFTER_SLOW = 3500;
const LEN_MULT_FAST = 40;
const LEN_MULT_SLOW = 60;
const SHOW_RESULT_MS = 2500;

/* ================ Helpers ================= */
const $ = (s, r=document)=>r.querySelector(s);
const $$= (s, r=document)=>Array.from(r.querySelectorAll(s));
const BASE=new URL('./', location.href);
const urlFor=p=>new URL(p, BASE).toString();
const fetchJson=async(p)=>{const res=await fetch(urlFor(p),{cache:'no-store'}); if(!res.ok) throw new Error(`Fetch failed ${p}: ${res.status}`); return res.json();};
const escHtml=s=>String(s).replace(/[&<>"]/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
const escAttr=s=>escHtml(s).replace(/`/g,'&#96;');
const todayStr=()=>new Date().toISOString().slice(0,10);
function isoWeekParts(d){ const date=new Date(d.getTime()); date.setHours(0,0,0,0); date.setDate(date.getDate()+4-(date.getDay()||7)); const yearStart=new Date(date.getFullYear(),0,1); const week=Math.ceil((((date - yearStart)/86400000)+1)/7); return {year:date.getFullYear(), week}; }
function isoKeyFromISO(iso){ const d=new Date(iso); const p=isoWeekParts(d); return p.year+'-W'+String(p.week).padStart(2,'0'); }
const smoothTop=()=>window.scrollTo({top:0, behavior:'smooth'});

/* ================ State =================== */
const state = {
  show:'all', category:'', q:'',
  items:[], categories:new Set(), todaySet:new Set(),
  tts:{enabled:false,voices:[],ready:false,pref:'google'},
  logs:[],
  sr:{}, srQueue:[],
  shadow:false,
  shadowRunning:false,
  shadowCurrent:null,
  prefs:{ collapsedControls:true }
};
let manifestOrder=[];
let shadowTimers = [];
let activeRecognizer = null;

/* ============== Prefs ===================== */
function loadPrefs(){ try{ state.prefs = Object.assign(state.prefs, JSON.parse(localStorage.getItem(PREFS_KEY)||'{}')); }catch{} }
function writePrefs(){ try{ localStorage.setItem(PREFS_KEY, JSON.stringify(state.prefs)); }catch{} }

/* ============== TTS ======================= */
function pickVoiceFor(lang, prefer='google'){
  const want=(lang||'').slice(0,2).toLowerCase();
  const vs=state.tts.voices||[];
  const isG=v=>/google/i.test(v.name||''); const isS=v=>/samsung/i.test(v.name||'');
  const starts=v=>(v.lang||'').toLowerCase().startsWith(want);
  const incl  =v=>(v.lang||'').toLowerCase().includes(want);
  const order={google:[v=>isG(v)&&starts(v), v=>isG(v)&&incl(v), v=>!isS(v)&&starts(v), v=>!isS(v)&&incl(v), v=>isS(v)&&starts(v), v=>isS(v)&&incl(v)],
               any:[v=>starts(v), v=>incl(v)]}[prefer||'google'];
  for(const f of order){const m=vs.find(f); if(m) return m;}
  return null;
}
function speak(text, rate=1.0){
  if(!text || !text.trim()) return;
  try{
    if (!state.tts.ready && 'speechSynthesis' in window) {
      setTimeout(()=>speak(text, rate), 120);
      return;
    }
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text);
    const v=pickVoiceFor('fr-FR','google');
    if(v){ u.voice=v; u.lang=v.lang||'fr-FR'; } else u.lang='fr-FR';
    u.rate=rate; u.pitch=1.0;
    setTimeout(()=>speechSynthesis.speak(u),100);
  }catch(e){ console.error(e); }
}
function initTTS(){
  if(!('speechSynthesis' in window)) return;
  const load=()=>{ state.tts.voices=speechSynthesis.getVoices(); state.tts.ready=true; };
  load(); speechSynthesis.onvoiceschanged=load;
}
function updateTtsToggle(){
  const b=$('#tts-toggle');
  b.setAttribute('aria-pressed', state.tts.enabled);
  b.textContent = state.tts.enabled ? 'Auto-TTS: An' : 'Auto-TTS: Aus';
}

/* ============== Mic (search) ============= */
function initMic(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  const mic=$('#mic');
  if(!SR){ if(mic){ mic.disabled=true; mic.title='Spracherkennung nicht verfügbar'; } return; }
  let active=false; const rec=new SR(); rec.interimResults=false; rec.continuous=false;
  mic.addEventListener('click', ()=>{
    if(active){ rec.stop(); return; }
    rec.lang='fr-FR'; active=true; mic.textContent='Stoppen';
    try{ rec.start(); }catch{}
  });
  rec.onresult=e=>{
    const t=Array.from(e.results).map(r=>r[0].transcript).join(' ');
    $('#q').value=t; state.q=t.toLowerCase(); render();
  };
  const reset=()=>{ active=false; mic.textContent='Mikrofon'; };
  rec.onerror=reset; rec.onend=reset;
}

/* ========== Logs / Stats / Streaks ======= */
function loadLogs(){ try{ state.logs = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); } catch{ state.logs=[]; } }
function writeLogs(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.logs)); }catch{} }
function saveLog(entry){ state.logs.push(entry); writeLogs(); }
function getPhraseStats(id){
  const arr = state.logs.filter(x=>x.id===id).sort((a,b)=>b.tsISO.localeCompare(a.tsISO));
  const last = arr[0]?.score ?? null;
  const avg10 = arr.slice(0,10).reduce((s,x)=>s+x.score,0) / (arr.slice(0,10).length||1);
  return { last: last!=null ? Math.round(last) : null, avg10: arr.length ? Math.round(avg10) : null, count: arr.length };
}
function getDailyStats(){
  const day=todayStr(); const today=state.logs.filter(x=>x.day===day);
  const attempts=today.length; const avg=attempts?Math.round(today.reduce((s,x)=>s+x.score,0)/attempts):0;
  const pct=Math.max(0,Math.min(100,Math.round((attempts/TARGET_DAILY_ATTEMPTS)*100)));
  return {attempts, avg, pct, target:TARGET_DAILY_ATTEMPTS};
}
function getDailyStreak(){ const days=new Set(state.logs.map(l=>l.day)); let s=0, d=new Date(); for(;;){ const iso=d.toISOString().slice(0,10); if(days.has(iso)){s++; d.setDate(d.getDate()-1);} else break; } return s; }
function getWeeklyStreak(){ const weeks=new Set(state.logs.map(l=>isoKeyFromISO(l.day))); let s=0, d=new Date(); const wd=d.getDay()||7; d.setDate(d.getDate()-(wd-1)); for(;;){ const key=isoKeyFromISO(d.toISOString()); if(weeks.has(key)){s++; d.setDate(d.getDate()-7);} else break; } return s; }
function refreshDailyBox(){
  const {attempts,avg,pct,target}=getDailyStats();
  $('#d-attempts').textContent=`${attempts} Versuche`;
  $('#d-average').textContent=`Ø ${avg}%`;
  $('#d-target').textContent=`Ziel: ${target}`;
  $('#d-meter').style.width=pct+'%';
  $('#streak-day').textContent=`Tages-Streak: ${getDailyStreak()}🔥`;
  $('#streak-week').textContent=`Wochen-Streak: ${getWeeklyStreak()}🔥`;
  // compact summary in header
  $('#sum-attempts').textContent = attempts;
  $('#sum-avg').textContent = avg;
  $('#sum-streak').textContent = getDailyStreak() + '🔥';
  $('#daily').hidden=false;
}

/* ============ Problem Words ============= */
function computeProblemWords(){
  const day=todayStr(); const todays=state.logs.filter(x=>x.day===day && x.said); const map={};
  todays.forEach(e=>{
    const exp=normalize(e.exp).split(' ').filter(Boolean), said=normalize(e.said).split(' ').filter(Boolean);
    exp.forEach(w=>{ let best=0; for(const s of said){ best=Math.max(best, wordScore(w,s)); } if(!map[w]) map[w]={sum:0,count:0}; map[w].sum+=best; map[w].count++; });
  });
  const arr=Object.entries(map).map(([w,o])=>({word:w,avg:Math.round(o.sum/o.count),count:o.count})).filter(x=>x.count>=2&&x.avg<60).sort((a,b)=>a.avg-b.avg).slice(0,20);
  const box=$('#problems'); box.innerHTML=''; if(!arr.length){ box.hidden=true; return; }
  arr.forEach(({word,avg})=>{
    const el=document.createElement('button');
    el.className='wchip '+(avg<40?'bad':'mid'); el.textContent=`${word} · ${avg}%`;
    el.title='Tippen: abspielen · Gedrückt halten: aufnehmen';
    el.addEventListener('click', ()=> speak(word, 0.8));
    el.addEventListener('pointerdown', ()=>{
      let pressed=true; const up=()=>{pressed=false; window.removeEventListener('pointerup',up);}; window.addEventListener('pointerup',up,{once:true});
      setTimeout(()=>{ if(pressed) recordQuickWord(word); }, 420);
    });
    box.appendChild(el);
  });
  box.hidden=false;
}
function recordQuickWord(word){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert('Spracherkennung nicht verfügbar.'); return; }
  stopActiveRecognition(); clearShadowTimers();
  const rec=new SR(); rec.lang='fr-FR'; rec.interimResults=false; rec.continuous=false; activeRecognizer=rec;
  try{ rec.start(); }catch{}
  rec.onresult=(e)=>{
    const said=Array.from(e.results).map(r=>r[0].transcript).join(' ');
    const score=wordScore(word, said);
    alert(`Wort: ${word}\nVerstanden: ${said || '—'}\nTreffer: ${score}%`);
    saveLog({ id:`word:${word}`, pack:'', cat:'', exp:word, said, score, conf:null, tsISO:new Date().toISOString(), day:todayStr() });
    refreshDailyBox(); computeProblemWords();
  };
  const done=()=>{ if(activeRecognizer===rec) activeRecognizer=null; }; rec.onerror=done; rec.onend=done;
}

/* ============== SR Engine ================= */
function loadSR(){ try{ state.sr = JSON.parse(localStorage.getItem(SR_KEY)||'{}'); } catch{ state.sr = {}; } }
function writeSR(){ try{ localStorage.setItem(SR_KEY, JSON.stringify(state.sr)); }catch{} }
function ensureSR(id){ if(!state.sr[id]) state.sr[id]={ease:2.5, interval:0, due:todayStr(), reps:0, lapses:0, last:null}; return state.sr[id]; }
function qualityFromPercent(p){ if(p>=90) return 5; if(p>=80) return 4; if(p>=65) return 3; if(p>=50) return 2; if(p>=35) return 1; return 0; }
function addDays(dateISO, days){ const d=new Date(dateISO); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }
function updateSRFor(id, percent){
  const q=qualityFromPercent(percent); const s=ensureSR(id);
  let ease=s.ease; const delta=0.1-(5-q)*(0.08+(5-q)*0.02); ease=Math.max(1.3,Math.min(2.8,ease+delta));
  let interval=s.interval, reps=s.reps;
  if(q<3){ reps=0; interval=1; s.lapses=(s.lapses||0)+1; }
  else{ reps+=1; if(reps===1) interval=1; else if(reps===2) interval=6; else interval=Math.round(interval*ease); }
  const due=addDays(todayStr(), interval||1); Object.assign(s,{ease,interval,reps,due,last:todayStr()}); writeSR(); rebuildSRQueue();
}
function rebuildSRQueue(){
  const today=todayStr(); const ids=state.items.map(x=>x.id); const due=[];
  ids.forEach(id=>{ const s=ensureSR(id); if(!s.due) s.due=today; if(s.due<=today) due.push({id, due:s.due, reps:s.reps, ease:s.ease}); });
  due.sort((a,b)=> (a.due.localeCompare(b.due)) || (a.reps-b.reps) || (a.ease-b.ease));
  state.srQueue=due.map(x=>x.id);
  $('#due-count').textContent = state.srQueue.length + ' fällig';
}

/* ======= Shadow Control / Floating bar ======= */
function clearShadowTimers(){ shadowTimers.forEach(id=>clearTimeout(id)); shadowTimers=[]; try{ speechSynthesis.cancel(); }catch{} }
function stopActiveRecognition(){ if(activeRecognizer){ try{activeRecognizer.stop();}catch{} try{activeRecognizer.abort&&activeRecognizer.abort();}catch{} activeRecognizer=null; } }
function shadowStopAll(scrollTop=true){
  clearShadowTimers(); stopActiveRecognition();
  state.shadowRunning=false; state.shadowCurrent=null;
  const btns=$$('.shadow[data-running="true"]'); btns.forEach(b=>{b.removeAttribute('data-running'); b.textContent='Shadow ▶'; b.classList.remove('recording');});
  $('#floatbar').hidden = true;
  if(scrollTop){ smoothTop(); }
}

/* ============ Data loading & render =========== */
async function loadAll(){
  try{
    const manifest = await fetchJson('data/manifest.json');
    const packs = Array.isArray(manifest.packs)?manifest.packs:[];
    state.todaySet = new Set(Array.isArray(manifest.todayPacks)?manifest.todayPacks:[]);
    const names = manifest.categoryNames || {};
    const labels= manifest.categoryLabels || {};
    manifestOrder = Array.isArray(manifest.categoryOrder)?manifest.categoryOrder:[];
    const settled = await Promise.allSettled(packs.map(async p=>({path:p, raw:await fetchJson(p)})));

    state.items=[]; state.categories=new Set(); const failed=[];
    for(const r of settled){
      if(r.status!=='fulfilled'){ failed.push(String(r.reason?.message||r.reason||'unbekannt')); continue; }
      const {path,raw} = r.value;
      const rows = Array.isArray(raw)?raw:(Array.isArray(raw?.phrases)?raw.phrases:[]);
      const key = names[path] || raw?.name || guessCategory(path);
      const label = labels[key] || key;
      state.categories.add(key);
      if(Array.isArray(rows)){
        rows.forEach((row,idx)=>{
          state.items.push({
            id:`${path}#${idx}`,
            categoryKey:key, categoryLabel:label,
            fr:String(row.fr??''), de:String(row.de??row.en??''), hint:String(row.hint??''),
            ipa: row.ipa ? String(row.ipa) : '',
            syllables: Array.isArray(row.syllables) ? row.syllables.map(String) : (row.syllables ? String(row.syllables).split(' ') : []),
            pack:path, date:String(row.date||'')
          });
        });
      }
    }
    buildCategorySelect(); render(); showLoadReport(failed);
  }catch(e){ showError(e); }
}
function guessCategory(path){ const f=path.split('/').pop(); return (f||'').replace(/_/g,' ').replace(/\..+$/,''); }
function buildCategorySelect(){
  const sel=$('#category'), cur=sel.value;
  const keys=Array.from(state.categories);
  const ordered=[...manifestOrder.filter(k=>keys.includes(k)), ...keys.filter(k=>!manifestOrder.includes(k)).sort()];
  sel.innerHTML='<option value="">Alle Kategorien</option>'+ordered.map(k=>{
    const any=state.items.find(x=>x.categoryKey===k); const label=any?any.categoryLabel:k;
    return `<option value="${escHtml(k)}">${escHtml(label)}</option>`;
  }).join('');
  sel.value=cur||'';
}
function showLoadReport(failed){
  const el=$('#load-warn');
  if(!failed.length){ el.hidden=true; el.textContent=''; return; }
  el.hidden=false;
  el.innerHTML='⚠️ Einige Dateien konnten nicht geladen werden: '+
    failed.map(s=>`<code>${escHtml(s)}</code>`).join(', ')+
    '. Prüfe <code>data/manifest.json</code>.';
}
function showError(err){ $('#empty').hidden=false; $('#empty').textContent='Fehler beim Laden: '+(err?.message||err); console.error(err); }

function render(){
  const list=$('#results'), empty=$('#empty'); list.innerHTML='';
  let view=state.items.slice();
  if(state.category) view=view.filter(x=>x.categoryKey===state.category);
  if(state.q){
    const q=state.q;
    view=view.filter(x=> (x.fr+' '+x.de).toLowerCase().includes(q) || (x.categoryLabel||'').toLowerCase().includes(q));
  }
  if(state.show==='today'){
    const todayISO=new Date().toISOString().slice(0,10);
    view=view.filter(x=> state.todaySet.size>0 ? state.todaySet.has(x.pack) : (x.date && x.date.startsWith(todayISO)));
  }
  if(!view.length){ empty.hidden=false; return; } else empty.hidden=true;

  const frag=document.createDocumentFragment();
  if(state.show==='packs'){
    view.sort((a,b)=>a.pack.localeCompare(b.pack)||a.id.localeCompare(b.id));
    let cur=''; for(const it of view){
      if(it.pack!==cur){ cur=it.pack; const h=document.createElement('h3'); h.className='pack-title'; h.textContent=it.pack.split('/').pop(); frag.appendChild(h); }
      renderCard(frag,it);
    }
  }else{ for(const it of view) renderCard(frag,it); }
  list.appendChild(frag);

  refreshDailyBox(); rebuildSRQueue(); computeProblemWords();
}

/* ============ Card template ============ */
function renderCard(frag,item){
  const stats = getPhraseStats(item.id);
  const card=document.createElement('div'); card.className='card'; card.id='card-'+item.id.replace(/[^\w-]/g,'_');
  const ipaHtml = item.ipa ? `<div class="ipa">/${escHtml(item.ipa)}/</div>` : '';
  const sylHtml = (item.syllables && item.syllables.length)
    ? `<div class="syl">`+item.syllables.map(s=>`<button class="s" data-chunk="${escAttr(s)}">${escHtml(s)}</button>`).join(' ')+`</div>`
    : '';
  card.innerHTML=`
    <div class="row top">
      <span class="cat">${escHtml(item.categoryLabel)}</span>
      <span class="cat">${escHtml(item.pack.split('/').pop())}</span>
    </div>
    <div class="txt-main">${escHtml(item.fr||'')}</div>
    ${ipaHtml}
    ${sylHtml}
    <div class="txt-sub">DE: ${escHtml(item.de||'')}</div>
    <div class="txt-de">${item.hint?('Hinweis: '+escHtml(item.hint)):'&nbsp;'}</div>

    <div class="legend" aria-hidden="true">
      <strong class="percent">0%</strong>
      <span><span class="dot ok"></span> gut</span>
      <span><span class="dot mid"></span> okay</span>
      <span><span class="dot bad"></span> verbessern</span>
    </div>

    <div class="chips"></div>

    <div class="heard">
      <h5>Verstanden:</h5>
      <div class="text heard-text">—</div>
      <div class="sub">Konfidenz: <span class="conf">–</span></div>
    </div>

    <div class="meter"><span style="width:0%"></span></div>

    <div class="statsline">
      <span class="st-last">${ stats.last!=null ? ('Letzter: '+stats.last+'%') : 'Letzter: —' }</span> ·
      <span class="st-avg10">${ stats.avg10!=null ? ('Ø(10): '+stats.avg10+'%') : 'Ø(10): —' }</span> ·
      <span class="st-count">Versuche: ${stats.count}</span>
    </div>

    <div class="actions">
      <button class="btn say" data-rate="1.0" data-text="${escAttr(item.fr||'')}">Abspielen</button>
      <button class="btn say" data-rate="0.8" data-text="${escAttr(item.fr||'')}">Langsam</button>
      <button class="btn say" data-rate="0.6" data-text="${escAttr(item.fr||'')}">Sehr langsam</button>
      <button class="btn shadow" data-id="${escAttr(item.id)}" data-text="${escAttr(item.fr||'')}">Shadow ▶</button>
    </div>

    <div class="record-wrap">
      <button class="btn-record rec ready" data-text="${escAttr(item.fr||'')}" data-id="${escAttr(item.id)}">● Aufnehmen</button>
    </div>
  `;
  frag.appendChild(card);
}

/* ======= Scoring / Recording ======== */
function normalize(s){ return String(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9\s']/g,' ').replace(/\s+/g,' ').trim(); }
function levenshtein(a,b){ const m=a.length,n=b.length,dp=Array.from({length:m+1},()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j; for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const c=a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+c); }} return dp[m][n]; }
function wordScore(a,b){ const A=normalize(a), B=normalize(b); if(!A&&!B) return 100; const dist=levenshtein(A,B); const max=Math.max(A.length,B.length)||1; return Math.round((1 - dist/max)*100); }
function scorePronunciation(expected, said){
  const expWords=normalize(expected).split(' ').filter(Boolean);
  const saidWords=normalize(said).split(' ').filter(Boolean);
  const per=[]; let total=0, count=0;
  for(let i=0;i<expWords.length;i++){
    const target=expWords[i];
    let best=0, match=''; for(let d=-1; d<=1; d++){ const idx=i+d; if(idx<0||idx>=saidWords.length) continue; const s=wordScore(target, saidWords[idx]); if(s>best){best=s; match=saidWords[idx];} }
    let cls='bad'; if(best>=85) cls='ok'; else if(best>=60) cls='mid'; if(!match) cls='miss';
    per.push({text: expWords[i] || '?', score: best, class: cls});
    if(cls!=='miss'){ total+=best; count++; }
  }
  const overall = count? Math.max(0,Math.min(100,Math.round(total/count))) : 0;
  return {overall, perWord:per};
}
function startRecognition(btn, afterEnd){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert('Spracherkennung wird nicht unterstützt.'); return; }

  const card=btn.closest('.card');
  const expected=btn.getAttribute('data-text')||'';
  const phraseId=btn.getAttribute('data-id')||'';
  const percentEl=card.querySelector('.percent');
  const chipsEl  =card.querySelector('.chips');
  const meterBar =card.querySelector('.meter>span');
  const heardText=card.querySelector('.heard-text');
  const confEl   =card.querySelector('.conf');

  chipsEl.innerHTML=''; heardText.textContent='—'; confEl.textContent='–';
  percentEl.textContent='0%'; meterBar.style.width='0%';

  btn.classList.remove('ready'); btn.classList.add('recording'); btn.textContent='● Aufnahme läuft…';

  stopActiveRecognition();
  const rec=new SR(); rec.lang='fr-FR'; rec.interimResults=false; rec.continuous=false;
  activeRecognizer = rec;
  try{ rec.start(); }catch{}

  rec.onresult=(e)=>{
    const first=e.results[0][0];
    const said=Array.from(e.results).map(r=>r[0].transcript).join(' ');
    const conf=first && typeof first.confidence==='number' ? Math.round(first.confidence*100) : null;

    const {overall, perWord} = scorePronunciation(expected, said);
    percentEl.textContent=overall+'%'; meterBar.style.width=overall+'%';
    chipsEl.innerHTML=''; perWord.forEach(w=>{ const span=document.createElement('span'); span.className='chip '+w.class; span.textContent=w.text; chipsEl.appendChild(span); });
    heardText.textContent = said || '—';
    confEl.textContent    = conf!=null ? (conf+'%') : '–';

    saveLog({
      id: phraseId,
      pack: (state.items.find(x=>x.id===phraseId)?.pack)||'',
      cat:  (state.items.find(x=>x.id===phraseId)?.categoryKey)||'',
      exp: expected, said, score: overall, conf: conf ?? null,
      tsISO: new Date().toISOString(), day: todayStr()
    });
    refreshStatsOnCard(card, phraseId);
    refreshDailyBox(); computeProblemWords();
    if(phraseId) updateSRFor(phraseId, overall);
  };

  const reset=()=>{
    if(activeRecognizer===rec) activeRecognizer=null;
    btn.classList.remove('recording'); btn.classList.add('ready'); btn.textContent='● Aufnehmen';
    if(afterEnd) afterEnd();
  };
  rec.onerror=reset; rec.onend=reset;
}
function refreshStatsOnCard(card, id){
  const s=getPhraseStats(id);
  card.querySelector('.st-last').textContent = s.last!=null ? ('Letzter: '+s.last+'%') : 'Letzter: —';
  card.querySelector('.st-avg10').textContent= s.avg10!=null ? ('Ø(10): '+s.avg10+'%') : 'Ø(10): —';
  card.querySelector('.st-count').textContent = 'Versuche: ' + s.count;
}

/* ========= Card events / Auto-TTS ========= */
function initCardEvents(){
  $('#results').addEventListener('click', e=>{
    const sayBtn=e.target.closest('.say');
    if(sayBtn){
      clearShadowTimers();
      const text=sayBtn.getAttribute('data-text')||''; const rate=parseFloat(sayBtn.getAttribute('data-rate')||'1')||1;
      if('speechSynthesis' in window) speak(text, rate);
      return;
    }
    const recBtn=e.target.closest('.rec');
    if(recBtn){ clearShadowTimers(); stopActiveRecognition(); startRecognition(recBtn); return; }

    const shadowBtn=e.target.closest('.shadow');
    if(shadowBtn){
      if(shadowBtn.getAttribute('data-running')==='true'){ stopShadowing(shadowBtn, true); }
      else{ runShadowing(shadowBtn); }
      return;
    }

    const chunk=e.target.closest('.s');
    if(chunk){ clearShadowTimers(); speak(chunk.getAttribute('data-chunk')||'', 0.7); return; }

    const card=e.target.closest('.card');
    if(!card) return;
    if(!state.tts.enabled || !('speechSynthesis' in window)) return;
    const main=card.querySelector('.txt-main'); const t=main?main.textContent.trim():'';
    clearShadowTimers(); speak(t,1.0);
  });

  $('#show-today').addEventListener('click',()=>setShow('today'));
  $('#show-all').addEventListener('click', ()=>setShow('all'));
  $('#show-packs').addEventListener('click',()=>setShow('packs'));
  $('#category').addEventListener('change', e=>{state.category=e.target.value; render();});
  $('#tts-toggle').addEventListener('click', ()=>{state.tts.enabled=!state.tts.enabled; updateTtsToggle();});
  $('#q').addEventListener('input', e=>{state.q = e.target.value.trim().toLowerCase(); render();});

  $('#export-log').addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(state.logs,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='famlang-log.json'; a.click(); URL.revokeObjectURL(url);
  });
  $('#reset-log').addEventListener('click', ()=>{
    if(!confirm('Log wirklich löschen?')) return;
    state.logs=[]; writeLogs(); refreshDailyBox(); render(); computeProblemWords();
  });

  $('#start-sr').addEventListener('click', startSRSession);
  $('#toggle-shadow').addEventListener('click', ()=>{
    state.shadow = !state.shadow;
    const b=$('#toggle-shadow'); b.setAttribute('aria-pressed', state.shadow); b.textContent = state.shadow ? 'Shadowing: An' : 'Shadowing: Aus';
    if(!state.shadow) shadowStopAll(true);
  });

  // Floating controls – STOP now also scrolls to top
  $('#fb-stop').addEventListener('click', ()=>{
    shadowStopAll(true); // stops + scrolls to top
    state.shadow=false;
    $('#toggle-shadow').setAttribute('aria-pressed','false');
    $('#toggle-shadow').textContent='Shadowing: Aus';
  });
  $('#fb-next').addEventListener('click', ()=>{
    nextAndAutorun();
  });

  // Controls collapse toggle (persisted)
  $('#controls-toggle').addEventListener('click', ()=>{
    const box = $('#controls');
    box.classList.toggle('collapsed');
    state.prefs.collapsedControls = box.classList.contains('collapsed');
    writePrefs();
    if(state.prefs.collapsedControls){ // when collapsing, jump to first card immediately
      smoothTop();
    }
  });
}

/* ====== Advance helpers (robust) ====== */
function removeFromQueue(id){
  if(!id) return;
  const idx = state.srQueue.indexOf(id);
  if(idx>-1) state.srQueue.splice(idx,1);
}
function nextAndAutorun(){
  state.shadow = true;
  $('#toggle-shadow').setAttribute('aria-pressed','true');
  $('#toggle-shadow').textContent='Shadowing: An';

  clearShadowTimers(); stopActiveRecognition();

  if(state.shadowCurrent && state.shadowCurrent.id){
    removeFromQueue(state.shadowCurrent.id);
  }
  if(!state.srQueue.length) rebuildSRQueue();
  if(!state.srQueue.length){
    alert('Keine weiteren Karten fällig. 👍');
    $('#floatbar').hidden=true;
    state.shadowRunning=false;
    state.shadowCurrent=null;
    smoothTop();
    return;
  }
  const nextId = state.srQueue[0];
  openCard(nextId);
  const card=document.getElementById('card-'+nextId.replace(/[^\w-]/g,'_'));
  const btn=card?.querySelector('.shadow');
  if(btn){
    btn.removeAttribute('data-running'); btn.classList.remove('recording'); btn.textContent='Shadow ▶';
    setTimeout(()=>runShadowing(btn), 200);
  }
}

/* ========= Interruptible Shadowing ========= */
function runShadowing(btn){
  clearShadowTimers(); stopActiveRecognition();
  const id = btn.getAttribute('data-id');
  const text = btn.getAttribute('data-text') || '';
  if(!text) return;

  btn.setAttribute('data-running','true'); btn.textContent='◼ Stop'; btn.classList.add('recording');
  state.shadowRunning = true; state.shadowCurrent = {id, text};
  $('#floatbar').hidden=false; $('#fb-status').textContent='Shadow aktiv';

  const finishBtn = ()=>{ btn.removeAttribute('data-running'); btn.textContent='Shadow ▶'; btn.classList.remove('recording'); state.shadowRunning=false; state.shadowCurrent=null; $('#floatbar').hidden=true; };

  const speakFast = ()=> speak(text, 1.0);
  const speakSlow = ()=> speak(text, 0.8);
  const startRec  = ()=> {
    const card = btn.closest('.card'); const recBtn = card.querySelector('.rec');
    startRecognition(recBtn, ()=>{
      shadowTimers.push(setTimeout(()=>{
        removeFromQueue(id);
        if(state.shadow && state.srQueue.length){
          goToNextDue(true /* autorun */);
        } else {
          finishBtn();
          smoothTop(); // after manual stop of flow, return to top for clarity
        }
      }, SHOW_RESULT_MS));
    });
  };

  speakFast();
  shadowTimers.push(setTimeout(()=>{ if(btn.getAttribute('data-running')==='true') speakSlow(); }, SHADOW_GAP_AFTER_FAST + text.length*LEN_MULT_FAST));
  shadowTimers.push(setTimeout(()=>{ if(btn.getAttribute('data-running')==='true') startRec(); }, SHADOW_GAP_AFTER_SLOW + text.length*LEN_MULT_SLOW));
}
function stopShadowing(btn, scrollTop=false){
  clearShadowTimers(); stopActiveRecognition();
  if(btn){ btn.removeAttribute('data-running'); btn.textContent='Shadow ▶'; btn.classList.remove('recording'); }
  state.shadowRunning=false; state.shadowCurrent=null; $('#floatbar').hidden=true;
  if(scrollTop) smoothTop();
}

/* ============ SR session flow ============ */
function startSRSession(){
  if(!state.srQueue.length){ alert('Keine fälligen Karten. Super!'); return; }
  state.shadow = true; $('#toggle-shadow').setAttribute('aria-pressed','true'); $('#toggle-shadow').textContent='Shadowing: An';
  openCard(state.srQueue[0]);
  const card=document.getElementById('card-'+state.srQueue[0].replace(/[^\w-]/g,'_'));
  const btn=card?.querySelector('.shadow'); if(btn) runShadowing(btn);
}
function goToNextDue(autorun=false){
  if(!state.srQueue.length){
    alert('SR-Session fertig! 🎉'); $('#floatbar').hidden=true; smoothTop(); return;
  }
  const id = state.srQueue[0];
  openCard(id);
  if(autorun){
    const card=document.getElementById('card-'+id.replace(/[^\w-]/g,'_'));
    const btn=card?.querySelector('.shadow');
    if(btn) setTimeout(()=>runShadowing(btn), 300);
  } else {
    $('#floatbar').hidden = !state.shadowRunning && !state.shadow;
  }
}
function openCard(id){
  const el = document.getElementById('card-'+id.replace(/[^\w-]/g,'_'));
  if(!el) return;
  el.scrollIntoView({behavior:'smooth', block:'center'});
  el.animate([{outline:'2px solid transparent'},{outline:`2px solid ${getComputedStyle(document.body).getPropertyValue('--accent')}`},{outline:'2px solid transparent'}],{duration:1200});
}

/* ============ Page init ============ */
function setShow(mode){
  state.show = mode;
  $('#show-today').setAttribute('aria-pressed', mode==='today');
  $('#show-all').setAttribute('aria-pressed', mode==='all');
  $('#show-packs').setAttribute('aria-pressed', mode==='packs');
  render();
}
function applyPrefs(){
  const box=$('#controls');
  if(state.prefs.collapsedControls) box.classList.add('collapsed'); else box.classList.remove('collapsed');
}
function init(){
  loadPrefs();
  loadLogs(); loadSR();
  initTTS(); initMic(); initCardEvents(); updateTtsToggle(); applyPrefs(); loadAll();
}
init();

/* ======= Error util (guard) ======= */
function showError(err){ $('#empty').hidden=false; $('#empty').textContent='Fehler beim Laden: '+(err?.message||err); console.error(err); }

})();
</script>
</body>
</html>
