<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FamLang – informell, familiär (FR ⇄ DE)</title>
  <style>
    :root{
      --bg:#0f1115;--fg:#e8ebf0;--muted:#9aa3b2;--card:#151822;--accent:#5aa9ff;--chip:#232738;--ring:#2b3246;--ok:#45d483;
      --good:#2fbf71;--okay:#e0b14b;--bad:#e26666;--chipText:#e8ebf0;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    header h1{margin:0 0 6px;font-weight:800;letter-spacing:.3px}
    header p{margin:4px 0 0;color:var(--muted)}
    .bar{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin:18px 0}
    .search{display:flex;gap:8px;align-items:center;background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:10px 12px}
    .search input{flex:1;background:transparent;border:0;outline:none;color:var(--fg);font-size:17px;min-height:40px}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    select,button{border-radius:14px;border:1px solid var(--ring);background:var(--chip);color:var(--fg)}
    .pill{padding:10px 14px;min-height:40px;cursor:pointer}
    button[aria-pressed="true"]{outline:2px solid var(--accent)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin:16px 0 36px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.25)}
    .cat{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--ring);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted);white-space:nowrap}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .txt-main{font-size:20px;margin:6px 0 2px;font-weight:800}
    .txt-sub{font-size:16px;margin:2px 0;color:#d7dbef}
    .txt-de{font-size:13px;margin:8px 0 0;color:var(--muted)}
    .empty{margin:24px 0;color:var(--muted);text-align:center}
    .pack-title{grid-column:1 / -1;margin:6px 0 2px;color:var(--muted);font-weight:600}
    #load-warn{margin:12px 0;padding:10px;border:1px solid #8b5;border-radius:10px;background:#1b2620;color:#cde;font-size:13px}

    /* Buttons — shared */
    .btn{background:var(--chip);color:var(--fg);border:1px solid var(--ring);
         border-radius:12px;padding:12px 16px;font-size:15px;line-height:1;
         display:inline-flex;align-items:center;justify-content:center;gap:8px;
         transition:transform .06s ease, background .15s ease, border-color .15s ease;
         min-height:44px}
    .btn:hover{background:#2a3045}
    .btn:active{transform:scale(.98)}
    .btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .btn.full{width:100%}

    /* Play buttons as a segmented group */
    .play-group{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:100%}
    .play{border-radius:12px;background:#22304b;border-color:#2e3d5b}
    .play:hover{background:#2a3654}

    /* Highlight Aufnahme */
    .btn-record{background:linear-gradient(135deg,#3bd18a,#2dbb99);color:#081217;border:0;font-weight:800;letter-spacing:.2px}
    .btn-record:hover{filter:brightness(1.05)}
    .btn-record:active{transform:scale(.985)}
    .btn-record .dot{width:8px;height:8px;border-radius:50%;background:#0a2a23;display:inline-block}

    /* Actions layout */
    .actions{display:grid;grid-template-columns:1fr;gap:10px;margin-top:14px}
    @media(min-width:560px){ .actions{grid-template-columns:1fr auto} }

    /* Scoring chips */
    .score-wrap{margin-top:8px}
    .score-line{display:flex;align-items:center;gap:12px;margin-bottom:6px}
    .legend{display:flex;gap:12px;font-size:13px;color:var(--muted)}
    .legend .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px}
    .dot.good{background:var(--good)} .dot.okay{background:var(--okay)} .dot.bad{background:var(--bad)}
    .chip{display:inline-flex;align-items:center;justify-content:center;padding:6px 12px;border-radius:22px;border:1px solid var(--ring);background:#1c2233;margin:4px 6px 0 0;font-weight:600;color:var(--chipText)}
    .chip.good{background:#163024;border-color:#255a3b} .chip.okay{background:#2c2620;border-color:#6f5a34}
    .chip.bad{background:#2b1e1e;border-color:#6e3030}
    .chip.unk{background:#242839;border-color:#3d4562}
    .meter{height:8px;border-radius:5px;background:#2a3045;overflow:hidden}
    .meter > span{display:block;height:100%;background:linear-gradient(90deg,#e26666,#e0b14b,#2fbf71)}
    .heard{margin-top:10px;border:1px dashed var(--ring);border-radius:10px;padding:10px}
    .heard h5{margin:0 0 4px 0;font-size:14px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>FamLang – informell, familiär <small style="font-weight:500;color:var(--muted)">(FR ⇄ DE)</small></h1>
      <p>Französisch als Hauptsprache, deutsche Übersetzung als Hilfe. Alles läuft als Einzeldatei und ist GitHub-Pages-sicher.</p>
    </header>

    <div class="bar">
      <div class="search" role="search">
        <input id="q" type="search" placeholder="Suche (FR/DE)…" autocomplete="off" />
        <button id="mic" class="pill">Mikrofon</button>
      </div>
      <div style="display:flex;gap:8px">
        <button id="show-today" class="pill" aria-pressed="false">Heute</button>
        <button id="show-all" class="pill" aria-pressed="true">Alle</button>
        <button id="show-packs" class="pill" aria-pressed="false">Packs</button>
      </div>
    </div>

    <div id="load-warn" hidden></div>

    <div class="filters">
      <select id="category"><option value="">Alle Kategorien</option></select>
      <button id="tts-toggle" class="pill" aria-pressed="false" title="Vorlesen beim Antippen aktivieren/deaktivieren">Auto-TTS: Aus</button>
    </div>

    <div id="results" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty" hidden>Keine Einträge gefunden.</div>
  </div>

<script>
(() => {
  // ---------- helpers
  const $  = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const BASE = new URL('./', window.location.href);
  const urlFor  = (p) => new URL(p, BASE).toString();
  const fetchJson = async (p) => { const res = await fetch(urlFor(p), { cache:'no-store' }); if(!res.ok) throw new Error(`Fetch failed ${p}: ${res.status}`); return res.json(); };
  const escapeHtml = (s) => String(s).replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
  const escapeAttr = (s) => escapeHtml(s).replace(/`/g,'&#96;');

  // ---------- state
  const state = {
    q:'',
    show:'all',     // all | today | packs
    category:'',
    items:[],       // { fr, de, hint, pack, categoryKey, categoryLabel, ... }
    categories:new Set(),
    todaySet:new Set(),
    tts:{ enabled:false, voices:[], ready:false, pref:'google' } // prefer Google
  };
  let manifestOrder = [];

  // ---------- controls
  $('#q').addEventListener('input', e=>{ state.q = e.target.value.trim().toLowerCase(); render(); });
  $('#category').addEventListener('change', e=>{ state.category = e.target.value; render(); });
  $('#show-today').addEventListener('click', ()=> setShow('today'));
  $('#show-all').addEventListener('click',  ()=> setShow('all'));
  $('#show-packs').addEventListener('click',()=> setShow('packs'));
  $('#tts-toggle').addEventListener('click', ()=>{ state.tts.enabled = !state.tts.enabled; updateTtsToggle(); });

  function setShow(mode){
    state.show = mode;
    $('#show-today').setAttribute('aria-pressed', mode==='today');
    $('#show-all').setAttribute('aria-pressed', mode==='all');
    $('#show-packs').setAttribute('aria-pressed', mode==='packs');
    render();
  }

  // ---------- load (fault tolerant) + categories (labels/order)
  async function loadAll(){
    try{
      const manifest = await fetchJson('data/manifest.json');
      const packs = Array.isArray(manifest.packs) ? manifest.packs : [];
      state.todaySet = new Set(Array.isArray(manifest.todayPacks) ? manifest.todayPacks : []);
      const names  = manifest.categoryNames || {};
      const labels = manifest.categoryLabels || {};
      manifestOrder = Array.isArray(manifest.categoryOrder) ? manifest.categoryOrder : [];

      const settled = await Promise.allSettled(
        packs.map(async p => ({ path:p, raw: await fetchJson(p) }))
      );

      state.items=[]; state.categories=new Set();
      const failed=[];

      for(const r of settled){
        if(r.status!=='fulfilled'){
          failed.push((r.reason && String(r.reason).replace(/^Error:\s*/,'')) || 'unbekannt');
          continue;
        }
        const { path, raw } = r.value;
        const rows = Array.isArray(raw) ? raw : (Array.isArray(raw?.phrases) ? raw.phrases : []);
        const key  = names[path] || (raw && raw.name) || guessCategory(path);
        const label= labels[key] || key;

        state.categories.add(key);

        if(Array.isArray(rows)){
          rows.forEach((row, idx)=>{
            state.items.push({
              id:`${path}#${idx}`,
              categoryKey:key,
              categoryLabel:label,
              fr:String(row.fr ?? ''),
              de:String(row.de ?? row.en ?? ''),
              hint:String(row.hint ?? ''),
              pack:path,
              date:String(row.date || '')
            });
          });
        }
      }

      buildCategorySelect();
      render();
      showLoadReport(failed);
    }catch(err){
      showError(err);
    }
  }

  function guessCategory(path){ const file = path.split('/').pop(); return (file||'').replace(/_/g,' ').replace(/\..+$/,''); }

  function buildCategorySelect(){
    const sel = $('#category');
    const current = sel.value;

    const keys = Array.from(state.categories);
    const ordered = [
      ...manifestOrder.filter(k => keys.includes(k)),
      ...keys.filter(k => !manifestOrder.includes(k)).sort()
    ];

    sel.innerHTML =
      '<option value="">Alle Kategorien</option>' +
      ordered.map(k => {
        const any = state.items.find(x => x.categoryKey === k);
        const label = any ? any.categoryLabel : k;
        return `<option value="${escapeHtml(k)}">${escapeHtml(label)}</option>`;
      }).join('');

    sel.value = current || '';
  }

  function showLoadReport(failed){
    const el = $('#load-warn');
    if(!failed || !failed.length){ el.hidden = true; el.textContent=''; return; }
    el.hidden = false;
    el.innerHTML = '⚠️ Einige Dateien konnten nicht geladen werden: ' +
      failed.map(s => `<code>${escapeHtml(s)}</code>`).join(', ') +
      '. Prüfe <code>data/manifest.json</code> (Pfade ohne führenden Slash, gültiges JSON).';
  }

  // ---------- render
  function render(){
    const list = $('#results');
    const empty = $('#empty');
    list.innerHTML='';

    let view = state.items.slice();
    if(state.category) view = view.filter(x=>x.categoryKey===state.category);

    if(state.q){
      const q = state.q;
      view = view.filter(x => {
        const inText = (x.fr + ' ' + x.de).toLowerCase().includes(q);
        const inCat  = (x.categoryLabel || x.categoryKey || '').toLowerCase().includes(q);
        return inText || inCat;
      });
    }

    if(state.show==='today'){
      const todayISO = new Date().toISOString().slice(0,10);
      view = view.filter(x => state.todaySet.size>0 ? state.todaySet.has(x.pack) : (x.date && x.date.startsWith(todayISO)) );
    }

    if(!view.length){ empty.hidden=false; return; } else { empty.hidden=true; }

    const frag = document.createDocumentFragment();

    if(state.show==='packs'){
      view.sort((a,b)=> a.pack.localeCompare(b.pack) || a.id.localeCompare(b.id));
      let currentPack='';
      for(const item of view){
        if(item.pack!==currentPack){
          currentPack=item.pack;
          const h=document.createElement('h3');
          h.className='pack-title';
          h.textContent=item.pack.split('/').pop();
          frag.appendChild(h);
        }
        renderCard(frag,item);
      }
    } else {
      for(const item of view) renderCard(frag,item);
    }

    list.appendChild(frag);
  }

  function renderCard(frag,item){
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <span class="cat" title="Kategorie">${escapeHtml(item.categoryLabel)}</span>
        <span class="cat" title="Paket">${escapeHtml(item.pack.split('/').pop())}</span>
      </div>

      <div class="txt-main">${escapeHtml(item.fr || '')}</div>
      <div class="txt-sub">DE: ${escapeHtml(item.de || '')}</div>
      <div class="txt-de">${item.hint ? 'Hinweis: ' + escapeHtml(item.hint) : ''}</div>

      <div class="score-wrap" hidden>
        <div class="score-line">
          <div style="font-size:22px;font-weight:800" class="percent">0%</div>
          <div class="legend">
            <span><i class="dot good"></i> gut</span>
            <span><i class="dot okay"></i> okay</span>
            <span><i class="dot bad"></i> verbessern</span>
          </div>
        </div>
        <div class="chips"></div>
        <div class="heard">
          <h5>Verstanden:</h5>
          <div class="heard-text">–</div>
          <div class="txt-de" style="margin-top:4px">Konfidenz: <span class="conf">–</span></div>
        </div>
        <div class="meter" style="margin-top:8px"><span style="width:0%"></span></div>
      </div>

      <div class="actions">
        <div class="play-group">
          <button class="btn play say"    data-mode="normal" data-lang="fr-FR" data-text="${escapeAttr(item.fr || '')}">Abspielen</button>
          <button class="btn play say"    data-mode="slow"   data-lang="fr-FR" data-text="${escapeAttr(item.fr || '')}">Langsam</button>
          <button class="btn play say"    data-mode="xslow"  data-lang="fr-FR" data-text="${escapeAttr(item.fr || '')}">Sehr langsam</button>
        </div>
        <button class="btn btn-record rec" data-lang="fr-FR" data-text="${escapeAttr(item.fr || '')}">
          <span class="dot" aria-hidden="true"></span> Aufnehmen
        </button>
      </div>
    `;
    frag.appendChild(card);
  }

  function showError(err){ $('#empty').hidden=false; $('#empty').textContent='Fehler beim Laden: ' + (err?.message || err); console.error(err); }

  // ---------- TTS (prefer Google voices)
  function pickVoiceFor(lang, prefer='google'){
    const want=(lang||'').slice(0,2).toLowerCase();
    const vs=state.tts.voices||[];
    const isGoogle = v=>/google/i.test(v.name||'');
    const isSamsung= v=>/samsung/i.test(v.name||'');
    const starts   = v=>(v.lang||'').toLowerCase().startsWith(want);
    const includes = v=>(v.lang||'').toLowerCase().includes(want);

    const order = {
      google:  [ v=>isGoogle(v)&&starts(v), v=>isGoogle(v)&&includes(v), v=>!isSamsung(v)&&starts(v), v=>!isSamsung(v)&&includes(v), v=>isSamsung(v)&&starts(v), v=>isSamsung(v)&&includes(v) ],
      samsung: [ v=>isSamsung(v)&&starts(v),v=>isSamsung(v)&&includes(v),v=>isGoogle(v)&&starts(v),v=>isGoogle(v)&&includes(v),v=>starts(v),v=>includes(v) ],
      any:     [ v=>isGoogle(v)&&starts(v), v=>starts(v), v=>includes(v) ]
    }[prefer||'google'];

    for(const test of order){ const found = vs.find(test); if(found) return found; }
    return null;
  }

  function speak(text, lang, mode){
    if(!text || !text.trim()) return;
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const v = pickVoiceFor(lang, state.tts.pref || 'google');
      if(v){ u.voice = v; u.lang = v.lang || lang; } else u.lang = lang;

      // speeds: normal=1.0, slow=0.85, xslow=0.60
      u.rate = (mode==='xslow') ? 0.60 : (mode==='slow' ? 0.85 : 1.0);
      u.pitch = 1.0;

      // slight delay helps on Android
      setTimeout(()=>window.speechSynthesis.speak(u), 80);
    }catch(e){ console.error(e); }
  }

  // ---------- Pronunciation (record → score)
  function normalize(s){
    return String(s).toLowerCase().normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')      // strip accents
      .replace(/[^a-z\d\s']/g,' ')         // keep letters/digits/apostrophes
      .replace(/\s+/g,' ')
      .trim();
  }
  function tokenize(s){
    const t = normalize(s).split(' ').filter(Boolean);
    return t.length ? t : [];
  }
  function levenshtein(a,b){
    const m=a.length, n=b.length;
    const dp=Array.from({length:m+1},()=>new Array(n+1).fill(0));
    for(let i=0;i<=m;i++) dp[i][0]=i;
    for(let j=0;j<=n;j++) dp[0][j]=j;
    for(let i=1;i<=m;i++){
      for(let j=1;j<=n;j++){
        const cost=a[i-1]===b[j-1]?0:1;
        dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
      }
    }
    return dp[m][n];
  }
  function similarity(a,b){
    if(!a&&!b) return 1;
    const dist = levenshtein(a,b);
    const maxLen = Math.max(a.length,b.length)||1;
    return 1 - dist/maxLen; // 0..1
  }
  function classifyWordScore(s){ // thresholds for chip color
    if(s>=0.82) return 'good';
    if(s>=0.60) return 'okay';
    return 'bad';
  }

  function scorePronunciation(expected, heard){
    const expToks = tokenize(expected);
    const heardToks = tokenize(heard);
    const perWord = [];

    let sum=0, count=0;
    for(const w of expToks){
      // best similarity against any heard token
      let best=0;
      for(const h of heardToks){ best = Math.max(best, similarity(w,h)); }
      perWord.push({word:w, s:best});
      sum += best; count++;
    }
    const overall = count ? (sum/count) : 0;
    return { overall, perWord };
  }

  // ---------- UI wiring
  function initUI(){
    const hasTTS = 'speechSynthesis' in window;

    $('#results').addEventListener('click', (e)=>{
      const sayBtn = e.target.closest('.say');
      if(sayBtn && hasTTS){
        const text = sayBtn.getAttribute('data-text') || '';
        const langCode = sayBtn.getAttribute('data-lang') || 'fr-FR';
        const mode = sayBtn.getAttribute('data-mode') || 'normal';
        speak(text, langCode, mode);
        return;
      }
      const recBtn = e.target.closest('.rec');
      if(recBtn){ startRecognition(recBtn); return; }

      const card = e.target.closest('.card');
      if(!card || !state.tts.enabled || !hasTTS) return;
      const main = card.querySelector('.txt-main');
      const text = main ? main.textContent.trim() : '';
      speak(text, 'fr-FR', 'normal');
    });

    // Mic → search (browser SR)
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const micBtn = $('#mic');
    if(!SR){ if(micBtn){ micBtn.disabled=true; micBtn.title='Spracherkennung nicht verfügbar'; } }
    else{
      let micActive=false;
      const rec = new SR();
      rec.interimResults=false; rec.continuous=false;
      micBtn.addEventListener('click', ()=>{
        if(micActive){ rec.stop(); return; }
        rec.lang = 'fr-FR';
        micActive=true; micBtn.textContent='Stoppen';
        try{ rec.start(); }catch{}
      });
      rec.onresult = (e)=>{
        const t = Array.from(e.results).map(r=>r[0].transcript).join(' ');
        $('#q').value = t; state.q = t.toLowerCase(); render();
      };
      rec.onerror = ()=>{ micActive=false; micBtn.textContent='Mikrofon'; };
      rec.onend   = ()=>{ micActive=false; micBtn.textContent='Mikrofon'; };
    }
  }

  function startRecognition(btn){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ alert('Spracherkennung wird nicht unterstützt.'); return; }

    const card   = btn.closest('.card');
    const expected = btn.getAttribute('data-text') || '';
    const scoreBox = card.querySelector('.score-wrap');
    const percentEl= card.querySelector('.percent');
    const chipsEl  = card.querySelector('.chips');
    const meterBar = card.querySelector('.meter > span');
    const heardBox = card.querySelector('.heard');
    const heardText= card.querySelector('.heard-text');
    const confEl   = card.querySelector('.conf');

    chipsEl.innerHTML=''; heardText.textContent='–'; confEl.textContent='–';
    percentEl.textContent='0%'; meterBar.style.width='0%';
    scoreBox.hidden = false;

    const rec = new SR();
    rec.lang = 'fr-FR'; rec.interimResults=false; rec.continuous=false;

    try{ rec.start(); }catch{}

    rec.onresult = (e)=>{
      const first = e.results[0][0];
      const said = Array.from(e.results).map(r=>r[0].transcript).join(' ');
      const conf = first && typeof first.confidence==='number' ? Math.round(first.confidence*100) : null;
      const { overall, perWord } = scorePronunciation(expected, said);

      // chips
      chipsEl.innerHTML = '';
      perWord.forEach(w=>{
        const cls = classifyWordScore(w.s);
        const chip = document.createElement('span');
        chip.className = `chip ${cls}`;
        chip.textContent = w.word || '?';
        chipsEl.appendChild(chip);
      });

      // numbers
      const pct = Math.round(overall*100);
      percentEl.textContent = pct + '%';
      meterBar.style.width   = pct + '%';

      // heard
      heardText.textContent = said || '—';
      confEl.textContent    = conf != null ? (conf + '%') : '–';
    };

    rec.onerror = ()=>{ /* keep last shown */ };
  }

  function updateTtsToggle(){
    const b=$('#tts-toggle');
    b.setAttribute('aria-pressed', state.tts.enabled);
    b.textContent = state.tts.enabled ? 'Auto-TTS: An' : 'Auto-TTS: Aus';
  }

  function initTTS(){
    if('speechSynthesis' in window){
      const loadVoices = () => { state.tts.voices = window.speechSynthesis.getVoices(); state.tts.ready = true; };
      loadVoices();
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }
  }

  // ---------- boot
  initTTS();
  initUI();
  updateTtsToggle();
  loadAll();
})();
</script>
</body>
</html>
