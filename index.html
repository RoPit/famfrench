<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FamLang – informell, familiär (FR ⇄ DE)</title>
<style>
:root{
  --bg:#0f1115;--panel:#131723;--card:#171b28;--ink:#eef2f8;--mut:#a6afc2;--ring:#2a3150;
  --chip:#20263a;--btn:#263255;--ok:#34d399;--warn:#fbbf24;--bad:#ef4444;--acc:#4ea3ff;
}
*{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
.wrap{max-width:960px;margin:18px auto;padding:0 14px}
h1{margin:6px 0 2px;font-size:32px;line-height:1.15}
.lead{color:var(--mut);margin:0 0 14px}
.panel{background:var(--panel);border:1px solid var(--ring);border-radius:16px;padding:14px;margin:14px 0}
.grid{display:grid;gap:10px}
@media(min-width:720px){.grid-2{grid-template-columns:1fr 1fr}}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pill,select,input[type=search]{background:var(--chip);color:var(--ink);border:1px solid var(--ring);border-radius:14px;padding:10px 14px;min-height:44px}
.pill{cursor:pointer;user-select:none}
.pill.primary{background:#2b3965}
.pill.good{background:#1f6b4e}
.pill.danger{background:#6a2f2f}
.badge{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--ring);font-size:12px;color:var(--mut)}
select{min-width:170px}
.card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:14px}
.card h3{margin:0 0 4px;font-size:20px}
.card p{margin:2px 0;color:#dbe3ff}
.actions{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
.actions .pill{justify-content:center}
.record{margin-top:8px}
.scorebar{height:8px;border-radius:8px;background:#26314f;position:relative;overflow:hidden}
.scorebar>i{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,#ef4444,#f59e0b,#10b981)}
.chips{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
.chips .chip{padding:6px 10px;border-radius:999px;background:#2a3150;border:1px solid #38406a}
.chip.g{background:#1e4637} .chip.y{background:#4c4724} .chip.r{background:#4b2a2a}
.small{font-size:12px;color:var(--mut)}
/* floating controls */
.floating{position:sticky;bottom:0;left:0;right:0;background:rgba(12,14,20,.96);border-top:1px solid var(--ring);backdrop-filter:blur(6px);padding:10px 14px;z-index:5}
.floating .row{justify-content:space-between}
.floating .pill{min-width:120px;justify-content:center}
.pin{position:fixed;right:12px;bottom:88px;display:flex;gap:8px}
.pin .pill{box-shadow:0 8px 18px rgba(0,0,0,.35)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:120px;background:#1f2937;border:1px solid #374151;color:#e5e7eb;padding:10px 14px;border-radius:10px;z-index:20;opacity:0;transition:opacity .2s}
.toast.show{opacity:1}
hr.sep{border:0;height:1px;background:#242a40;margin:12px 0}
.label{font-size:13px;color:var(--mut)}
/* compact news list */
.newsitem{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:10px;margin:8px 0}
.newsitem .ttl{font-weight:700}
.newsitem .soft{font-size:12px;color:var(--mut)}
/* compact header controls */
.headgrid{display:grid;gap:10px}
@media(min-width:680px){.headgrid{grid-template-columns:1fr auto}}
/* toggle look */
.toggle{background:var(--chip);border:1px solid var(--ring);border-radius:12px;padding:10px 14px;display:flex;align-items:center;gap:8px}
.toggle b{padding:6px 10px;border-radius:10px;background:#2e3a59}
.toggle[aria-pressed="true"] b{background:#1f6b4e}
</style>
</head>
<body>
<div class="wrap">
  <h1>FamLang – informell, familiär <small style="font-weight:500;color:var(--mut)">(FR ⇄ DE)</small></h1>
  <p class="lead">Französisch als Hauptsprache, deutsche Übersetzung als Hilfe. Alles läuft lokal im Browser.</p>

  <!-- Controls -->
  <div class="panel">
    <div class="headgrid">
      <div class="row" style="gap:10px">
        <input id="q" type="search" placeholder="Suche (FR/DE)…" class="pill" style="flex:1;min-width:220px"/>
        <button id="mic" class="pill">Mikrofon</button>
      </div>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <select id="category">
          <option value="">Alle Kategorien</option>
        </select>
        <div class="toggle" id="filter-today" role="button" aria-pressed="false" title="Nur Heute">
          <span>Heute</span><b>Aus</b>
        </div>
        <div class="toggle" id="filter-packs" role="button" aria-pressed="false" title="Pack-Übersicht">
          <span>Packs</span><b>Aus</b>
        </div>
        <div class="toggle" id="tts-auto" role="button" aria-pressed="false" title="Antippen liest vor">
          <span>Auto-TTS</span><b>Aus</b>
        </div>
      </div>
    </div>

    <!-- Daily/weekly log -->
    <hr class="sep">
    <div class="grid grid-2">
      <div class="row"><span class="badge">Heute: <b id="stat-today">0 Versuche</b></span><span class="badge">Ø <b id="stat-avg">—%</b> (letzte 10)</span></div>
      <div class="row"><span class="badge">Tages-Streak: <b id="stat-streak">0🔥</b></span><span class="badge">Wochen-Streak: <b id="stat-wstreak">0🔥</b></span></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="log-export" class="pill">Log exportieren</button>
      <button id="log-reset" class="pill">Log zurücksetzen</button>
    </div>
  </div>

  <!-- News / Audio -->
  <div class="panel" id="news-panel">
    <h3 style="margin:0 0 8px">News / Audio auf Französisch</h3>
    <div class="row">
      <input id="news-url" class="pill" style="flex:1" placeholder="MP3/Stream URL (Podcast, Bulletin, FR-Radio …)"/>
      <button id="news-play" class="pill primary">► Play</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="news-stop" class="pill danger">■ Stop</button>
      <button id="news-save" class="pill good">★ Speichern</button>
      <span class="label">Geschwindigkeit</span>
      <button class="pill rate" data-r="0.85">0.85×</button>
      <button class="pill rate active" data-r="1">1.0×</button>
      <button class="pill rate" data-r="1.15">1.15×</button>
      <button class="pill rate" data-r="1.30">1.30×</button>
      <button id="news-back20" class="pill">Letzte 20 s</button>
    </div>
    <audio id="news-audio" preload="none"></audio>
    <div id="news-list" style="margin-top:10px"></div>
  </div>

  <!-- Results -->
  <div id="results" class="grid"></div>
  <div id="empty" class="small" hidden>Keine Einträge gefunden.</div>

  <!-- Floating controls -->
  <div class="floating">
    <div class="row">
      <div class="row" style="gap:8px">
        <button id="ctrl-stop" class="pill danger">■ Stop</button>
        <button id="ctrl-next" class="pill primary">► Nächste</button>
      </div>
      <div class="row" style="gap:10px">
        <span id="shadow-state" class="badge">Shadow inaktiv</span>
        <div id="auto-adv" class="toggle" role="button" aria-pressed="true"><span>Auto-Advance:</span><b>An</b></div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ---------------------- tiny helpers ---------------------- */
const $= (s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const S={primary:'fr',tts:{voices:[],pref:'google',enabled:false},show:'all',category:'',q:'',items:[],todaySet:new Set(),log:{},news:{rate:1},auto:true,shadow:false,idx:0};

/* toast */
let toastTimer=null; function toast(msg,ms=1400){const t=$("#toast"); t.textContent=msg; t.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'),ms);}

/* -------------- data load -------------- */
const BASE=new URL('./',location.href);
const urlFor=p=>new URL(p,BASE).toString();
async function fetchJson(p){const r=await fetch(urlFor(p),{cache:'no-store'}); if(!r.ok) throw new Error(`Fetch ${p}: ${r.status}`); return r.json();}

async function loadAll(){
  try{
    const manifest=await fetchJson('data/manifest.json');
    const packs=manifest.packs||[]; S.todaySet=new Set(manifest.todayPacks||[]);
    const names=manifest.categoryNames||{}, labels=manifest.categoryLabels||{}, order=manifest.categoryOrder||[];
    const settled=await Promise.allSettled(packs.map(async p=>({path:p, raw:await fetchJson(p)})));
    S.items=[]; const keys=new Set();
    for(const r of settled){
      if(r.status!=='fulfilled') continue;
      const {path,raw}=r.value; const rows=Array.isArray(raw)?raw:(Array.isArray(raw?.phrases)?raw.phrases:[]);
      const key=names[path]||(raw&&raw.name)||guessCategory(path); const label=labels[key]||key; keys.add(key);
      rows.forEach((row,i)=>S.items.push({id:`${path}#${i}`,categoryKey:key,categoryLabel:label,fr:String(row.fr||''),de:String(row.de||row.en||''),hint:String(row.hint||''),pack:path,date:String(row.date||'')}));
    }
    buildCategorySelect([...keys], order);
    render();
  }catch(e){ $("#empty").hidden=false; $("#empty").textContent='Fehler beim Laden: '+(e.message||e); }
}
function guessCategory(p){const f=p.split('/').pop()||''; return f.replace(/_/g,' ').replace(/\..+$/,'')}
function buildCategorySelect(keys,order){
  const sel=$("#category"); const ordered=[...order.filter(k=>keys.includes(k)), ...keys.filter(k=>!order.includes(k)).sort()];
  sel.innerHTML='<option value="">Alle Kategorien</option>'+ordered.map(k=>{
    const any=S.items.find(x=>x.categoryKey===k); const lab=any?any.categoryLabel:k; return `<option value="${k}">${lab}</option>`;
  }).join('');
}

/* -------------- render -------------- */
function render(){
  const list=$("#results"); list.innerHTML=''; let view=S.items.slice();
  if(S.category) view=view.filter(x=>x.categoryKey===S.category);
  if(S.q){const q=S.q; view=view.filter(x=> (x.fr+x.de+x.categoryLabel).toLowerCase().includes(q));}
  if(S.show==='today'){const today=new Date().toISOString().slice(0,10); view=view.filter(x=> S.todaySet.size?S.todaySet.has(x.pack):(x.date && x.date.startsWith(today)) );}
  $("#empty").hidden=!!view.length; if(!view.length) return;
  view.forEach((item,idx)=> list.appendChild(renderCard(item, idx)));
}
function renderCard(item,idx){
  const c=document.createElement('div'); c.className='card'; c.dataset.idx=idx;
  c.innerHTML=`
    <div class="row" style="justify-content:space-between">
      <span class="badge">${escape(item.categoryLabel)}</span>
      <span class="badge">${escape(item.pack.split('/').pop())}</span>
    </div>
    <h3>${escape(item.fr)}</h3>
    <p>DE: ${escape(item.de||'')}</p>
    ${item.hint?`<div class="small">Hinweis: ${escape(item.hint)}</div>`:''}
    <div class="actions">
      <button class="pill play">Abspielen</button>
      <button class="pill slow">Langsam</button>
      <button class="pill vslow">Sehr langsam</button>
    </div>
    <div class="row record">
      <button class="pill good rec">● Aufnehmen</button>
    </div>
    <div class="chips" hidden></div>
    <div class="small" id="heard" hidden><b>Verstanden:</b> <span class="text"></span> <span class="small">· Konfidenz: <span class="conf"></span></span></div>
    <div class="scorebar"><i style="width:0%"></i></div>`;
  // Wire
  c.querySelector('.play').onclick=()=> speak(item.fr,'fr-FR',1);
  c.querySelector('.slow').onclick=()=> speak(item.fr,'fr-FR',0.9);
  c.querySelector('.vslow').onclick=()=> speak(item.fr,'fr-FR',0.75);
  c.querySelector('.rec').onclick = ()=> startRecognitionForCard(c,item.fr);
  // auto-tap speaking
  c.addEventListener('click',(e)=>{
    if(e.target.closest('.pill')) return;
    if(!S.tts.enabled) return;
    speak(item.fr,'fr-FR',1);
  });
  return c;
}
function escape(s){return String(s).replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]))}

/* -------------- TTS -------------- */
function initTTS(){
  if(!('speechSynthesis' in window)) return;
  const up=()=>{S.tts.voices=speechSynthesis.getVoices();};
  speechSynthesis.onvoiceschanged=up; up();
}
function pickVoice(lang){
  const want=lang.slice(0,2).toLowerCase(); const vs=S.tts.voices||[];
  const isG=v=>/google/i.test(v.name); const isS=v=>/samsung/i.test(v.name);
  const starts=v=>(v.lang||'').toLowerCase().startsWith(want);
  return vs.find(v=>isG(v)&&starts(v))||vs.find(v=>!isS(v)&&starts(v))||vs.find(v=>starts(v))||null;
}
function speak(text,lang,rate){
  try{
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text); const v=pickVoice(lang);
    if(v){u.voice=v; u.lang=v.lang||lang;} else u.lang=lang;
    u.rate=rate||1; u.pitch=1; setTimeout(()=>speechSynthesis.speak(u),80);
  }catch(e){toast('TTS Fehler')}
}

/* -------------- SR + scoring -------------- */
function startRecognitionForCard(card, expected){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){toast('Spracherkennung nicht verfügbar');return;}
  const rec=new SR(); rec.lang='fr-FR'; rec.interimResults=false; rec.continuous=false;
  const chips=card.querySelector('.chips'); const heard=card.querySelector('#heard'); const scorebar=card.querySelector('.scorebar i');
  chips.hidden=false; chips.innerHTML='';
  heard.hidden=true; scorebar.style.width='0%';
  try{rec.start();}catch{}
  rec.onresult=(e)=>{
    const said=[...e.results].map(r=>r[0].transcript).join(' ');
    const conf = Math.round(([...e.results].reduce((a,r)=>a+r[0].confidence,0)/e.results.length||0)*100);
    const expN=norm(expected), saidN=norm(said);
    // word chips vs expected
    const eWords=expN.split(' '), sWords=saidN.split(' ');
    eWords.forEach((w,i)=>{
      const ok = sWords[i]===w;
      const almost = !ok && (lev(w,sWords[i]||'')<=1);
      const span=document.createElement('span'); span.className='chip '+(ok?'g':almost?'y':'r'); span.textContent=(expected.split(' ')[i]||w);
      chips.appendChild(span);
    });
    const acc = Math.round((1-lev(expN,saidN)/Math.max(1,expN.length,saidN.length))*100);
    heard.hidden=false; heard.querySelector('.text').textContent=said||'—'; heard.querySelector('.conf').textContent=conf+'%';
    scorebar.style.width=Math.max(2,acc)+'%';
    updateLog(acc);
    if(S.auto && S.shadow){ // hold result before moving on
      setTimeout(()=> goNext(), 900);
    }
  };
  rec.onerror=()=>toast('SR Fehler'); rec.onend=()=>{};
}
function norm(s){return String(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9'\s]/g,' ').replace(/\s+/g,' ').trim()}
function lev(a,b){const m=a.length,n=b.length,dp=Array.from({length:m+1},()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++)dp[i][0]=i; for(let j=0;j<=n;j++)dp[0][j]=j; for(let i=1;i<=m;i++){for(let j=1;j<=n;j++){const c=a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+c);}} return dp[m][n];}

/* -------------- logs & streaks -------------- */
function loadLog(){try{S.log=JSON.parse(localStorage.getItem('famlog')||'{}');}catch{S.log={}};updateStatsUI();}
function saveLog(){localStorage.setItem('famlog',JSON.stringify(S.log))}
function updateLog(score){
  const d=new Date(); const ds=d.toISOString().slice(0,10);
  (S.log[ds] ||= {scores:[],ts:Date.now()}).scores.push(score);
  saveLog(); updateStatsUI();
}
function avgLast10(){
  const all=[]; Object.values(S.log).forEach(v=> all.push(...v.scores));
  const last=all.slice(-10); if(!last.length) return '—';
  return Math.round(last.reduce((a,b)=>a+b,0)/last.length);
}
function dayStreak(){
  const keys=Object.keys(S.log).sort(); if(!keys.length) return 0;
  let streak=0; let cur=new Date(); cur.setHours(0,0,0,0);
  for(let i=keys.length-1;i>=0;i--){
    const k=keys[i]; const dt=new Date(k+'T00:00:00'); const diff=(cur-dt)/(24*3600*1000);
    if(diff===0){streak++; cur.setDate(cur.getDate()-1);} else if(diff===1){streak++; cur.setDate(cur.getDate()-1);} else break;
  }
  return streak;
}
function weekStreak(){
  // count consecutive ISO weeks containing activity
  const weeks=Object.keys(S.log).reduce((s,k)=>{const d=new Date(k+'T00:00:00'); const y=d.getUTCFullYear(); const w=Math.floor((d - new Date(Date.UTC(y,0,1)))/ (7*24*3600*1000)); s.add(y+'-'+w); return s;}, new Set());
  const arr=[...weeks].sort(); if(!arr.length) return 0;
  let streak=1; for(let i=arr.length-2;i>=0;i--){ const [y1,w1]=arr[i].split('-').map(Number), [y2,w2]=arr[i+1].split('-').map(Number); const cont=(y1===y2? w1+1===w2 : (y1+1===y2 && w1===Math.floor((new Date(Date.UTC(y1,11,31))-new Date(Date.UTC(y1,0,1)))/(7*24*3600*1000)) && w2===0)); if(cont) streak++; else break;}
  return streak;
}
function updateStatsUI(){
  const today=new Date().toISOString().slice(0,10);
  const cnt=S.log[today]?.scores.length||0; $("#stat-today").textContent=cnt+' Versuche';
  $("#stat-avg").textContent=(avgLast10()+'%');
  $("#stat-streak").textContent=dayStreak()+'🔥';
  $("#stat-wstreak").textContent=weekStreak()+'🔥';
}

/* -------------- news / audio (robust) -------------- */
function buildNews(){
  const presets=[
    {ttl:'RFI Monde – Live (Nachrichten/Talk)', url:'https://rfimonde64k.ice.infomaniak.ch/rfimonde-64.mp3', site:'https://www.rfi.fr/fr/direct-monde', pods:[['Podcast-Übersicht','https://www.rfi.fr/fr/podcasts/']]},
    {ttl:'franceinfo – Live (24/7 Nachrichten)', url:'https://icecast.radiofrance.fr/franceinfo-midfi.mp3', site:'https://www.radiofrance.fr/franceinfo/direct', pods:[['Podcasts','https://www.radiofrance.fr/franceinfo/podcasts']]},
    {ttl:'France Inter – Live (Allgemein)', url:'https://icecast.radiofrance.fr/franceinter-midfi.mp3', site:'https://www.radiofrance.fr/franceinter/direct', pods:[['Podcasts','https://www.radiofrance.fr/franceinter/podcasts']]},
    {ttl:'France Culture – Live (Kultur)', url:'https://icecast.radiofrance.fr/franceculture-midfi.mp3', site:'https://www.radiofrance.fr/franceculture/direct', pods:[['Podcasts','https://www.radiofrance.fr/franceculture/podcasts']]},
    {ttl:'RTL – Live (Généraliste)', url:'https://streaming.radio.rtl.fr/rtl-1-44-128', site:'https://www.rtl.fr/direct'}
  ];
  const list=$("#news-list"); list.innerHTML='';
  presets.forEach(p=>{
    const row=document.createElement('div'); row.className='newsitem';
    row.innerHTML=`<div class="ttl">${escape(p.ttl)} <div class="soft">${escape((new URL(p.url)).hostname)}</div></div>
      <div class="row" style="gap:8px">
        <button class="pill primary">► Play</button>
        <a class="pill" href="${p.url}" target="_blank" rel="noopener">↗ Im Tab öffnen</a>
        ${p.site?`<a class="pill" href="${p.site}" target="_blank" rel="noopener">Website</a>`:''}
      </div>`;
    row.querySelector('button').onclick=()=> newsPlay(p.url);
    list.appendChild(row);
  });

  $('#news-play').onclick = ()=>{const u=$('#news-url').value.trim(); if(!u){toast('URL einfügen');return;} newsPlay(u);};
  $('#news-stop').onclick = ()=> newsStop();
  $('#news-save').onclick = ()=>{const u=$('#news-url').value.trim(); if(u){ localStorage.setItem('newsCustom',u); toast('Gespeichert'); }};
  const saved=localStorage.getItem('newsCustom'); if(saved) $('#news-url').value=saved;
  $$('.rate').forEach(b=> b.onclick=()=>{ $$('.rate').forEach(x=>x.classList.remove('active')); b.classList.add('active'); S.news.rate=parseFloat(b.dataset.r)||1; $('#news-audio').playbackRate=S.news.rate; });
  $('#news-back20').onclick=()=>{const a=$('#news-audio'); try{a.currentTime=Math.max(0,(a.currentTime||0)-20);}catch{}};

  // Beep test using WebAudio (no file)
  const beep=document.createElement('button'); beep.className='pill'; beep.textContent='Beep-Test';
  $('#news-stop').insertAdjacentElement('afterend',beep);
  beep.onclick=()=>{ try{const ac=new (window.AudioContext||window.webkitAudioContext)(); const o=ac.createOscillator(); const g=ac.createGain(); o.type='sine'; o.frequency.value=440; g.gain.value=.15; o.connect(g); g.connect(ac.destination); o.start(); setTimeout(()=>{o.stop(); ac.close();},350);}catch{} };
}
function newsPlay(raw){
  const a=$('#news-audio'); const url=raw+(raw.includes('?')?'&':'?')+'t='+Date.now();
  try{
    a.pause(); a.removeAttribute('src'); a.load(); a.src=url; a.playbackRate=S.news.rate||1; a.crossOrigin='anonymous';
    let settled=false;
    const onCan=()=>{if(settled) return; settled=true; a.play().then(()=>toast('🔊 Audio startet')).catch(e=>toast('Play blockiert')); cleanup();};
    const onErr=()=>{if(settled) return; settled=true; showAudioError(a); cleanup();};
    const timer=setTimeout(()=>{if(settled) return; settled=true; toast('⏳ Keine Daten (Timeout)'); cleanup();},4500);
    function cleanup(){a.removeEventListener('canplay',onCan); a.removeEventListener('error',onErr); clearTimeout(timer);}
    a.addEventListener('canplay',onCan,{once:true}); a.addEventListener('error',onErr,{once:true}); a.load();
  }catch(e){toast('❌ Konnte nicht abspielen');}
}
function newsStop(){const a=$('#news-audio'); try{a.pause();}catch{}}
function showAudioError(a){const map={1:'Abgebrochen',2:'Netzwerkfehler',3:'Dekodierfehler',4:'Nicht unterstützt'}; const c=a.error?.code; toast('❌ Audio-Fehler: '+(map[c]||('Code '+c||'unbekannt')))}

/* -------------- navigation (auto-advance/shadow) -------------- */
function goNext(){
  const cards=$$('#results .card'); if(!cards.length){toast('Keine Karten');return;}
  S.idx=(S.idx+1)%cards.length;
  const el=cards[S.idx]; el.scrollIntoView({behavior:'smooth',block:'center'});
  if(S.auto){ const txt=el.querySelector('h3')?.textContent||''; if(txt){ setTimeout(()=>{ speak(txt,'fr-FR',1); if(S.shadow){ setTimeout(()=> startRecognitionForCard(el,txt), 800); } }, 100);} }
}
function stopAll(){ try{speechSynthesis.cancel();}catch{}; newsStop(); toast('Gestoppt'); window.scrollTo({top:0,behavior:'smooth'});}

/* -------------- UI wiring -------------- */
function wireUI(){
  $('#q').oninput=e=>{S.q=e.target.value.trim().toLowerCase(); render();};
  $('#category').onchange=e=>{S.category=e.target.value; render();};
  $('#filter-today').onclick=e=>{const b=e.currentTarget; const on=b.getAttribute('aria-pressed')==='true'; b.setAttribute('aria-pressed',!on); b.querySelector('b').textContent=on?'Aus':'An'; S.show=on?'all':'today'; render();};
  $('#filter-packs').onclick=e=>{const b=e.currentTarget; const on=b.getAttribute('aria-pressed')==='true'; b.setAttribute('aria-pressed',!on); b.querySelector('b').textContent=on?'Aus':'An'; S.show=!on?'packs':'all'; render();};
  $('#tts-auto').onclick=e=>{const b=e.currentTarget; const on=b.getAttribute('aria-pressed')==='true'; b.setAttribute('aria-pressed',!on); b.querySelector('b').textContent=on?'Aus':'An'; S.tts.enabled=!on;};
  $('#ctrl-next').onclick=goNext; $('#ctrl-stop').onclick=stopAll;
  $('#auto-adv').onclick=e=>{const b=e.currentTarget; const on=b.getAttribute('aria-pressed')==='true'; b.setAttribute('aria-pressed',!on); b.querySelector('b').textContent=on?'Aus':'An'; S.auto=!on;};
  // mic→search
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){$('#mic').disabled=true; $('#mic').title='Spracherkennung nicht verfügbar';}
  else{ const rec=new SR(); rec.lang='fr-FR'; rec.interimResults=false; rec.continuous=false; let active=false;
    $('#mic').onclick=()=>{ if(active){try{rec.stop();}catch{};return;} try{active=true; $('#mic').textContent='Stoppen'; rec.start();}catch{} };
    rec.onresult=e=>{ const t=[...e.results].map(r=>r[0].transcript).join(' '); $('#q').value=t; S.q=t.toLowerCase(); render(); };
    const reset=()=>{active=false; $('#mic').textContent='Mikrofon'}; rec.onend=reset; rec.onerror=reset;
  }
  // log buttons
  $('#log-export').onclick=()=>{ const blob=new Blob([JSON.stringify(S.log,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='famlang-log.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); };
  $('#log-reset').onclick=()=>{ if(confirm('Log wirklich löschen?')){ localStorage.removeItem('famlog'); S.log={}; updateStatsUI(); } };
}

/* -------------- boot -------------- */
initTTS(); loadLog(); wireUI(); buildNews(); loadAll();

/* utils */
function escapeHtml(s){return escape(s)}
</script>
</body>
</html>
