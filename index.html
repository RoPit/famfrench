<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FamLang – informell, familiär (FR ⇄ DE)</title>
  <style>
    :root{ --bg:#0f1115;--fg:#e8ebf0;--muted:#9aa3b2;--card:#151822;--accent:#5aa9ff;--chip:#232738;--ring:#2b3246;--ok:#45d483;--warn:#e1c24a;--bad:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    header h1{margin:0 0 6px;font-weight:800;letter-spacing:.3px}
    header p{margin:4px 0 0;color:var(--muted)}
    .bar{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin:18px 0}
    .search{display:flex;gap:8px;align-items:center;background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:10px 12px}
    .search input{flex:1;background:transparent;border:0;outline:none;color:var(--fg);font-size:17px;min-height:40px}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    select,button{background:var(--chip);color:var(--fg);border:1px solid var(--ring);border-radius:14px;padding:8px 14px;font-size:14px;cursor:pointer;min-height:40px;min-width:110px}
    button[aria-pressed="true"]{outline:2px solid var(--accent)}
    .flags{display:flex;gap:8px}
    .flag{width:34px;height:24px;border-radius:6px;border:1px solid var(--ring);opacity:.9}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin:16px 0 36px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.25)}
    .cat{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--ring);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted);white-space:nowrap}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .txt-main{font-size:18px;margin:6px 0 2px;font-weight:700}
    .txt-sub{font-size:16px;margin:2px 0;color:#d7dbef}
    .txt-de{font-size:13px;margin:8px 0 0;color:var(--muted)}
    .empty{margin:24px 0;color:var(--muted);text-align:center}
    .pill{background:var(--chip);border:1px solid var(--ring);border-radius:999px;padding:8px 16px;display:inline-flex;align-items:center;justify-content:center;gap:8px;min-height:40px;min-width:120px;line-height:1}
    .pill:hover{background:#2a3045}
    .pill:active{transform:scale(0.98)}
    .pill:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .card .row.actions{justify-content:flex-end;gap:10px;margin-top:10px;flex-wrap:wrap}
    .pack-title{grid-column:1 / -1;margin:6px 0 2px;color:var(--muted);font-weight:600}
    #load-warn{margin:12px 0;padding:10px;border:1px solid #8b5;border-radius:10px;background:#1b2620;color:#cde;font-size:13px}
    @media (max-width:480px){.card .row.actions .pill{flex:1;min-width:0}}
    /* Aussprache-Feedback */
    .pron{margin-top:10px;font-size:15px;line-height:1.55}
    .pron span{padding:0 .14em;border-radius:6px}
    .pron .ok{background:rgba(69,212,131,.18)}
    .pron .warn{background:rgba(225,194,74,.22)}
    .pron .bad{background:rgba(255,107,107,.25)}
    .score{font-size:13px;color:var(--muted);margin-left:auto}
    .scorebar{position:relative;height:8px;border-radius:6px;background:#22293a;border:1px solid var(--ring);overflow:hidden;margin-top:6px}
    .scorebar .fill{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,var(--bad),#ffb84a,var(--ok));width:0%}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>FamLang – informell, familiär <small style="font-weight:500;color:var(--muted)">(FR ⇄ DE)</small></h1>
      <p>Französisch als Hauptsprache, deutsche Übersetzung als Hilfe. Alles läuft als Einzeldatei und ist GitHub-Pages-sicher.</p>
    </header>

    <div class="bar">
      <div class="search" role="search">
        <input id="q" type="search" placeholder="Suche (FR/DE)…" autocomplete="off" />
        <button id="mic" class="pill" title="Spracherkennung starten/stoppen">Mikrofon</button>
      </div>
      <div class="flags" aria-label="Sprache">
        <img id="flag-fr" class="flag" alt="FR" title="Französisch" />
      </div>
    </div>

    <div id="load-warn" hidden></div>

    <div class="filters">
      <select id="category"><option value="">Alle Kategorien</option></select>
      <button id="show-today" class="pill" aria-pressed="false">Heute</button>
      <button id="show-all" class="pill" aria-pressed="true">Alle</button>
      <button id="show-packs" class="pill" aria-pressed="false">Packs</button>
      <button id="tts-toggle" class="pill" aria-pressed="false" title="Vorlesen beim Antippen aktivieren/deaktivieren">Auto-TTS: Aus</button>
    </div>

    <div id="results" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty" hidden>Keine Einträge gefunden.</div>
  </div>

<script>
(() => {
  // ---------- helpers
  const $  = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const BASE = new URL('./', window.location.href);
  const urlFor  = (p) => new URL(p, BASE).toString();
  const fetchJson = async (p) => { const res = await fetch(urlFor(p), { cache:'no-store' }); if(!res.ok) throw new Error(`Fetch failed ${p}: ${res.status}`); return res.json(); };
  const escapeHtml = (s) => String(s).replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
  const escapeAttr = (s) => escapeHtml(s).replace(/`/g,'&#96;');

  // ---------- state
  const state = {
    // FR only
    primary:'fr',
    show:'all',
    category:'',     // categoryKey
    q:'',
    items:[],        // {categoryKey, categoryLabel, fr, de, ...}
    categories:new Set(),
    todaySet:new Set(),
    tts:{ enabled:false, voices:[], ready:false, pref:'google' } // prefer Google
  };
  let manifestOrder = []; // from manifest.categoryOrder

  // ---------- static FR flag
  $('#flag-fr').src='data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 3 2"><rect width="1" height="2" x="0" fill="#0055A4"/><rect width="1" height="2" x="1" fill="#fff"/><rect width="1" height="2" x="2" fill="#EF4135"/></svg>');

  // ---------- filters and UI events
  $('#q').addEventListener('input', e=>{ state.q = e.target.value.trim().toLowerCase(); render(); });
  $('#category').addEventListener('change', e=>{ state.category = e.target.value; render(); });
  $('#show-today').addEventListener('click', ()=> setShow('today'));
  $('#show-all').addEventListener('click',  ()=> setShow('all'));
  $('#show-packs').addEventListener('click',()=> setShow('packs'));
  $('#tts-toggle').addEventListener('click', ()=>{ state.tts.enabled = !state.tts.enabled; updateTtsToggle(); });

  function setShow(mode){
    state.show = mode;
    $('#show-today').setAttribute('aria-pressed', mode==='today');
    $('#show-all').setAttribute('aria-pressed', mode==='all');
    $('#show-packs').setAttribute('aria-pressed', mode==='packs');
    render();
  }

  // ---------- load (fault tolerant) + categories (labels/order)
  async function loadAll(){
    try{
      const manifest = await fetchJson('data/manifest.json');
      const packs = Array.isArray(manifest.packs) ? manifest.packs : [];
      state.todaySet = new Set(Array.isArray(manifest.todayPacks) ? manifest.todayPacks : []);
      const names  = manifest.categoryNames || {};
      const labels = manifest.categoryLabels || {};
      manifestOrder = Array.isArray(manifest.categoryOrder) ? manifest.categoryOrder : [];

      const settled = await Promise.allSettled(
        packs.map(async p => ({ path:p, raw: await fetchJson(p) }))
      );

      state.items=[]; state.categories=new Set();
      const failed=[];

      for(const r of settled){
        if(r.status!=='fulfilled'){
          failed.push((r.reason && String(r.reason).replace(/^Error:\s*/,'')) || 'unbekannt');
          continue;
        }
        const { path, raw } = r.value;
        const rows = Array.isArray(raw) ? raw : (Array.isArray(raw?.phrases) ? raw.phrases : []);
        const key  = names[path] || (raw && raw.name) || guessCategory(path);
        const label= labels[key] || key;

        state.categories.add(key);

        if(Array.isArray(rows)){
          rows.forEach((row, idx)=>{
            state.items.push({
              id:`${path}#${idx}`,
              categoryKey:key,
              categoryLabel:label,
              fr:String(row.fr ?? ''),            // FR is primary content
              de:String(row.de ?? row.en ?? ''),  // German may live in "en"
              hint:String(row.hint ?? ''),
              pack:path,
              date:String(row.date || '')
            });
          });
        }
      }

      buildCategorySelect();
      render();
      showLoadReport(failed);
    }catch(err){
      showError(err);
    }
  }

  function guessCategory(path){ const file = path.split('/').pop(); return (file||'').replace(/_/g,' ').replace(/\..+$/,''); }

  function buildCategorySelect(){
    const sel = $('#category');
    const current = sel.value;

    const keys = Array.from(state.categories);
    const ordered = [
      ...manifestOrder.filter(k => keys.includes(k)),
      ...keys.filter(k => !manifestOrder.includes(k)).sort()
    ];

    sel.innerHTML =
      '<option value="">Alle Kategorien</option>' +
      ordered.map(k => {
        const any = state.items.find(x => x.categoryKey === k);
        const label = any ? any.categoryLabel : k;
        return `<option value="${escapeHtml(k)}">${escapeHtml(label)}</option>`;
      }).join('');

    sel.value = current || '';
  }

  function showLoadReport(failed){
    const el = $('#load-warn');
    if(!failed || !failed.length){ el.hidden = true; el.textContent=''; return; }
    el.hidden = false;
    el.innerHTML = '⚠️ Einige Dateien konnten nicht geladen werden: ' +
      failed.map(s => `<code>${escapeHtml(s)}</code>`).join(', ') +
      '. Prüfe <code>data/manifest.json</code> (Pfade ohne führenden Slash, gültiges JSON).';
  }

  // ---------- render
  function render(){
    const list = $('#results');
    const empty = $('#empty');
    list.innerHTML='';

    let view = state.items.slice();
    if(state.category) view = view.filter(x=>x.categoryKey===state.category);

    if(state.q){
      const q = state.q;
      view = view.filter(x => {
        const inText = (x.fr + x.de).toLowerCase().includes(q);
        const inCat  = (x.categoryLabel || x.categoryKey || '').toLowerCase().includes(q);
        return inText || inCat;
      });
    }

    if(state.show==='today'){
      const todayISO = new Date().toISOString().slice(0,10);
      view = view.filter(x => state.todaySet.size>0 ? state.todaySet.has(x.pack) : (x.date && x.date.startsWith(todayISO)) );
    }

    if(!view.length){ empty.hidden=false; return; } else { empty.hidden=true; }

    const frag = document.createDocumentFragment();

    if(state.show==='packs'){
      view.sort((a,b)=> a.pack.localeCompare(b.pack) || a.id.localeCompare(b.id));
      let currentPack='';
      for(const item of view){
        if(item.pack!==currentPack){
          currentPack=item.pack;
          const h=document.createElement('h3');
          h.className='pack-title';
          h.textContent=item.pack.split('/').pop();
          frag.appendChild(h);
        }
        renderCard(frag,item);
      }
    } else {
      for(const item of view) renderCard(frag,item);
    }

    list.appendChild(frag);
  }

  // If FR missing (rare), show DE as main so the card isn't empty (still speak FR if available)
  function getMain(item){
    let text = (item.fr || '').trim();
    let lang = 'fr';
    if(!text){
      text = (item.de || '').trim();
      lang = 'fr'; // we will still speak FR (if user studies FR); if no FR text, speaking DE could be confusing
    }
    return { text, lang };
  }

  function renderCard(frag,item){
    const main = getMain(item);
    const card = document.createElement('div');
    card.className='card';
    card.setAttribute('data-main-lang', main.lang);
    card.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <span class="cat" title="Kategorie">${escapeHtml(item.categoryLabel)}</span>
        <span class="cat" title="Paket">${escapeHtml(item.pack.split('/').pop())}</span>
      </div>
      <div class="txt-main">${escapeHtml(main.text)}</div>
      <div class="txt-sub">DE: ${escapeHtml(item.de || '')}</div>
      <div class="txt-de">${item.hint ? 'Hinweis: <em>'+escapeHtml(item.hint)+'</em>' : ''}</div>

      <div class="pron" aria-live="polite"></div>
      <div class="scorebar" aria-hidden="true"><div class="fill"></div></div>

      <div class="row actions">
        <button class="pill say" data-mode="normal" data-text="${escapeAttr(main.text)}" data-lang="fr">Abspielen</button>
        <button class="pill say" data-mode="slow"   data-text="${escapeAttr(main.text)}" data-lang="fr">Langsam</button>
        <button class="pill rec"                   data-text="${escapeAttr(main.text)}" data-lang="fr">Aufnehmen</button>
        <span class="score" aria-live="polite">Bewertung: –</span>
      </div>
    `;
    frag.appendChild(card);
  }

  function showError(err){ $('#empty').hidden=false; $('#empty').textContent='Fehler beim Laden: ' + (err?.message || err); console.error(err); }

  // ---------- TTS (prefer Google voices, FR only)
  function pickVoiceForFR(){
    const vs = state.tts.voices || [];
    const isG = v=>/google/i.test(v.name||'');
    const startsFR = v=>(v.lang||'').toLowerCase().startsWith('fr');
    const inclFR   = v=>(v.lang||'').toLowerCase().includes('fr');
    return vs.find(v=>isG(v)&&startsFR(v)) || vs.find(v=>isG(v)&&inclFR(v)) ||
           vs.find(v=>startsFR(v)) || vs.find(v=>inclFR(v)) || null;
  }
  function speak(text, mode){
    if(!text || !text.trim()) return;
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const v = pickVoiceForFR();
      if(v){ u.voice=v; u.lang=v.lang||'fr-FR'; } else u.lang='fr-FR';
      u.rate = (mode==='slow') ? 0.9 : 1.0;
      u.pitch = 1.0;
      setTimeout(()=>window.speechSynthesis.speak(u),100);
    }catch(e){ console.error(e); }
  }

  // ---------- Recording (score, FR)
  function startRecognition(btn){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ alert('Spracherkennung wird nicht unterstützt.'); return; }

    const expect = (btn.getAttribute('data-text') || '').trim();
    const card   = btn.closest('.card');
    const out    = card.querySelector('.pron');
    const scoreEl= card.querySelector('.score');
    const bar    = card.querySelector('.scorebar .fill');

    out.textContent='Aufnahme läuft…';
    scoreEl.textContent='Bewertung: …';
    bar.style.width='0%';

    const rec = new SR();
    rec.lang = 'fr-FR'; rec.interimResults=false; rec.continuous=false;

    try{ rec.start(); }catch{}

    rec.onresult = (e)=>{
      const said = Array.from(e.results).map(r=>r[0].transcript).join(' ').trim();
      const result = compareUtterance(expect, said);
      out.innerHTML = result.markup;
      scoreEl.textContent = `Bewertung: ${result.percent}%`;
      bar.style.width = result.percent + '%';
    };
    rec.onerror = ()=>{ out.textContent='Fehler bei der Erkennung.'; };
    rec.onend   = ()=>{ if(out.textContent==='Aufnahme läuft…') out.textContent='—'; };
  }

  // Vergleich & Markup
  function compareUtterance(expected, said){
    const exp = tokenize(expected);
    const got = tokenize(said);
    const aligned = align(exp, got);
    let ok=0, total=exp.length;
    const html = aligned.map(({exp, got})=>{
      if(!exp && got){ return `<span class="bad">${escapeHtml(got)}</span>`; }
      if(exp && !got){ return `<span class="bad">${escapeHtml(exp)}</span>`; }
      const a = exp, b = got;
      if(a===b){ ok++; return `<span class="ok" title="OK">${escapeHtml(exp)}</span>`; }
      const near = lev(a,b) <= 1 && Math.max(a.length,b.length) >= 3;
      if(near){ ok += 0.6; return `<span class="warn" title="gehört: ${escapeHtml(got)}">${escapeHtml(exp)}</span>`; }
      return `<span class="bad" title="gehört: ${escapeHtml(got)}">${escapeHtml(exp)}</span>`;
    }).join(' ');
    const percent = Math.max(0, Math.min(100, Math.round(100*ok/Math.max(1,total))));
    return { percent, markup: html };
  }

  function tokenize(s){
    return String(s)
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // Akzente entfernen (Vergleich)
      .replace(/’/g,"'")
      .replace(/[^a-z0-9' ]+/g,' ')
      .replace(/'/g,' ')
      .split(/\s+/).filter(Boolean);
  }
  function lev(a,b){
    const m=a.length,n=b.length; if(!m) return n; if(!n) return m;
    const dp=new Array(n+1); for(let j=0;j<=n;j++) dp[j]=j;
    for(let i=1;i<=m;i++){
      let prev=dp[0]++; // dp[0]=i
      for(let j=1;j<=n;j++){
        const tmp=dp[j];
        dp[j]= (a[i-1]===b[j-1]) ? prev :
               Math.min(prev, dp[j], dp[j-1]) + 1;
        prev=tmp;
      }
    }
    return dp[n];
  }
  function align(a,b){
    const m=a.length,n=b.length;
    const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
    for(let i=0;i<=m;i++) dp[i][0]=i;
    for(let j=0;j<=n;j++) dp[0][j]=j;
    for(let i=1;i<=m;i++){
      for(let j=1;j<=n;j++){
        const cost = a[i-1]===b[j-1] ? 0 : 1;
        dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
      }
    }
    const out=[];
    let i=m,j=n;
    while(i>0 || j>0){
      if(i>0 && dp[i][j]===dp[i-1][j]+1){ out.unshift({exp:a[i-1],got:''}); i--; continue; }
      if(j>0 && dp[i][j]===dp[i][j-1]+1){ out.unshift({exp:'',got:b[j-1]}); j--; continue; }
      out.unshift({exp:a[i-1]||'', got:b[j-1]||''}); i--; j--;
    }
    return out;
  }

  // ---------- events for cards + mic
  function initUI(){
    const hasTTS = 'speechSynthesis' in window;

    $('#results').addEventListener('click', (e)=>{
      const sayBtn = e.target.closest('.say');
      if(sayBtn && hasTTS){
        const text = sayBtn.getAttribute('data-text') || '';
        const mode = sayBtn.getAttribute('data-mode') || 'normal';
        speak(text, mode);
        return;
      }
      const recBtn = e.target.closest('.rec');
      if(recBtn){ startRecognition(recBtn); return; }

      const card = e.target.closest('.card');
      if(!card || !state.tts.enabled || !hasTTS) return;
      const main = card.querySelector('.txt-main');
      const text = main ? main.textContent.trim() : '';
      speak(text, 'normal');
    });

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const micBtn = $('#mic');
    if(!SR){ if(micBtn){ micBtn.disabled=true; micBtn.title='Spracherkennung nicht verfügbar'; } return; }
    let micActive=false;
    const rec = new SR();
    rec.interimResults=false; rec.continuous=false;
    if(micBtn){
      micBtn.addEventListener('click', ()=>{
        if(micActive){ rec.stop(); return; }
        rec.lang = 'fr-FR';
        micActive=true; micBtn.textContent='Stoppen';
        try{ rec.start(); }catch{}
      });
      rec.onresult = (e)=>{
        const t = Array.from(e.results).map(r=>r[0].transcript).join(' ');
        $('#q').value = t; state.q = t.toLowerCase(); render();
      };
      rec.onerror = ()=>{ micActive=false; micBtn.textContent='Mikrofon'; };
      rec.onend   = ()=>{ micActive=false; micBtn.textContent='Mikrofon'; };
    }
  }

  function updateTtsToggle(){
    const b=$('#tts-toggle');
    b.setAttribute('aria-pressed', state.tts.enabled);
    b.textContent = state.tts.enabled ? 'Auto-TTS: An' : 'Auto-TTS: Aus';
  }

  function initTTS(){
    if('speechSynthesis' in window){
      const loadVoices = () => { state.tts.voices = window.speechSynthesis.getVoices(); state.tts.ready = true; };
      loadVoices();
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }
  }

  // ---------- boot
  initTTS();
  initUI();
  updateTtsToggle();
  loadAll();
})();
</script>
</body>
</html>
