<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FamLang – informell, familiär (FR ⇄ DE)</title>
<style>
  :root{ --bg:#0f1115;--fg:#e8ebf0;--muted:#9aa3b2;--card:#151822;--ring:#2b3246;--chip:#232738;--accent:#61dafb;--ok:#3bd18a;--warn:#ffd36a;--bad:#ff8a8a }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  header h1{margin:0 0 6px;font-weight:800}
  header p{margin:8px 0 0;color:var(--muted)}
  .bar{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin:18px 0}
  .search{display:flex;gap:8px;align-items:center;background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:10px 12px}
  .search input{flex:1;background:transparent;border:0;outline:none;color:var(--fg);font-size:17px;min-height:40px}
  .filters{display:flex;gap:8px;flex-wrap:wrap}
  select,button{background:var(--chip);color:var(--fg);border:1px solid var(--ring);border-radius:14px;padding:8px 14px;font-size:14px;cursor:pointer;min-height:40px;min-width:110px}
  button[aria-pressed="true"]{outline:2px solid var(--accent)}
  .flag{width:34px;height:24px;border-radius:6px;border:1px solid var(--ring);opacity:.9}
  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin:16px 0 36px}
  @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .cat{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--ring);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted)}
  .txt-main{font-size:18px;margin:6px 0 2px;font-weight:700}
  .txt-sub{font-size:16px;margin:2px 0;color:#d7dbef}
  .hint{font-size:13px;color:var(--muted);margin-top:6px}
  .empty{margin:24px 0;color:var(--muted);text-align:center}
  .actions{justify-content:flex-end;gap:10px;margin-top:12px;flex-wrap:wrap}
  .pack-title{grid-column:1/-1;margin:6px 0 2px;color:var(--muted);font-weight:600}
  /* Pronunciation feedback */
  .score-wrap{margin-top:10px}
  .score-meter{height:10px;background:#1a1f2e;border:1px solid var(--ring);border-radius:999px;overflow:hidden}
  .score-fill{height:100%;width:0%}
  .score-head{display:flex;align-items:baseline;gap:10px;margin:8px 0}
  .score-big{font-size:20px;font-weight:800}
  .tokens{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 2px}
  .tok{padding:6px 10px;border-radius:999px;font-weight:600}
  .tok.good{background:rgba(59,209,138,.15);border:1px solid rgba(59,209,138,.55)}
  .tok.ok  {background:rgba(255,211,106,.12);border:1px solid rgba(255,211,106,.55)}
  .tok.bad {background:rgba(255,138,138,.12);border:1px solid rgba(255,138,138,.55)}
  .legend{color:var(--muted);font-size:12px;display:flex;gap:12px}
  .legend .dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-right:6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>FamLang – informell, familiär <small style="font-weight:500;color:var(--muted)">(FR ⇄ DE)</small></h1>
    <p>Französisch als Hauptsprache, deutsche Übersetzung als Hilfe. Alles läuft als Einzeldatei und ist GitHub-Pages-sicher.</p>
  </header>

  <div class="bar">
    <div class="search" role="search">
      <input id="q" type="search" placeholder="Suche (FR/DE)…" autocomplete="off"/>
      <button id="mic" title="Spracherkennung starten/stoppen">Mikrofon</button>
    </div>
    <img id="flag-fr" class="flag" alt="FR" title="Französisch"/>
  </div>

  <div class="filters">
    <select id="category"><option value="">Alle Kategorien</option></select>
    <button id="show-today" aria-pressed="false">Heute</button>
    <button id="show-all" aria-pressed="true">Alle</button>
    <button id="show-packs" aria-pressed="false">Packs</button>
    <button id="tts-toggle" aria-pressed="false" title="Vorlesen beim Antippen aktivieren/deaktivieren">Auto-TTS: Aus</button>
  </div>

  <div id="results" class="grid" aria-live="polite"></div>
  <div id="empty" class="empty" hidden>Keine Einträge gefunden.</div>
</div>

<script>
(() => {
  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const BASE = new URL('./',location.href);
  const url = p => new URL(p,BASE).toString();
  const fetchJson = async p => { const r=await fetch(url(p),{cache:'no-store'}); if(!r.ok) throw new Error(`${p}: ${r.status}`); return r.json(); };
  const esc = s => String(s).replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

  const state = { show:'all', category:'', q:'', items:[], categories:new Set(), todaySet:new Set(),
                  tts:{enabled:false,voices:[],ready:false,pref:'google'} };

  // flag
  $('#flag-fr').src='data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 3 2"><rect width="1" height="2" x="0" fill="#0055A4"/><rect width="1" height="2" x="1" fill="#fff"/><rect width="1" height="2" x="2" fill="#EF4135"/></svg>');

  // controls
  $('#show-today').onclick=()=>setShow('today');
  $('#show-all').onclick = ()=>setShow('all');
  $('#show-packs').onclick=()=>setShow('packs');
  $('#tts-toggle').onclick = ()=>{state.tts.enabled=!state.tts.enabled;updateTtsToggle();};
  $('#category').onchange = e=>{state.category=e.target.value;render();};
  $('#q').oninput = e=>{state.q=e.target.value.trim().toLowerCase();render();};

  function setShow(mode){ state.show=mode; $('#show-today').setAttribute('aria-pressed',mode==='today'); $('#show-all').setAttribute('aria-pressed',mode==='all'); $('#show-packs').setAttribute('aria-pressed',mode==='packs'); render(); }
  function updateTtsToggle(){ const b=$('#tts-toggle'); b.setAttribute('aria-pressed',state.tts.enabled); b.textContent=state.tts.enabled?'Auto-TTS: An':'Auto-TTS: Aus'; }

  // load data
  async function loadAll(){
    try{
      const manifest = await fetchJson('data/manifest.json');
      const packs = manifest.packs||[];
      state.todaySet = new Set(manifest.todayPacks||[]);
      const names = manifest.categoryNames||{};
      const labels= manifest.categoryLabels||{};
      const order = manifest.categoryOrder||[];

      const settled = await Promise.allSettled(packs.map(async p=>({path:p,raw:await fetchJson(p)})));
      state.items=[]; state.categories=new Set();

      for(const r of settled){
        if(r.status!=='fulfilled') continue;
        const {path,raw}=r.value;
        const rows = Array.isArray(raw)?raw:(Array.isArray(raw?.phrases)?raw.phrases:[]);
        const key=(names[path]||raw?.name||guess(path)); const label=labels[key]||key;
        state.categories.add(key);
        rows.forEach((row,i)=>state.items.push({
          id:`${path}#${i}`, categoryKey:key, categoryLabel:label,
          fr:String(row.fr??''), de:String(row.de??row.en??''), hint:String(row.hint??''), pack:path, date:String(row.date||'')
        }));
      }

      // category select (ordered)
      const keys=Array.from(state.categories);
      const ordered=[...order.filter(k=>keys.includes(k)), ...keys.filter(k=>!order.includes(k)).sort()];
      const sel=$('#category'); const cur=sel.value;
      sel.innerHTML='<option value="">Alle Kategorien</option>'+ordered.map(k=>{
        const any=state.items.find(x=>x.categoryKey===k); const lab=any?any.categoryLabel:k;
        return `<option value="${esc(k)}">${esc(lab)}</option>`;
      }).join('');
      sel.value=cur||'';
      render();
    }catch(e){ showError(e); }
  }
  const guess = p => (p.split('/').pop()||'').replace(/_/g,' ').replace(/\..+$/,'');

  // render
  function render(){
    const list=$('#results'), empty=$('#empty'); list.innerHTML='';
    let v=state.items.slice();
    if(state.category) v=v.filter(x=>x.categoryKey===state.category);
    if(state.q){ const q=state.q; v=v.filter(x=>(x.fr+x.de+x.categoryLabel).toLowerCase().includes(q)); }
    if(state.show==='today'){ const t=new Date().toISOString().slice(0,10); v=v.filter(x=>state.todaySet.size?state.todaySet.has(x.pack):(x.date && x.date.startsWith(t))); }
    if(!v.length){ empty.hidden=false; return; } else empty.hidden=true;

    const frag=document.createDocumentFragment();
    if(state.show==='packs'){
      v.sort((a,b)=>a.pack.localeCompare(b.pack)||a.id.localeCompare(b.id));
      let cur=''; for(const it of v){ if(it.pack!==cur){cur=it.pack; const h=document.createElement('h3'); h.className='pack-title'; h.textContent=it.pack.split('/').pop(); frag.appendChild(h);} frag.appendChild(card(it)); }
    }else{
      v.forEach(it=>frag.appendChild(card(it)));
    }
    list.appendChild(frag);
  }

  function card(it){
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`
      <div class="row" style="justify-content:space-between">
        <span class="cat">${esc(it.categoryLabel)}</span>
        <span class="cat">${esc(it.pack.split('/').pop())}</span>
      </div>
      <div class="txt-main">${esc(it.fr)}</div>
      <div class="txt-sub">DE: ${esc(it.de)}</div>
      ${it.hint?`<div class="hint">Hinweis: ${esc(it.hint)}</div>`:''}
      <div class="score-wrap" hidden>
        <div class="score-head">
          <span class="score-big" data-score>—%</span>
          <div class="legend">
            <span><span class="dot" style="background:var(--ok)"></span>gut</span>
            <span><span class="dot" style="background:var(--warn)"></span>okay</span>
            <span><span class="dot" style="background:var(--bad)"></span>verbessern</span>
          </div>
        </div>
        <div class="tokens" data-tokens></div>
        <div class="score-meter"><div class="score-fill" data-meter></div></div>
      </div>
      <div class="row actions">
        <button class="say" data-mode="normal"  data-text="${esc(it.fr)}">Abspielen</button>
        <button class="say" data-mode="slow"    data-text="${esc(it.fr)}">Langsam</button>
        <button class="say" data-mode="xslow"   data-text="${esc(it.fr)}">Sehr langsam</button>
        <button class="rec" data-text="${esc(it.fr)}">Aufnehmen</button>
      </div>`;
    return el;
  }

  function showError(e){ $('#empty').hidden=false; $('#empty').textContent='Fehler beim Laden: '+(e?.message||e); console.error(e); }

  // ------ TTS
  function pickVoiceFor(lang, prefer='google'){
    const want=(lang||'fr-FR').slice(0,2).toLowerCase();
    const vs=state.tts.voices||[];
    const isG=v=>/google/i.test(v.name||''); const isS=v=>/samsung/i.test(v.name||'');
    const starts=v=>(v.lang||'').toLowerCase().startsWith(want);
    const includes=v=>(v.lang||'').toLowerCase().includes(want);
    const order = prefer==='google'
      ? [v=>isG(v)&&starts(v),v=>isG(v)&&includes(v),v=>!isS(v)&&starts(v),v=>starts(v),v=>includes(v)]
      : [v=>isS(v)&&starts(v),v=>isS(v)&&includes(v),v=>isG(v)&&starts(v),v=>starts(v),v=>includes(v)];
    for(const f of order){ const hit=vs.find(f); if(hit) return hit; }
    return null;
  }
  function speak(text, mode){
    if(!text) return;
    try{
      speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(text);
      const v=pickVoiceFor('fr-FR',state.tts.pref||'google');
      if(v){u.voice=v;u.lang=v.lang||'fr-FR';} else u.lang='fr-FR';
      u.rate = mode==='xslow' ? 0.55 : mode==='slow' ? 0.75 : 1.0;   // << slower now
      u.pitch=1.0;
      setTimeout(()=>speechSynthesis.speak(u),60);
    }catch(e){console.error(e);}
  }
  function initTTS(){
    if(!('speechSynthesis'in window)) return;
    const load=()=>{state.tts.voices=speechSynthesis.getVoices();state.tts.ready=true;};
    load(); speechSynthesis.onvoiceschanged=load;
  }

  // ------ Recording with clearer feedback
  function startRecognition(btn){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR){ alert('Spracherkennung wird nicht unterstützt.'); return; }
    const expect=btn.getAttribute('data-text')||'';
    const card=btn.closest('.card');
    const wrap=card.querySelector('.score-wrap');
    const meter=card.querySelector('[data-meter]');
    const scoreText=card.querySelector('[data-score]');
    const tokensEl=card.querySelector('[data-tokens]');
    const rec=new SR();
    rec.lang='fr-FR'; rec.interimResults=false; rec.continuous=false;
    wrap.hidden=false; scoreText.textContent='…%'; meter.style.width='0%'; meter.style.background='var(--bad)';
    try{ rec.start(); }catch{}
    rec.onresult=e=>{
      const said=Array.from(e.results).map(r=>r[0].transcript).join(' ');
      const perWord = wordFeedback(expect, said);
      renderFeedback(perWord, scoreText, meter, tokensEl);
    };
    rec.onerror=()=>{ scoreText.textContent='—%'; };
  }

  function renderFeedback(perWord, scoreText, meter, tokensEl){
    tokensEl.innerHTML='';
    const frag=document.createDocumentFragment();
    let sum=0, n=0;
    perWord.forEach(w=>{
      const sp=document.createElement('span');
      sp.className='tok '+(w.score>=85?'good':w.score>=60?'ok':'bad');
      sp.textContent=w.word;
      sp.title=`${w.score}%`;
      frag.appendChild(sp);
      if(w.word.trim()){ sum+=w.score; n++; }
    });
    tokensEl.appendChild(frag);
    const pct = n?Math.round(sum/n):0;
    scoreText.textContent=pct+'%';
    meter.style.width=pct+'%';
    meter.style.background = pct>=85?'var(--ok)':pct>=60?'var(--warn)':'var(--bad)';
  }

  // Tokenize & score per word (Levenshtein similarity)
  function wordFeedback(expected, said){
    const A = tokenize(expected), B = tokenize(said);
    // align lengths by padding to compare one-by-one
    const len = Math.max(A.length, B.length);
    const out=[];
    for(let i=0;i<len;i++){
      const w=A[i]||''; const s=B[i]||'';
      out.push({ word:w||'∅', score: similarity(normalize(w), normalize(s)) });
    }
    return out;
  }
  const tokenize = s => String(s).split(/[\s\-]+/).filter(x=>x.length>0);
  const normalize = s => String(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z\d']/g,'').trim();
  function similarity(a,b){ if(!a && !b) return 100; const d=lev(a,b); const m=Math.max(1,a.length,b.length); return Math.round((1-d/m)*100); }
  function lev(a,b){ const m=a.length,n=b.length; const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
    for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j;
    for(let i=1;i<=m;i++) for(let j=1;j<=n;j++){ const c=a[i-1]===b[j-1]?0:1;
      dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+c);
    } return dp[m][n];
  }

  // delegate clicks
  $('#results').addEventListener('click',e=>{
    const say=e.target.closest('.say'); if(say){ speak(say.getAttribute('data-text')||'', say.getAttribute('data-mode')||'normal'); return; }
    const rec=e.target.closest('.rec'); if(rec){ startRecognition(rec); return; }
    if(!state.tts.enabled || !('speechSynthesis'in window)) return;
    const card=e.target.closest('.card'); if(!card) return;
    const text=(card.querySelector('.txt-main')?.textContent||'').trim(); if(text) speak(text,'normal');
  });

  // Mic → search
  (function initMic(){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition; const mic=$('#mic');
    if(!SR){ mic.disabled=true; mic.title='Spracherkennung nicht verfügbar'; return; }
    let active=false; const rec=new SR(); rec.lang='fr-FR'; rec.interimResults=false; rec.continuous=false;
    mic.onclick=()=>{ if(active){rec.stop();return;} active=true; mic.textContent='Stoppen'; try{rec.start();}catch{} };
    rec.onresult=e=>{ const t=Array.from(e.results).map(r=>r[0].transcript).join(' '); $('#q').value=t; state.q=t.toLowerCase(); render(); };
    rec.onerror=()=>{ active=false; mic.textContent='Mikrofon'; };
    rec.onend  =()=>{ active=false; mic.textContent='Mikrofon'; };
  })();

  // boot
  initTTS();
  updateTtsToggle();
  loadAll();
})();
</script>
</body>
</html>
