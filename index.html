<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FamLang ‚Äì FR ‚áÑ NL</title>
<style>
  :root{--bg:#0b0b10;--card:#16161e;--text:#eaeaf2;--muted:#a8adbd;--accent:#7cc5ff}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .title{font-weight:800;font-size:1.6rem;text-align:center;margin:10px 0 6px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0 14px}
  input[type=search],select{background:#1d1d28;border:1px solid #2a2a38;color:#e6e6f2;border-radius:10px;padding:10px}
  input[type=search]{flex:1 1 280px;min-width:240px}
  .tabs{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:12px}
  .tab{padding:10px 14px;border-radius:999px;background:#1e1e28;color:#cfd3e6;border:1px solid #2a2a36;cursor:pointer}
  .tab.active{background:var(--accent);color:#001b2a;border-color:transparent}
  .card{background:var(--card);border:1px solid #262634;border-radius:14px;padding:14px;margin:10px 0}
  .lesson{font-size:1.05rem;font-weight:700;margin-bottom:6px}
  .divider{height:1px;background:#262634;margin:10px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
  .fr{font-weight:700;font-size:1.1rem}
  .en{color:#b7bdd0}
  .hint{color:#9aa3b7;font-size:.9rem}
  .muted{color:var(--muted)}
  button{background:#242434;border:1px solid #343446;color:#dfe3f9;padding:8px 12px;border-radius:12px;cursor:pointer}
  button.tonal{background:#1d2a3a;border-color:#29455e}
  button.primary{background:var(--accent);color:#001b2a;border-color:transparent}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#283141;color:#a6ceff;border:1px solid #3a4960;font-size:.8rem;margin-left:6px}
  .lang-toggle{display:flex;gap:6px}
  .lang-toggle button{font-size:1.4rem;background:none;border:2px solid transparent;border-radius:8px;cursor:pointer;padding:2px 6px}
  .lang-toggle button.active{border-color:var(--accent);background:#1d1d28}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">FamLang ‚Äì informell, famili√§r (FR ‚áÑ NL)</div>
  <div class="muted" style="text-align:center;margin-bottom:6px;">Klicke üá´üá∑ oder üá≥üá± oben ‚Äì die App zeigt & spricht die gew√§hlte Sprache.</div>

  <div class="toolbar">
    <input id="q" type="search" placeholder="Suche (FR/NL/DE) ‚Ä¶" />
    <select id="cat"><option value="">Alle Kategorien</option></select>
    <div id="langToggle" class="lang-toggle">
      <button data-lang="fr" title="Franz√∂sisch">üá´üá∑</button>
      <button data-lang="nl" title="Niederl√§ndisch">üá≥üá±</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="today">Heute</div>
    <div class="tab" data-tab="all">Alle</div>
    <div class="tab" data-tab="packs">Packs</div>
  </div>

  <div id="screen"></div>
</div>

<script>
// ---------------- manifest-driven loading ----------------
const MANIFEST_URL = 'data/manifest.json?v=' + Date.now();
let CONTENT = [];       
let allPhrases = [];    
let selectedTab = 'today';
let currentLang = 'nl'; // default
const LANG_TO_TTS = { fr:'fr-FR', nl:'nl-NL' };
const voicesCache = { fr:null, nl:null };

(async function(){
  try{
    const manifest = await (await fetch(MANIFEST_URL)).json();
    const files = manifest.files || manifest;
    const loaded = await Promise.all(files.map(f => fetch('data/'+f+'?v='+Date.now()).then(r=>r.json())));
    CONTENT = loaded;
    initUI();
  }catch(e){
    document.getElementById('screen').innerHTML =
      '<div class="card">Konnte Inhalte nicht laden. Pr√ºfe <code>/data/manifest.json</code>.</div>';
  }
})();

function initUI(){
  allPhrases = CONTENT.flatMap(l => (l.phrases||[]).map(p => ({...p, __cat:l.name})));
  const catSel = document.getElementById('cat');
  CONTENT.forEach(l => {
    const opt = document.createElement('option'); opt.value=l.name; opt.textContent=l.name; catSel.appendChild(opt);
  });
  catSel.onchange = render;

  // Flag toggle
  document.querySelectorAll('#langToggle button').forEach(btn=>{
    btn.onclick=()=>{
      currentLang = btn.dataset.lang; pickVoices(); render();
      document.querySelectorAll('#langToggle button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    };
  });
  document.querySelector(`#langToggle button[data-lang="${currentLang}"]`).classList.add('active');

  document.querySelectorAll('.tab').forEach(t=>{
    t.onclick=()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active'); selectedTab=t.dataset.tab; render();
    };
  });
  document.getElementById('q').oninput = debounce(render,150);

  pickVoices();
  render();
}

function render(){
  const scr=document.getElementById('screen');
  const q=(document.getElementById('q').value||'').trim().toLowerCase();
  const cat=document.getElementById('cat').value||'';
  if(selectedTab==='today'){
    const sample=shuffle(filterPhrases(allPhrases,q,cat)).slice(0,12);
    scr.innerHTML='<div class="card"><div class="lesson">Heute (12 Karten)</div>'+sample.map(phraseCard).join('')+'</div>';
    attachHandlers(); return;
  }
  if(selectedTab==='all'){
    const list=filterPhrases(allPhrases,q,cat);
    scr.innerHTML='<div class="card"><div class="lesson">Alle Phrasen <span class="pill">'+list.length+'</span></div>'+list.map(phraseCard).join('')+'</div>';
    attachHandlers(); return;
  }
  if(selectedTab==='packs'){
    const grouped={};
    CONTENT.forEach(l=>{
      const filtered=filterPhrases((l.phrases||[]).map(p=>({...p,__cat:l.name})), q, cat);
      if(filtered.length) grouped[l.name]=filtered;
    });
    scr.innerHTML=Object.keys(grouped).map(name=>
      `<div class="card"><div class="lesson">${name} <span class="pill">${grouped[name].length}</span></div>${grouped[name].map(phraseCard).join('')}</div>`
    ).join('')||'<div class="card">Keine Treffer.</div>';
    attachHandlers(); return;
  }
}

function phraseCard(p){
  const id=Math.random().toString(36).slice(2);
  const txt=getText(p);
  return `<div class="divider"></div>
    <div class="fr">${escapeHtml(txt)}</div>
    <div class="en">${p.en?escapeHtml(p.en):''}</div>
    <div class="hint">Aussprache: ${p.hint||''} <span class="pill">${p.__cat||''}</span></div>
    <div class="row">
      <button class="play" data-id="${id}" data-text="${escapeHtml(txt)}" data-rate="1">‚ñ∂Ô∏é Abspielen</button>
      <button class="play tonal" data-id="${id}" data-text="${escapeHtml(txt)}" data-rate="0.7">‚èµ Langsam</button>
      <button class="primary speak" data-id="${id}" data-text="${escapeHtml(txt)}">üé§ Nachsprechen</button>
    </div>
    <div class="row"><span class="muted">Erkannt:</span> <span id="rec-${id}" class="muted"></span></div>
    <div class="row"><span class="muted">Treffer:</span> <span id="sc-${id}" class="muted">‚Äì</span></div>`;
}

function getText(p){return p[currentLang]||p.fr||p.nl||'';}
function allTextForSearch(p){return [p.fr||'',p.nl||'',p.en||'',p.hint||'',p.__cat||''].join(' ').toLowerCase();}
function filterPhrases(list,q,cat){return list.filter(p=>{const ok=!cat||p.__cat===cat||p.name===cat;if(!q)return ok;return ok&&allTextForSearch(p).includes(q.toLowerCase());});}

function pickVoices(){const all=speechSynthesis.getVoices();voicesCache.fr=all.find(v=>/fr/i.test(v.lang))||null;voicesCache.nl=all.find
