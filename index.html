<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FamLang ‚Äì informell, famili√§r (FR ‚áÑ DE)</title>
<style>
  :root{
    --bg:#0f1115;--fg:#e8ebf0;--mut:#9aa3b2;--card:#151822;--ring:#2b3246;--chip:#212637;
    --accent:#4ea1ff;--ok:#45d483;--warn:#f6c453;--bad:#ef6b6b;--btn:#232a3d;--btn2:#2b3550;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  .wrap{max-width:960px;margin:18px auto;padding:0 14px}
  h1{margin:8px 0 6px;font-weight:800;letter-spacing:.2px}
  p.lead{color:var(--mut);margin:0 0 16px}
  /* blocks */
  .panel{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:14px;margin:12px 0}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
  /* inputs + pills */
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .input, select, .pill{background:var(--btn);border:1px solid var(--ring);border-radius:14px;color:var(--fg)}
  .input{padding:10px 12px;width:100%;font-size:16px}
  select{padding:10px 12px;font-size:14px}
  .pill{padding:10px 14px;line-height:1;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;min-width:92px}
  .pill[aria-pressed="true"], .pill.active{outline:2px solid var(--accent)}
  .pill.primary{background:var(--btn2)}
  .flag{width:32px;height:22px;border:1px solid var(--ring);border-radius:6px;opacity:.9}
  /* cards */
  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:14px}
  .card .t{font-size:20px;font-weight:800;margin:0 0 6px}
  .card .de{color:var(--mut);margin:0 0 8px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--ring);padding:4px 10px;border-radius:999px;color:var(--mut);font-size:12px}
  .actions{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
  .actions .pill{width:100%}
  .recwrap{display:flex;align-items:center;gap:10px;margin-top:6px}
  .recbtn{background:#2b6146;border:1px solid #224e39;color:#0b1; font-weight:700}
  .bar{height:8px;border-radius:999px;background:#263043;overflow:hidden}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#ef6b6b,#f6c453,#45d483)}
  .scoreline{display:flex;gap:10px;align-items:center;font-size:14px;color:var(--mut)}
  .tokens{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
  .tok{padding:6px 10px;border-radius:999px;border:1px solid var(--ring);background:#232a3a}
  .tok.g{background:#1f3a2c;border-color:#335e49}
  .tok.o{background:#3f3522;border-color:#6e5d38}
  .tok.b{background:#3a2121;border-color:#6b3b3b}
  /* sticky control bar */
  .sticky{position:sticky;bottom:0;left:0;right:0;background:#121520f0;backdrop-filter:blur(6px);border-top:1px solid var(--ring);z-index:50}
  .sticky .row{padding:8px 10px;justify-content:space-between}
  .sticky .pill{min-width:120px}
  .soft{color:var(--mut)}
  /* news list */
  .newsitem{display:flex;align-items:center;justify-content:space-between;gap:10px;background:#10151f;border:1px solid var(--ring);border-radius:12px;padding:10px 12px;margin:8px 0}
  .newsitem .ttl{font-weight:600}
  audio{width:100%;margin-top:6px}
  /* toasts */
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#1c2332;color:#dfe7ff;border:1px solid #2d3b5e;border-radius:12px;padding:10px 14px;z-index:1000;box-shadow:0 6px 22px rgba(0,0,0,.35);font-size:14px}
</style>
</head>
<body>
<div class="wrap">
  <h1>FamLang ‚Äì informell, famili√§r <small style="font-weight:500;color:var(--mut)">(FR ‚áÑ DE)</small></h1>
  <p class="lead">Franz√∂sisch als Hauptsprache, deutsche √úbersetzung als Hilfe. Alles l√§uft lokal im Browser.</p>

  <!-- CONTROL / OVERVIEW -->
  <section class="panel" id="ctrl">
    <h3 style="margin:0 0 10px">Steuerung &amp; √úbersicht</h3>
    <div class="row">
      <input id="q" class="input" placeholder="Suche (FR/DE)‚Ä¶" autocomplete="off">
      <button id="mic" class="pill">Mikrofon</button>
    </div>
    <div class="row" style="margin-top:8px">
      <select id="category"><option value="">Alle Kategorien</option></select>
      <button id="btn-today" class="pill">Heute</button>
      <button id="btn-all" class="pill active">Alle</button>
      <button id="btn-packs" class="pill">Packs</button>
      <button id="tts-toggle" class="pill">Auto-TTS: Aus</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="chip">Heute: <b id="m-today">0</b> Versuche</span>
      <span class="chip">√ò <b id="m-avg">‚Äî</b>% (letzte 10)</span>
      <span class="chip">Tages-Streak: <b id="m-dstreak">0</b>üî•</span>
      <span class="chip">Wochen-Streak: <b id="m-wstreak">0</b>üî•</span>
      <button id="export-log" class="pill">Log exportieren</button>
      <button id="reset-log" class="pill">Log zur√ºcksetzen</button>
    </div>
  </section>

  <!-- NEWS / AUDIO -->
  <section class="panel" id="news">
    <h3 style="margin:0 0 10px">News / Audio auf Franz√∂sisch</h3>
    <div class="row">
      <input id="news-url" class="input" placeholder="MP3/Stream URL (Podcast, Bulletin, FR-Radio) ‚Ä¶">
      <button class="pill primary" id="news-play">‚ñ∫ Play</button>
    </div>
    <div class="row" style="margin-top:6px">
      <button class="pill" id="news-stop">‚ñ† Stop</button>
      <button class="pill" id="news-save">‚òÖ Speichern</button>
      <span class="chip">Geschwindigkeit</span>
      <button class="pill rate" data-r="0.85">0.85√ó</button>
      <button class="pill rate active" data-r="1.0">1.0√ó</button>
      <button class="pill rate" data-r="1.15">1.15√ó</button>
      <button class="pill rate" data-r="1.30">1.30√ó</button>
      <button class="pill" id="news-back20">Letzte 20 s</button>
    </div>
    <audio id="news-audio" controls preload="none"></audio>
    <div id="news-list" style="margin-top:8px"></div>
    <div class="soft" style="margin-top:6px">Hinweis: Die Presets spielen **direkt**. F√ºr eigene Links bitte oben einf√ºgen.</div>
  </section>

  <!-- RESULTS -->
  <section id="results" class="grid" aria-live="polite"></section>
  <div id="empty" class="soft" style="text-align:center;margin:20px 0" hidden>Keine Eintr√§ge gefunden.</div>
</div>

<!-- FLOATING BAR -->
<div class="sticky" id="floatbar">
  <div class="wrap" style="max-width:960px">
    <div class="row">
      <button id="fb-stop" class="pill" style="background:#6b3131">‚ñ† Stop</button>
      <button id="fb-next" class="pill primary">‚ñ∫ N√§chste</button>
      <span class="chip" id="shadow-badge">Shadow inaktiv</span>
      <span class="chip" id="auto-adv">Auto-Advance: <b id="auto-adv-state">An</b></span>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast" style="display:none"></div>

<script>
(() => {
/* ---------- helpers ---------- */
const $ = (s,r=document)=>r.querySelector(s);
const $$= (s,r=document)=>Array.from(r.querySelectorAll(s));
const BASE = new URL('./', location.href);
const urlFor = (p)=> new URL(p, BASE).toString();
const toast = (msg, ms=1400) => {
  const t = $('#toast'); t.textContent = msg; t.style.display='block';
  clearTimeout(toast._h); toast._h = setTimeout(()=>t.style.display='none', ms);
};
const fetchJson = async(p)=>{ const r=await fetch(urlFor(p),{cache:'no-store'}); if(!r.ok) throw new Error('Fetch '+p+' '+r.status); return r.json(); };
const escapeHtml = s=>String(s).replace(/[&<>"]/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

/* ---------- state ---------- */
const S = {
  primary:'fr', secondary:'de', show:'all', category:'', q:'',
  items:[], categories:new Set(), todaySet:new Set(),
  tts:{enabled:false, voices:[], ready:false},
  log: loadLog(),
  autoAdvance:true, shadowing:false,
  news:{rate:1.0}
};

/* ---------- UI wiring ---------- */
$('#btn-today').onclick = ()=>setShow('today');
$('#btn-all').onclick   = ()=>setShow('all');
$('#btn-packs').onclick = ()=>setShow('packs');
$('#tts-toggle').onclick= ()=>{S.tts.enabled=!S.tts.enabled;updateTtsToggle();};

$('#q').addEventListener('input', e=>{ S.q = e.target.value.trim().toLowerCase(); render(); });
$('#category').addEventListener('change', e=>{ S.category = e.target.value; render(); });

/* floating bar */
$('#fb-stop').onclick = ()=>{ stopAll(); window.scrollTo({top:0,behavior:'smooth'}); };
$('#fb-next').onclick = ()=>{ goNext(true); };

/* ---------- load data ---------- */
(async function boot(){
  initTTS(); initSpeechRec();
  updateTtsToggle(); updateMetrics();
  try{
    const manifest = await fetchJson('data/manifest.json');
    const packs = Array.isArray(manifest.packs)?manifest.packs:[];
    S.todaySet = new Set(Array.isArray(manifest.todayPacks)?manifest.todayPacks:[]);
    const names = manifest.categoryNames||{};
    const labels= manifest.categoryLabels||{};
    const settled = await Promise.allSettled(packs.map(async p=>({path:p,raw:await fetchJson(p)})));
    S.items=[]; S.categories=new Set();
    for(const r of settled){
      if(r.status!=='fulfilled') { console.warn(r.reason); continue; }
      const {path,raw} = r.value;
      const rows = Array.isArray(raw)?raw:(Array.isArray(raw?.phrases)?raw.phrases:[]);
      const key  = names[path] || (raw && raw.name) || guessCategory(path);
      const label= labels[key] || key;
      S.categories.add(key);
      rows.forEach((row,idx)=>{
        S.items.push({
          id:`${path}#${idx}`, pack:path, categoryKey:key, categoryLabel:label,
          fr:String(row.fr??''), de:String(row.de ?? row.en ?? ''), hint:String(row.hint ?? ''), date:String(row.date||'')
        });
      });
    }
    buildCategorySelect();
    render();
  }catch(e){ $('#empty').hidden=false; $('#empty').textContent='Fehler beim Laden: '+(e.message||e); }

  buildNews();
})();

function guessCategory(p){const f=p.split('/').pop()||''; return f.replace(/_/g,' ').replace(/\..+$/,'');}
function buildCategorySelect(){
  const sel = $('#category'); const cur=sel.value;
  sel.innerHTML = '<option value="">Alle Kategorien</option>' +
    Array.from(S.categories).sort().map(k=>{
      const any = S.items.find(x=>x.categoryKey===k); const label = any?any.categoryLabel:k;
      return `<option value="${escapeHtml(k)}">${escapeHtml(label)}</option>`;
    }).join('');
  sel.value = cur || '';
}

/* ---------- render ---------- */
function setShow(mode){
  S.show=mode;
  $('#btn-today').classList.toggle('active', mode==='today');
  $('#btn-all').classList.toggle('active', mode==='all');
  $('#btn-packs').classList.toggle('active', mode==='packs');
  render();
}
function render(){
  const list = $('#results'); const empty=$('#empty'); list.innerHTML='';
  let view = S.items.slice();
  if(S.category) view = view.filter(x=>x.categoryKey===S.category);
  if(S.q){
    const q=S.q;
    view = view.filter(x => (x.fr+x.de+x.categoryLabel).toLowerCase().includes(q));
  }
  if(S.show==='today'){
    const todayISO = new Date().toISOString().slice(0,10);
    view = view.filter(x => S.todaySet.size>0 ? S.todaySet.has(x.pack) : (x.date && x.date.startsWith(todayISO)));
  }
  if(!view.length){ empty.hidden=false; return; } else empty.hidden=true;

  const frag = document.createDocumentFragment();
  if(S.show==='packs'){
    view.sort((a,b)=> a.pack.localeCompare(b.pack) || a.id.localeCompare(b.id));
  }
  view.forEach(item=>frag.appendChild(renderCard(item)));
  list.appendChild(frag);
}
function renderCard(item){
  const card = document.createElement('div'); card.className='card'; card.dataset.id=item.id;
  card.innerHTML = `
    <div class="row" style="justify-content:space-between;margin-bottom:6px">
      <span class="chip">${escapeHtml(item.categoryLabel)}</span>
      <span class="chip">${escapeHtml(item.pack.split('/').pop())}</span>
    </div>
    <div class="t">${escapeHtml(item.fr||'')}</div>
    <div class="de">DE: ${escapeHtml(item.de||'')}</div>
    ${item.hint?`<div class="soft">Hinweis: ${escapeHtml(item.hint)}</div>`:''}
    <div class="actions">
      <button class="pill say" data-mode="n">Abspielen</button>
      <button class="pill say" data-mode="s">Langsam</button>
      <button class="pill say" data-mode="ss">Sehr langsam</button>
    </div>
    <div class="recwrap">
      <button class="pill rec recbtn">Aufnehmen</button>
      <div class="scoreline"><b class="pct"> </b><span class="soft" style="display:none">¬∑</span></div>
    </div>
    <div class="tokens" aria-hidden="true"></div>
    <div class="soft" id="understood" style="margin-top:2px"></div>
    <div class="bar" style="margin-top:6px"><i></i></div>
  `;
  /* wire buttons */
  card.querySelectorAll('.say').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const mode = btn.dataset.mode;
      const text = item.fr;
      const rate = mode==='ss'?0.6:(mode==='s'?0.8:1.0);
      speak(text,'fr-FR',rate);
    });
  });
  card.querySelector('.rec').addEventListener('click', ()=> startRecognition(item, card));
  /* shadowing auto TTS on tap */
  card.addEventListener('click', (e)=>{
    if(!S.tts.enabled) return;
    if(e.target.closest('.pill')) return;
    speak(item.fr,'fr-FR',1.0);
  });
  return card;
}

/* ---------- TTS ---------- */
function initTTS(){
  if(!('speechSynthesis' in window)) return;
  const load=()=>{ S.tts.voices=speechSynthesis.getVoices(); S.tts.ready=true; };
  load(); speechSynthesis.onvoiceschanged=load;
}
function pickVoice(lang){
  const want= (lang||'').slice(0,2).toLowerCase();
  const vs=S.tts.voices||[];
  const prefer = v=>/google/i.test(v.name||'');
  return vs.find(v=>prefer(v)&&(v.lang||'').toLowerCase().startsWith(want)) ||
         vs.find(v=>(v.lang||'').toLowerCase().startsWith(want)) || null;
}
function speak(text, lang, rate=1){
  if(!text) return;
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text); const v=pickVoice(lang);
    if(v){ u.voice=v; u.lang=v.lang; } else u.lang=lang;
    u.rate=rate; u.pitch=1;
    setTimeout(()=>speechSynthesis.speak(u), 80);
  }catch(e){ console.warn(e); }
}
function updateTtsToggle(){
  const b=$('#tts-toggle'); b.setAttribute('aria-pressed', S.tts.enabled); b.textContent = S.tts.enabled ? 'Auto-TTS: An' : 'Auto-TTS: Aus';
}

/* ---------- Speech Recognition (record + score) ---------- */
function initSpeechRec(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ $('#mic').disabled = true; $('#mic').title='Spracherkennung nicht verf√ºgbar'; return; }
  let micActive=false; const rec = new SR(); rec.interimResults=false; rec.continuous=false;
  $('#mic').addEventListener('click', ()=>{
    if(micActive){ rec.stop(); return; }
    rec.lang='fr-FR'; micActive=true; $('#mic').textContent='Stoppen'; try{ rec.start(); }catch{}
  });
  rec.onresult = (e)=>{
    const t = Array.from(e.results).map(r=>r[0].transcript).join(' ');
    $('#q').value=t; S.q=t.toLowerCase(); render();
  };
  rec.onerror = rec.onend = ()=>{ micActive=false; $('#mic').textContent='Mikrofon'; };
}

function startRecognition(item, card){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) { alert('Spracherkennung nicht unterst√ºtzt'); return; }
  const rec = new SR(); rec.lang='fr-FR'; rec.interimResults=false; rec.continuous=false;
  const pctEl = card.querySelector('.pct'); const bar = card.querySelector('.bar>i');
  const tokensEl = card.querySelector('.tokens'); const understoodEl = card.querySelector('#understood');
  pctEl.textContent='Aufnahme‚Ä¶';
  try{ rec.start(); }catch{}
  rec.onresult = (e)=>{
    const said = Array.from(e.results).map(r=>r[0].transcript).join(' ');
    understoodEl.textContent = 'Verstanden:  ' + said;
    const score = scorePron(item.fr, said, tokensEl);
    pctEl.textContent = score+'%';
    bar.style.width = clamp(score,0,100)+'%';
    saveAttempt(score);
  };
  rec.onerror = ()=>{ pctEl.textContent='Fehler'; };
  rec.onend   = ()=>{ if(pctEl.textContent==='Aufnahme‚Ä¶') pctEl.textContent='‚Äì'; if(S.autoAdvance) autoAfterRecord(card); };
}
function tokenize(s){ return String(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z√†√¢√ß√©√®√™√´√Æ√Ø√¥√ª√π√º√ø≈ì'\- ]/gi,' ').replace(/\s+/g,' ').trim().split(' '); }
function scorePron(expect, said, tokensEl){
  const expT = tokenize(expect), saidT = tokenize(said);
  tokensEl.innerHTML='';
  let good=0;
  expT.forEach((w,i)=>{
    const m = saidT[i] || '';
    const ok = levenshtein(w,m) <= Math.max(1, Math.floor(w.length*0.34));
    if(ok) good++;
    const span = document.createElement('span'); span.className='tok '+(ok?'g':(m? 'o':'b')); span.textContent = w; tokensEl.appendChild(span);
  });
  return Math.round((good/Math.max(1,expT.length))*100);
}
function levenshtein(a,b){
  const m=a.length,n=b.length; const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const c=a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+c); } }
  return dp[m][n];
}

/* ---------- Auto-advance ---------- */
function goNext(startTts){
  const cards = $$('.card'); if(!cards.length) return;
  const y = window.scrollY, next = cards.find(c => c.getBoundingClientRect().top + window.scrollY - 6 > y + 10) || cards[0];
  next.scrollIntoView({behavior:'smooth',block:'center'});
  if(startTts){ const t = next.querySelector('.t')?.textContent || ''; if(t) speak(t,'fr-FR', S.shadowing?0.9:1.0); }
}
function stopAll(){ try{ speechSynthesis.cancel(); }catch{}; $('#shadow-badge').textContent = 'Shadow inaktiv'; S.shadowing=false; }
function autoAfterRecord(card){
  // wait a moment to let the user see result
  setTimeout(()=>{ goNext(true); }, 800);
}

/* ---------- Logging / streaks ---------- */
function loadLog(){ try{ return JSON.parse(localStorage.getItem('famlog')||'{}'); }catch{ return {}; } }
function saveLog(){ localStorage.setItem('famlog', JSON.stringify(S.log)); }
function todayKey(){ const d=new Date(); return d.toISOString().slice(0,10); }
function weekKey(){ const d=new Date(); const oneJan=new Date(d.getFullYear(),0,1); const w=Math.ceil((((d-oneJan)/86400000)+oneJan.getDay()+1)/7); return d.getFullYear()+'-W'+w; }
function saveAttempt(score){
  const k=todayKey(); if(!S.log[k]) S.log[k]=[];
  S.log[k].push({ts:Date.now(),score:clamp(score,0,100)});
  saveLog(); updateMetrics();
}
function updateMetrics(){
  const k=todayKey(); const arr=S.log[k]||[]; $('#m-today').textContent=arr.length;
  const last10 = arr.slice(-10).map(x=>x.score); const avg = last10.length?Math.round(last10.reduce((a,b)=>a+b)/last10.length):'‚Äî';
  $('#m-avg').textContent = avg;

  // daily streak: count consecutive days with at least 1 entry
  let d = new Date(); let streak=0;
  for(;;){
    const dk = d.toISOString().slice(0,10);
    if(Array.isArray(S.log[dk]) && S.log[dk].length>0){ streak++; d.setDate(d.getDate()-1); } else break;
  }
  $('#m-dstreak').textContent = streak;

  // weekly streak: weeks with any entry, backward
  let ws=0, wSeen=true, i=0;
  while(wSeen && i<26){
    const now=new Date(); now.setDate(now.getDate()-7*i);
    const wk = (function(d){ const oneJan=new Date(d.getFullYear(),0,1); const w=Math.ceil((((d-oneJan)/86400000)+oneJan.getDay()+1)/7); return d.getFullYear()+'-W'+w; })(now);
    const has = Object.keys(S.log).some(k=>k.startsWith(wk.split('-')[0]) && weekKeyOfDate(new Date(k))===wk);
    if(has){ ws++; i++; } else wSeen=false;
  }
  $('#m-wstreak').textContent = ws;
}
function weekKeyOfDate(d){ const oneJan=new Date(d.getFullYear(),0,1); const w=Math.ceil((((d-oneJan)/86400000)+oneJan.getDay()+1)/7); return d.getFullYear()+'-W'+w; }
$('#export-log').onclick = ()=>{
  const blob = new Blob([JSON.stringify(S.log,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'famlang_log.json'; a.click();
};
$('#reset-log').onclick = ()=>{ if(confirm('Log wirklich l√∂schen?')){ S.log={}; saveLog(); updateMetrics(); } };

/* ---------- News / Audio ---------- */
function buildNews(){
  // Presets (direct-play)
  const presets = [
    {ttl:'RFI Monde ‚Äì Live (Nachrichten/Talk)', url:'https://rfimonde64k.ice.infomaniak.ch/rfimonde-64.mp3',
      pods:[['Podcast-√úbersicht','https://www.rfi.fr/fr/podcasts/']]},
    {ttl:'franceinfo ‚Äì Live (24/7 Nachrichten)', url:'https://icecast.radiofrance.fr/franceinfo-midfi.mp3',
      pods:[['Podcasts √∂ffnen','https://www.radiofrance.fr/franceinfo/podcasts']]},
    {ttl:'France Inter ‚Äì Live (Allgemein)', url:'https://icecast.radiofrance.fr/franceinter-midfi.mp3',
      pods:[['Podcasts √∂ffnen','https://www.radiofrance.fr/franceinter/podcasts']]},
    {ttl:'France Culture ‚Äì Live (Kultur)', url:'https://icecast.radiofrance.fr/franceculture-midfi.mp3',
      pods:[['Podcasts √∂ffnen','https://www.radiofrance.fr/franceculture/podcasts']]},
    {ttl:'RTL ‚Äì Live (G√©n√©raliste)', url:'https://streaming.radio.rtl.fr/rtl-1-44-128', pods:[]}
  ];
  const list = $('#news-list'); list.innerHTML='';
  presets.forEach(p=>{
    const row = document.createElement('div'); row.className='newsitem';
    row.innerHTML = `<div class="ttl">${escapeHtml(p.ttl)}</div>
      <div class="row" style="gap:8px">
        <button class="pill primary">‚ñ∫ Play</button>
        ${p.pods.map(([t,u])=>`<a class="pill" href="${u}" target="_blank" rel="noopener">Podcasts √∂ffnen</a>`).join('')}
      </div>`;
    row.querySelector('button').addEventListener('click', ()=> newsPlay(p.url));
    list.appendChild(row);
  });

  // controls
  $('#news-play').onclick = ()=>{ const u=$('#news-url').value.trim(); if(!u) return toast('Bitte URL einf√ºgen'); newsPlay(u); };
  $('#news-stop').onclick = ()=> newsStop();
  $('#news-save').onclick = ()=>{ const u=$('#news-url').value.trim(); if(!u) return; localStorage.setItem('newsCustom', u); toast('Gespeichert'); };
  const saved = localStorage.getItem('newsCustom'); if(saved) $('#news-url').value = saved;
  $$('.rate').forEach(b=> b.addEventListener('click',()=>{ $$('.rate').forEach(x=>x.classList.remove('active')); b.classList.add('active'); S.news.rate = parseFloat(b.dataset.r)||1; const a=$('#news-audio'); a.playbackRate=S.news.rate; }));
  $('#news-back20').onclick = ()=>{ const a=$('#news-audio'); try{ a.currentTime = Math.max(0, (a.currentTime||0)-20); }catch{} };
}
function newsPlay(url){
  const a = $('#news-audio');
  try{
    a.pause(); a.src = url; a.volume = 1.0; a.load(); a.playbackRate = S.news.rate || 1;
    const started = a.play();
    if(started?.then){ started.then(()=>toast('‚ñ∂Ô∏è Wiedergabe gestartet')).catch(err=>toast('‚ùå Play blockiert: '+(err?.message||err))); }
    else toast('‚ñ∂Ô∏è Wiedergabe gestartet');
  }catch(e){ toast('‚ùå Konnte nicht abspielen: '+(e.message||e)); }
}
function newsStop(){ const a=$('#news-audio'); try{ a.pause(); }catch{} }

/* audio diagnostics */
(function wireAudioEvents(){
  const a=$('#news-audio'); if(!a) return;
  const say= m=>toast(m,1200);
  a.addEventListener('playing', ()=>say('üîä Spielt'));
  a.addEventListener('waiting', ()=>say('‚è≥ Puffern‚Ä¶'));
  a.addEventListener('stalled', ()=>say('‚ö†Ô∏è Stream stockt'));
  a.addEventListener('suspend', ()=>say('‚ÑπÔ∏è Lade angehalten'));
  a.addEventListener('ended', ()=>say('‚èπÔ∏è Ende'));
  a.addEventListener('error', ()=>{
    const err=a.error; let msg='Unbekannter Fehler';
    if(err){ const codes={1:'Abgebrochen',2:'Netzwerkfehler',3:'Datenfehler',4:'Nicht unterst√ºtzt'}; msg=codes[err.code]||('Code '+err.code); }
    say('‚ùå Audio-Fehler: '+msg);
  });
})();

})(); 
</script>
</body>
</html>
