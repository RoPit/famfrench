<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FamLang – informell, familiär (FR ⇄ DE)</title>
<style>
  :root{
    --bg:#0f1115;--fg:#e8ebf0;--muted:#9aa3b2;--card:#151822;--chip:#232738;--ring:#2b3246;
    --accent:#5aa9ff;--ok:#45d483;--warn:#e6b84a;--bad:#e06b6b;--ink:#081217;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;overflow-x:hidden}

  /* container */
  .wrap{max-width:980px;margin:20px auto;padding:0 16px}

  /* header */
  header h1{margin:0;font-weight:800;letter-spacing:.3px}
  header small{color:var(--muted);font-weight:600}
  header p{margin:8px 0 0;color:var(--muted)}

  /* collapsible control panel */
  #controls{margin-top:14px;border:1px solid var(--ring);background:var(--card);border-radius:14px}
  #controls .controls-header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid var(--ring)}
  #controls .controls-title{display:flex;gap:10px;align-items:center;flex:1;min-width:0}
  #controls .controls-actions{display:flex;gap:8px;align-items:center}
  #controls .controls-body{padding:12px}
  .toggle{border:1px solid var(--ring);background:var(--chip);color:var(--fg);border-radius:12px;padding:8px 12px;font-weight:700;cursor:pointer;white-space:nowrap}
  #controls.collapsed .controls-body{display:none}
  #controls.collapsed .toggle[data-for="controls"]::after{content:" anzeigen"}
  #controls:not(.collapsed) .toggle[data-for="controls"]::after{content:" ausblenden"}

  /* responsive top grid (prevents horizontal overflow) */
  .top-grid{
    display:grid;gap:10px;
    grid-template-columns: 1fr; /* stack on phones */
  }
  @media (min-width:720px){
    .top-grid{grid-template-columns: 1fr auto;} /* search left, quick actions right */
  }

  .search{display:flex;gap:8px;align-items:center;background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:10px 12px;width:100%}
  .search input{flex:1;background:transparent;border:0;outline:none;color:var(--fg);font-size:17px;min-height:40px}

  .quick-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .filters{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 4px}
  select,button{background:var(--chip);color:var(--fg);border:1px solid var(--ring);border-radius:14px;padding:10px 14px;font-size:14px;cursor:pointer;min-height:40px}
  button[aria-pressed="true"]{outline:2px solid var(--accent)}
  .chip-mini{padding:4px 8px;border:1px solid var(--ring);border-radius:999px;background:#202638;font-size:12px;white-space:nowrap}

  /* coach & daily */
  #coach{display:grid;gap:10px;margin:8px 0}
  #problems{display:flex;gap:8px;flex-wrap:wrap}
  .wchip{padding:8px 12px;border-radius:999px;border:1px solid var(--ring);background:#202638}
  .wchip.bad{background:#3b1c1c;border-color:#6e2e2e}
  .wchip.mid{background:#3b3417;border-color:#6e6126}

  #daily{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:12px;margin:10px 0}
  #daily .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  #daily .meter{height:10px;border-radius:8px;background:#2a2f3f;border:1px solid var(--ring);overflow:hidden;margin-top:8px}
  #daily .meter>span{display:block;height:100%;background:linear-gradient(90deg,var(--bad),#e39f3a,var(--ok));width:0%}

  /* list */
  .grid{display:grid;grid-template-columns:1fr;gap:14px;margin:14px 0 40px}
  @media (min-width:720px){.grid{grid-template-columns:1fr 1fr}}

  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.25)}
  .cat{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--ring);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .top{justify-content:space-between;margin-bottom:6px}
  .txt-main{font-size:20px;margin:6px 0 2px;font-weight:800}
  .txt-sub{font-size:16px;margin:2px 0;color:#d7dbef}
  .txt-de{font-size:13px;margin:6px 0 10px;color:var(--muted)}
  .empty{margin:24px 0;color:var(--muted);text-align:center}

  .legend{display:flex;gap:14px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;vertical-align:middle;margin-right:6px}
  .ok{background:var(--ok)} .mid{background:var(--warn)} .bad{background:var(--bad)}

  .chips{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 8px}
  .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--ring);background:#202638;font-weight:700}
  .chip.ok{background:#173628;border-color:#245e3f}
  .chip.mid{background:#3b3417;border-color:#6e6126}
  .chip.bad{background:#3b1c1c;border-color:#6e2e2e}
  .chip.miss{background:#263045;border-color:#3a4a6b}

  .ipa{font-family:serif;font-style:italic;color:#cfe;padding-top:4px}
  .syl{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .syl .s{padding:4px 8px;border-radius:10px;border:1px solid var(--ring);background:#202638;cursor:pointer}

  .meter{height:10px;border-radius:8px;background:#2a2f3f;border:1px solid var(--ring);overflow:hidden}
  .meter>span{display:block;height:100%;background:linear-gradient(90deg,var(--bad),#e39f3a,var(--ok));width:0%}

  .heard{border:1px dashed var(--ring);background:#121724;border-radius:12px;padding:12px;margin:6px 0 10px}
  .heard h5{margin:0 0 6px;font-size:14px;color:var(--muted)}
  .heard .text{font-size:16px}
  .heard .sub{color:var(--muted);font-size:13px;margin-top:4px}

  .statsline{color:var(--muted);font-size:13px;margin:8px 0 6px}

  .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  @media (min-width:520px){ .actions{grid-template-columns:repeat(4,1fr)} }
  .btn{border-radius:14px;border:1px solid var(--ring);background:var(--chip);padding:12px 10px;font-weight:700;text-align:center}
  .btn:hover{filter:brightness(1.05)}
  .btn:active{transform:scale(.98)}

  .record-wrap{margin-top:10px}
  .btn-record{width:100%;border-radius:14px;border:0;padding:14px 12px;font-weight:900;letter-spacing:.2px;text-align:center}
  .btn-record.ready{background:#2dd4bf;color:var(--ink)}
  .btn-record.recording{background:#e26666;color:#fff}
  .btn-record.disabled{background:#444;color:#999;cursor:not-allowed}

  .pack-title{grid-column:1/-1;margin:6px 0 2px;color:var(--muted);font-weight:600}
  #load-warn{margin:10px 0;padding:10px;border:1px solid #8b5;border-radius:10px;background:#1b2620;color:#cde;font-size:13px}

  /* floating bar */
  .floatbar{
    position:fixed; right:12px; bottom:12px; z-index:9999;
    display:flex; gap:8px; align-items:center;
    background:rgba(21,24,34,.92); border:1px solid var(--ring); border-radius:14px;
    padding:8px; backdrop-filter:saturate(120%) blur(6px)
  }
  .floatbar .fbtn{border:1px solid var(--ring); background:var(--chip); color:var(--fg); border-radius:12px; padding:10px 12px; font-weight:800; cursor:pointer}
  .floatbar .stop{background:#e26666;color:#fff}
  .floatbar .next{background:#2dd4bf;color:#081217}
  .floatbar small{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>FamLang – informell, familiär <small>(FR ⇄ DE)</small></h1>
    <p>Französisch als Hauptsprache, deutsche Übersetzung als Hilfe. Alles läuft als Einzeldatei und ist GitHub-Pages-sicher.</p>
  </header>

  <!-- controls -->
  <section id="controls" class="collapsed">
    <div class="controls-header">
      <div class="controls-title">
        <strong>Steuerung & Übersicht</strong>
        <span id="top-summary" class="chip-mini">Heute: <span id="sum-attempts">0</span> · Ø <span id="sum-avg">0</span>% · Streak <span id="sum-streak">0🔥</span></span>
      </div>
      <div class="controls-actions">
        <button class="toggle" data-for="controls" id="controls-toggle">Steuerung</button>
      </div>
    </div>

    <div class="controls-body">
      <!-- top line: search + quick buttons; stacks on phones -->
      <div class="top-grid">
        <div class="search" role="search">
          <input id="q" type="search" placeholder="Suche (FR/DE)…" autocomplete="off" />
          <button id="mic" class="toggle" title="Spracherkennung starten/stoppen">Mikrofon</button>
        </div>
        <div class="quick-actions">
          <button id="start-sr" class="toggle">SR-Session starten</button>
          <button id="toggle-shadow" class="toggle" aria-pressed="false">Shadowing: Aus</button>
        </div>
      </div>

      <div class="filters">
        <select id="category"><option value="">Alle Kategorien</option></select>
        <button id="show-today" class="toggle" aria-pressed="false">Heute</button>
        <button id="show-all" class="toggle" aria-pressed="true">Alle</button>
        <button id="show-packs" class="toggle" aria-pressed="false">Packs</button>
        <button id="tts-toggle" class="toggle" aria-pressed="false" title="Vorlesen beim Antippen aktivieren/deaktivieren">Auto-TTS: Aus</button>
        <span id="due-count" class="chip-mini">0 fällig</span>
      </div>

      <div id="coach">
        <div id="problems" hidden></div>
      </div>

      <div id="daily" hidden>
        <div class="row">
          <strong>Heute:</strong>
          <span id="d-attempts">0 Versuche</span> ·
          <span id="d-average">Ø 0%</span> ·
          <span id="d-target">Ziel: 30</span>
          <span class="chip-mini" id="streak-day">Tages-Streak: 0🔥</span>
          <span class="chip-mini" id="streak-week">Wochen-Streak: 0🔥</span>
        </div>
        <div class="meter" aria-label="Tagesziel Fortschritt"><span id="d-meter" style="width:0%"></span></div>
        <div class="row" style="margin-top:10px">
          <button id="export-log" class="toggle">Log exportieren</button>
          <button id="reset-log" class="toggle">Log zurücksetzen</button>
        </div>
      </div>
    </div>
  </section>

  <div id="load-warn" hidden></div>

  <div id="results" class="grid" aria-live="polite"></div>
  <div id="empty" class="empty" hidden>Keine Einträge gefunden.</div>
</div>

<!-- floating controls -->
<div class="floatbar" id="floatbar" hidden>
  <button class="fbtn stop" id="fb-stop">◼ Stop</button>
  <button class="fbtn next" id="fb-next">▶ Nächste</button>
  <small id="fb-status">Shadow aktiv</small>
</div>

<script>
(()=>{
/* ======= config ======= */
const TARGET_DAILY_ATTEMPTS=30;
const STORAGE_KEY='famlang_logs_v1';
const SR_KEY='famlang_sr_v1';
const PREFS_KEY='famlang_prefs_v1';
const SHADOW_GAP_AFTER_FAST=1500, SHADOW_GAP_AFTER_SLOW=3500;
const LEN_MULT_FAST=40, LEN_MULT_SLOW=60, SHOW_RESULT_MS=2500;

/* ======= utils ======= */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const BASE=new URL('./',location.href);
const urlFor=p=>new URL(p,BASE).toString();
const fetchJson=async p=>{const r=await fetch(urlFor(p),{cache:'no-store'});if(!r.ok) throw new Error(`Fetch failed ${p}: ${r.status}`);return r.json();};
const escHtml=s=>String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const escAttr=s=>escHtml(s).replace(/`/g,'&#96;');
const todayStr=()=>new Date().toISOString().slice(0,10);
const smoothTop=()=>scrollTo({top:0,behavior:'smooth'});

/* ======= state ======= */
const state={show:'all',category:'',q:'',items:[],categories:new Set(),todaySet:new Set(),
  tts:{enabled:false,voices:[],ready:false,pref:'google'},logs:[],sr:{},srQueue:[],
  shadow:false,shadowRunning:false,shadowCurrent:null,prefs:{collapsedControls:true}
};
let manifestOrder=[], shadowTimers=[], activeRecognizer=null;

/* ======= prefs ======= */
function loadPrefs(){try{Object.assign(state.prefs,JSON.parse(localStorage.getItem(PREFS_KEY)||'{}'));}catch{}}
function writePrefs(){try{localStorage.setItem(PREFS_KEY,JSON.stringify(state.prefs));}catch{}}

/* ======= TTS ======= */
function pickVoiceFor(lang){
  const want=(lang||'').slice(0,2).toLowerCase(); const vs=state.tts.voices||[];
  const isG=v=>/google/i.test(v.name||''); const isS=v=>/samsung/i.test(v.name||'');
  const starts=v=>(v.lang||'').toLowerCase().startsWith(want); const inc=v=>(v.lang||'').toLowerCase().includes(want);
  return vs.find(v=>isG(v)&&starts(v))||vs.find(v=>isG(v)&&inc(v))||vs.find(v=>!isS(v)&&starts(v))||vs.find(v=>starts(v))||null;
}
function speak(text,rate=1){ if(!text||!text.trim()) return;
  try{ speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text);
    const v=pickVoiceFor('fr-FR'); if(v){u.voice=v;u.lang=v.lang||'fr-FR';} else u.lang='fr-FR';
    u.rate=rate; u.pitch=1; setTimeout(()=>speechSynthesis.speak(u),80);
  }catch(e){console.error(e);}
}
function initTTS(){ if(!('speechSynthesis' in window)) return;
  const load=()=>{state.tts.voices=speechSynthesis.getVoices(); state.tts.ready=true;};
  load(); speechSynthesis.onvoiceschanged=load;
}
function updateTtsToggle(){ const b=$('#tts-toggle'); b.setAttribute('aria-pressed',state.tts.enabled); b.textContent=state.tts.enabled?'Auto-TTS: An':'Auto-TTS: Aus'; }

/* ======= Mic (search) ======= */
function initMic(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition; const mic=$('#mic');
  if(!SR){mic.disabled=true; mic.title='Spracherkennung nicht verfügbar'; return;}
  let on=false; const rec=new SR(); rec.lang='fr-FR'; rec.interimResults=false; rec.continuous=false;
  mic.addEventListener('click',()=>{ if(on){try{rec.stop();}catch{};return;} on=true; mic.textContent='Stoppen'; try{rec.start();}catch{}; });
  const reset=()=>{on=false; mic.textContent='Mikrofon';};
  rec.onresult=e=>{ const t=Array.from(e.results).map(r=>r[0].transcript).join(' '); $('#q').value=t; state.q=t.toLowerCase(); render(); };
  rec.onerror=reset; rec.onend=reset;
}

/* ======= Logs & stats ======= */
function loadLogs(){try{state.logs=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch{state.logs=[]}}
function writeLogs(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(state.logs))}catch{}}
function saveLog(e){state.logs.push(e);writeLogs()}
function getPhraseStats(id){ const a=state.logs.filter(x=>x.id===id).sort((x,y)=>y.tsISO.localeCompare(x.tsISO));
  const last=a[0]?.score??null; const avg=a.slice(0,10).reduce((s,x)=>s+x.score,0)/(a.slice(0,10).length||1);
  return {last:last!=null?Math.round(last):null, avg10:a.length?Math.round(avg):null, count:a.length};
}
function getDailyStats(){ const d=todayStr(); const arr=state.logs.filter(x=>x.day===d);
  const attempts=arr.length, avg=attempts?Math.round(arr.reduce((s,x)=>s+x.score,0)/attempts):0;
  const pct=Math.min(100,Math.round((attempts/TARGET_DAILY_ATTEMPTS)*100)); return {attempts,avg,pct,target:TARGET_DAILY_ATTEMPTS};
}
function isoWeek(d){d=new Date(d); const wd=d.getDay()||7; d.setDate(d.getDate()+4-wd); const y=new Date(d.getFullYear(),0,1);
  return d.getFullYear()+'-W'+String(Math.ceil((((d-y)/86400000)+1)/7)).padStart(2,'0');}
function getDailyStreak(){ const days=new Set(state.logs.map(l=>l.day)); let s=0, d=new Date();
  for(;;){const iso=d.toISOString().slice(0,10); if(days.has(iso)){s++; d.setDate(d.getDate()-1);} else break;} return s;}
function getWeeklyStreak(){ const weeks=new Set(state.logs.map(l=>isoWeek(l.day))); let s=0, d=new Date(); const wd=d.getDay()||7; d.setDate(d.getDate()-(wd-1));
  for(;;){const key=isoWeek(d.toISOString()); if(weeks.has(key)){s++; d.setDate(d.getDate()-7);} else break;} return s;}
function refreshDailyBox(){
  const {attempts,avg,pct,target}=getDailyStats();
  $('#d-attempts').textContent=`${attempts} Versuche`; $('#d-average').textContent=`Ø ${avg}%`; $('#d-target').textContent=`Ziel: ${target}`;
  $('#d-meter').style.width=pct+'%'; $('#streak-day').textContent=`Tages-Streak: ${getDailyStreak()}🔥`; $('#streak-week').textContent=`Wochen-Streak: ${getWeeklyStreak()}🔥`;
  $('#sum-attempts').textContent=attempts; $('#sum-avg').textContent=avg; $('#sum-streak').textContent=getDailyStreak()+'🔥';
  $('#daily').hidden=false;
}

/* ======= Problems ======= */
function normalize(s){return String(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9\s']/g,' ').replace(/\s+/g,' ').trim()}
function lev(a,b){const m=a.length,n=b.length,dp=Array.from({length:m+1},()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++)dp[i][0]=i; for(let j=0;j<=n;j++)dp[0][j]=j;
  for(let i=1;i<=m;i++){for(let j=1;j<=n;j++){const c=a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+c)}} return dp[m][n]}
function wScore(a,b){const A=normalize(a),B=normalize(b); if(!A&&!B) return 100; const d=lev(A,B); const M=Math.max(A.length,B.length)||1; return Math.round((1-d/M)*100)}
function computeProblemWords(){
  const day=todayStr(), arr=state.logs.filter(x=>x.day===day&&x.said), map={};
  arr.forEach(e=>{ const exp=normalize(e.exp).split(' ').filter(Boolean), said=normalize(e.said).split(' ').filter(Boolean);
    exp.forEach(w=>{let best=0; for(const s of said) best=Math.max(best,wScore(w,s)); (map[w]??={sum:0,count:0}).sum+=best; map[w].count++;});
  });
  const bad=Object.entries(map).map(([w,o])=>({w,avg:Math.round(o.sum/o.count),c:o.count})).filter(x=>x.c>=2&&x.avg<60).sort((a,b)=>a.avg-b.avg).slice(0,20);
  const box=$('#problems'); box.innerHTML=''; if(!bad.length){box.hidden=true;return;}
  bad.forEach(({w,avg})=>{
    const btn=document.createElement('button'); btn.className='wchip '+(avg<40?'bad':'mid'); btn.textContent=`${w} · ${avg}%`;
    btn.addEventListener('click',()=>speak(w,0.8)); box.appendChild(btn);
  });
  box.hidden=false;
}

/* ======= SR SM-2 ======= */
function loadSR(){try{state.sr=JSON.parse(localStorage.getItem(SR_KEY)||'{}')}catch{state.sr={}}}
function writeSR(){try{localStorage.setItem(SR_KEY,JSON.stringify(state.sr))}catch{}}
function ensureSR(id){return state.sr[id]||(state.sr[id]={ease:2.5,interval:0,due:todayStr(),reps:0,lapses:0,last:null});}
function qFromP(p){return p>=90?5:p>=80?4:p>=65?3:p>=50?2:p>=35?1:0}
function addDays(iso,d){const t=new Date(iso); t.setDate(t.getDate()+d); return t.toISOString().slice(0,10)}
function updateSRFor(id,percent){const q=qFromP(percent), s=ensureSR(id); let ease=s.ease+(0.1-(5-q)*(0.08+(5-q)*0.02)); ease=Math.max(1.3,Math.min(2.8,ease));
  let interval=s.interval, reps=s.reps; if(q<3){reps=0; interval=1; s.lapses=(s.lapses||0)+1;} else {reps+=1; interval=reps===1?1:reps===2?6:Math.round(interval*ease);}
  Object.assign(s,{ease,interval,reps,due:addDays(todayStr(),interval||1),last:todayStr()}); writeSR(); rebuildSRQueue();}
function rebuildSRQueue(){const today=todayStr(); const due=[]; state.items.forEach(x=>{const s=ensureSR(x.id); if((s.due||today)<=today) due.push({id:x.id,reps:s.reps,ease:s.ease});});
  due.sort((a,b)=>(a.reps-b.reps)||(a.ease-b.ease)); state.srQueue=due.map(x=>x.id); $('#due-count').textContent=state.srQueue.length+' fällig';}

/* ======= Shadow control ======= */
function clearShadowTimers(){shadowTimers.forEach(id=>clearTimeout(id)); shadowTimers=[]; try{speechSynthesis.cancel();}catch{}}
function stopActiveRecognition(){ if(activeRecognizer){try{activeRecognizer.stop();}catch{}; activeRecognizer=null; } }
function shadowStopAll(scrollTop=true){ clearShadowTimers(); stopActiveRecognition();
  $$('.shadow[data-running="true"]').forEach(b=>{b.removeAttribute('data-running'); b.textContent='Shadow ▶'; b.classList.remove('recording');});
  state.shadowRunning=false; state.shadowCurrent=null; $('#floatbar').hidden=true; if(scrollTop) smoothTop(); }

/* ======= data & render ======= */
async function loadAll(){
  try{
    const manifest=await fetchJson('data/manifest.json');
    const packs=Array.isArray(manifest.packs)?manifest.packs:[]; state.todaySet=new Set(Array.isArray(manifest.todayPacks)?manifest.todayPacks:[]);
    const names=manifest.categoryNames||{}, labels=manifest.categoryLabels||{}; manifestOrder=Array.isArray(manifest.categoryOrder)?manifest.categoryOrder:[];
    const settled=await Promise.allSettled(packs.map(async p=>({path:p,raw:await fetchJson(p)})));
    state.items=[]; state.categories=new Set(); const failed=[];
    for(const r of settled){
      if(r.status!=='fulfilled'){failed.push(String(r.reason?.message||r.reason||'unbekannt')); continue;}
      const {path,raw}=r.value; const rows=Array.isArray(raw)?raw:(Array.isArray(raw?.phrases)?raw.phrases:[]); const key=names[path]||raw?.name||guessCategory(path);
      const label=labels[key]||key; state.categories.add(key);
      rows.forEach((row,idx)=>state.items.push({id:`${path}#${idx}`,categoryKey:key,categoryLabel:label,fr:String(row.fr??''),de:String(row.de??row.en??''),hint:String(row.hint??''),ipa:row.ipa?String(row.ipa):'',syllables:Array.isArray(row.syllables)?row.syllables.map(String):[],pack:path,date:String(row.date||'')}));
    }
    buildCategorySelect(); render(); showLoadReport(failed);
  }catch(e){ showError(e); }
}
function guessCategory(p){const f=p.split('/').pop(); return (f||'').replace(/_/g,' ').replace(/\..+$/,'')}
function buildCategorySelect(){const sel=$('#category'),cur=sel.value; const keys=[...state.categories];
  const ordered=[...manifestOrder.filter(k=>keys.includes(k)),...keys.filter(k=>!manifestOrder.includes(k)).sort()];
  sel.innerHTML='<option value="">Alle Kategorien</option>'+ordered.map(k=>{const any=state.items.find(x=>x.categoryKey===k);const label=any?any.categoryLabel:k;return `<option value="${escHtml(k)}">${escHtml(label)}</option>`}).join(''); sel.value=cur||''}
function showLoadReport(f){const el=$('#load-warn'); if(!f.length){el.hidden=true;el.textContent='';return;} el.hidden=false; el.innerHTML='⚠️ Dateien konnten nicht geladen werden: '+f.map(s=>`<code>${escHtml(s)}</code>`).join(', ')+'.';}
function showError(err){$('#empty').hidden=false;$('#empty').textContent='Fehler: '+(err?.message||err);console.error(err);}
function render(){
  const list=$('#results'), empty=$('#empty'); list.innerHTML='';
  let view=[...state.items];
  if(state.category) view=view.filter(x=>x.categoryKey===state.category);
  if(state.q){const q=state.q; view=view.filter(x=>(x.fr+' '+x.de).toLowerCase().includes(q)||(x.categoryLabel||'').toLowerCase().includes(q));}
  if(state.show==='today'){const t=todayStr(); view=view.filter(x=>state.todaySet.size?state.todaySet.has(x.pack):(x.date&&x.date.startsWith(t)));}
  if(!view.length){empty.hidden=false;return;} empty.hidden=true;
  const frag=document.createDocumentFragment();
  if(state.show==='packs'){view.sort((a,b)=>a.pack.localeCompare(b.pack)||a.id.localeCompare(b.id)); let cur=''; for(const it of view){ if(it.pack!==cur){cur=it.pack; const h=document.createElement('h3'); h.className='pack-title'; h.textContent=it.pack.split('/').pop(); frag.appendChild(h);} renderCard(frag,it);} }
  else view.forEach(it=>renderCard(frag,it));
  list.appendChild(frag); refreshDailyBox(); rebuildSRQueue(); computeProblemWords();
}
function renderCard(frag,item){
  const s=getPhraseStats(item.id);
  const card=document.createElement('div'); card.className='card'; card.id='card-'+item.id.replace(/[^\w-]/g,'_');
  const ipa=item.ipa?`<div class="ipa">/${escHtml(item.ipa)}/</div>`:''; const syl=item.syllables.length?`<div class="syl">${item.syllables.map(ch=>`<button class="s" data-chunk="${escAttr(ch)}">${escHtml(ch)}</button>`).join('')}</div>`:'';
  card.innerHTML=`
    <div class="row top"><span class="cat">${escHtml(item.categoryLabel)}</span><span class="cat">${escHtml(item.pack.split('/').pop())}</span></div>
    <div class="txt-main">${escHtml(item.fr)}</div>
    ${ipa}${syl}
    <div class="txt-sub">DE: ${escHtml(item.de)}</div>
    <div class="txt-de">${item.hint?('Hinweis: '+escHtml(item.hint)):'&nbsp;'}</div>

    <div class="legend" aria-hidden="true">
      <strong class="percent">0%</strong>
      <span><span class="dot ok"></span> gut</span><span><span class="dot mid"></span> okay</span><span><span class="dot bad"></span> verbessern</span>
    </div>

    <div class="chips"></div>

    <div class="heard"><h5>Verstanden:</h5><div class="text heard-text">—</div><div class="sub">Konfidenz: <span class="conf">–</span></div></div>
    <div class="meter"><span style="width:0%"></span></div>

    <div class="statsline">
      <span class="st-last">${s.last!=null?('Letzter: '+s.last+'%'):'Letzter: —'}</span> ·
      <span class="st-avg10">${s.avg10!=null?('Ø(10): '+s.avg10+'%'):'Ø(10): —'}</span> ·
      <span class="st-count">Versuche: ${s.count}</span>
    </div>

    <div class="actions">
      <button class="btn say" data-rate="1.0" data-text="${escAttr(item.fr)}">Abspielen</button>
      <button class="btn say" data-rate="0.8" data-text="${escAttr(item.fr)}">Langsam</button>
      <button class="btn say" data-rate="0.6" data-text="${escAttr(item.fr)}">Sehr langsam</button>
      <button class="btn shadow" data-id="${escAttr(item.id)}" data-text="${escAttr(item.fr)}">Shadow ▶</button>
    </div>

    <div class="record-wrap"><button class="btn-record rec ready" data-text="${escAttr(item.fr)}" data-id="${escAttr(item.id)}">● Aufnehmen</button></div>
  `;
  frag.appendChild(card);
}

/* ======= recording + scoring ======= */
function scorePron(expected,said){
  const exp=normalize(expected).split(' ').filter(Boolean), heard=normalize(said).split(' ').filter(Boolean);
  const per=[]; let tot=0,c=0;
  for(let i=0;i<exp.length;i++){const t=exp[i]; let best=0,cls='miss';
    for(let d=-1;d<=1;d++){const k=i+d; if(k<0||k>=heard.length) continue; const s=wScore(t,heard[k]); if(s>best) best=s;}
    if(best>=85) cls='ok'; else if(best>=60) cls='mid'; else cls='bad';
    per.push({text:t,score:best,class:cls}); if(cls!=='miss'){tot+=best;c++;}
  }
  return {overall:c?Math.round(tot/c):0, perWord:per};
}
function startRecognition(btn, afterEnd){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){alert('Spracherkennung wird nicht unterstützt.'); return;}
  const card=btn.closest('.card'); const expected=btn.getAttribute('data-text')||''; const id=btn.getAttribute('data-id')||'';
  const percent=card.querySelector('.percent'), chips=card.querySelector('.chips'), bar=card.querySelector('.meter>span'), heard=card.querySelector('.heard-text'), conf=card.querySelector('.conf');
  chips.innerHTML=''; heard.textContent='—'; conf.textContent='–'; percent.textContent='0%'; bar.style.width='0%';
  btn.classList.remove('ready'); btn.classList.add('recording'); btn.textContent='● Aufnahme läuft…';
  stopActiveRecognition();
  const rec=new SR(); rec.lang='fr-FR'; rec.interimResults=false; rec.continuous=false; activeRecognizer=rec;
  try{rec.start();}catch{}
  rec.onresult=e=>{
    const first=e.results[0][0]; const said=Array.from(e.results).map(r=>r[0].transcript).join(' '); const confN=first&&typeof first.confidence==='number'?Math.round(first.confidence*100):null;
    const {overall,perWord}=scorePron(expected,said); percent.textContent=overall+'%'; bar.style.width=overall+'%';
    chips.innerHTML=''; perWord.forEach(w=>{const s=document.createElement('span'); s.className='chip '+w.class; s.textContent=w.text; chips.appendChild(s);});
    heard.textContent=said||'—'; conf.textContent=confN!=null?(confN+'%'):'–';
    saveLog({id,pack:(state.items.find(x=>x.id===id)?.pack)||'',cat:(state.items.find(x=>x.id===id)?.categoryKey)||'',exp:expected,said,score:overall,conf:confN??null,tsISO:new Date().toISOString(),day:todayStr()});
    refreshStatsOnCard(card,id); refreshDailyBox(); computeProblemWords(); if(id) updateSRFor(id,overall);
  };
  const reset=()=>{ if(activeRecognizer===rec) activeRecognizer=null; btn.classList.remove('recording'); btn.classList.add('ready'); btn.textContent='● Aufnehmen'; if(afterEnd) afterEnd(); };
  rec.onerror=reset; rec.onend=reset;
}
function refreshStatsOnCard(card,id){ const s=getPhraseStats(id);
  card.querySelector('.st-last').textContent=s.last!=null?('Letzter: '+s.last+'%'):'Letzter: —';
  card.querySelector('.st-avg10').textContent=s.avg10!=null?('Ø(10): '+s.avg10+'%'):'Ø(10): —';
  card.querySelector('.st-count').textContent='Versuche: '+s.count;
}

/* ======= card interactions ======= */
function initCardEvents(){
  $('#results').addEventListener('click',e=>{
    const say=e.target.closest('.say'); if(say){clearShadowTimers(); const t=say.getAttribute('data-text')||''; const r=parseFloat(say.getAttribute('data-rate')||'1')||1; speak(t,r); return;}
    const rec=e.target.closest('.rec'); if(rec){clearShadowTimers(); stopActiveRecognition(); startRecognition(rec); return;}
    const sh=e.target.closest('.shadow'); if(sh){ if(sh.getAttribute('data-running')==='true') stopShadowing(sh,true); else runShadowing(sh); return; }
    const chunk=e.target.closest('.s'); if(chunk){clearShadowTimers(); speak(chunk.getAttribute('data-chunk')||'',0.7); return;}
    const card=e.target.closest('.card'); if(!card||!state.tts.enabled||!('speechSynthesis' in window)) return;
    const t=card.querySelector('.txt-main')?.textContent.trim()||''; clearShadowTimers(); speak(t,1);
  });

  $('#show-today').addEventListener('click',()=>setShow('today'));
  $('#show-all').addEventListener('click',()=>setShow('all'));
  $('#show-packs').addEventListener('click',()=>setShow('packs'));
  $('#category').addEventListener('change',e=>{state.category=e.target.value; render();});
  $('#tts-toggle').addEventListener('click',()=>{state.tts.enabled=!state.tts.enabled; updateTtsToggle();});
  $('#q').addEventListener('input',e=>{state.q=e.target.value.trim().toLowerCase(); render();});

  $('#export-log').addEventListener('click',()=>{const blob=new Blob([JSON.stringify(state.logs,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='famlang-log.json'; a.click(); URL.revokeObjectURL(url);});
  $('#reset-log').addEventListener('click',()=>{ if(!confirm('Log wirklich löschen?')) return; state.logs=[]; writeLogs(); refreshDailyBox(); render(); computeProblemWords(); });

  $('#start-sr').addEventListener('click', startSRSession);
  $('#toggle-shadow').addEventListener('click',()=>{state.shadow=!state.shadow; const b=$('#toggle-shadow'); b.setAttribute('aria-pressed',state.shadow); b.textContent=state.shadow?'Shadowing: An':'Shadowing: Aus'; if(!state.shadow) shadowStopAll(true);});

  $('#fb-stop').addEventListener('click',()=>{ shadowStopAll(true); state.shadow=false; $('#toggle-shadow').setAttribute('aria-pressed','false'); $('#toggle-shadow').textContent='Shadowing: Aus';});
  $('#fb-next').addEventListener('click',()=>{ nextAndAutorun(); });

  $('#controls-toggle').addEventListener('click',()=>{ const box=$('#controls'); box.classList.toggle('collapsed'); state.prefs.collapsedControls=box.classList.contains('collapsed'); writePrefs(); if(state.prefs.collapsedControls) smoothTop(); });
}

/* ======= shadowing ======= */
function removeFromQueue(id){const i=state.srQueue.indexOf(id); if(i>-1) state.srQueue.splice(i,1);}
function nextAndAutorun(){
  state.shadow=true; $('#toggle-shadow').setAttribute('aria-pressed','true'); $('#toggle-shadow').textContent='Shadowing: An';
  clearShadowTimers(); stopActiveRecognition();
  if(state.shadowCurrent?.id) removeFromQueue(state.shadowCurrent.id);
  if(!state.srQueue.length) rebuildSRQueue();
  if(!state.srQueue.length){ alert('Keine weiteren Karten fällig. 👍'); $('#floatbar').hidden=true; state.shadowRunning=false; state.shadowCurrent=null; smoothTop(); return; }
  const nextId=state.srQueue[0]; openCard(nextId);
  const btn=$(`#card-${nextId.replace(/[^\w-]/g,'_')} .shadow`); if(btn){ btn.removeAttribute('data-running'); btn.classList.remove('recording'); btn.textContent='Shadow ▶'; setTimeout(()=>runShadowing(btn),200); }
}
function runShadowing(btn){
  clearShadowTimers(); stopActiveRecognition();
  const id=btn.getAttribute('data-id'), text=btn.getAttribute('data-text')||''; if(!text) return;
  btn.setAttribute('data-running','true'); btn.textContent='◼ Stop'; btn.classList.add('recording'); state.shadowRunning=true; state.shadowCurrent={id,text};
  $('#floatbar').hidden=false; $('#fb-status').textContent='Shadow aktiv';
  const speakFast=()=>speak(text,1.0), speakSlow=()=>speak(text,0.8);
  const startRec=()=>{ const recBtn=btn.closest('.card').querySelector('.rec'); startRecognition(recBtn,()=>{ shadowTimers.push(setTimeout(()=>{ removeFromQueue(id); if(state.shadow&&state.srQueue.length) goToNextDue(true); else { btn.removeAttribute('data-running'); btn.textContent='Shadow ▶'; btn.classList.remove('recording'); state.shadowRunning=false; state.shadowCurrent=null; $('#floatbar').hidden=true; smoothTop(); } }, SHOW_RESULT_MS)); }); };
  speakFast();
  shadowTimers.push(setTimeout(()=>{ if(btn.getAttribute('data-running')==='true') speakSlow(); }, SHADOW_GAP_AFTER_FAST + text.length*LEN_MULT_FAST));
  shadowTimers.push(setTimeout(()=>{ if(btn.getAttribute('data-running')==='true') startRec(); }, SHADOW_GAP_AFTER_SLOW + text.length*LEN_MULT_SLOW));
}
function stopShadowing(btn,scrollTop=false){ clearShadowTimers(); stopActiveRecognition(); if(btn){btn.removeAttribute('data-running'); btn.textContent='Shadow ▶'; btn.classList.remove('recording');}
  state.shadowRunning=false; state.shadowCurrent=null; $('#floatbar').hidden=true; if(scrollTop) smoothTop(); }
function startSRSession(){ if(!state.srQueue.length){alert('Keine fälligen Karten.'); return;} state.shadow=true; $('#toggle-shadow').setAttribute('aria-pressed','true'); $('#toggle-shadow').textContent='Shadowing: An'; openCard(state.srQueue[0]); const btn=$(`#card-${state.srQueue[0].replace(/[^\w-]/g,'_')} .shadow`); if(btn) runShadowing(btn); }
function goToNextDue(auto=false){ if(!state.srQueue.length){alert('SR-Session fertig!'); $('#floatbar').hidden=true; smoothTop(); return;} const id=state.srQueue[0]; openCard(id); if(auto){ const btn=$(`#card-${id.replace(/[^\w-]/g,'_')} .shadow`); if(btn) setTimeout(()=>runShadowing(btn),300);} else $('#floatbar').hidden=!state.shadowRunning&&!state.shadow; }
function openCard(id){ const el=$('#card-'+id.replace(/[^\w-]/g,'_')); if(!el) return; el.scrollIntoView({behavior:'smooth',block:'center'}); }

/* ======= boot ======= */
function setShow(mode){ state.show=mode; $('#show-today').setAttribute('aria-pressed',mode==='today'); $('#show-all').setAttribute('aria-pressed',mode==='all'); $('#show-packs').setAttribute('aria-pressed',mode==='packs'); render(); }
function applyPrefs(){ const box=$('#controls'); box.classList.toggle('collapsed', !!state.prefs.collapsedControls); }
function init(){ loadPrefs(); loadLogs(); loadSR(); initTTS(); initMic(); initCardEvents(); updateTtsToggle(); applyPrefs(); loadAll(); }
init();
})();
</script>
</body>
</html>
```0
