<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FamLang – informell, familiär (FR ⇄ DE)</title>
<style>
  :root{
    --bg:#0f1115;--card:#151823;--ink:#e8ebf0;--muted:#9aa3b2;--ring:#2b3246;
    --chip:#232739;--accent:#5aa9ff;--ok:#45d483;--bad:#ef6461;
    --ink-dim:#d7dcec;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif}
  .wrap{max-width:960px;margin:20px auto;padding:0 14px 100px}
  header h1{margin:.2rem 0 .1rem;font-weight:800;letter-spacing:.2px}
  header p{margin:.2rem 0 1rem;color:var(--muted)}
  .panel{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:14px;margin:14px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .search{display:grid;grid-template-columns:1fr auto;gap:10px}
  input[type="search"],input[type="text"]{
    width:100%;background:#111827;border:1px solid var(--ring);color:var(--ink);
    padding:12px 14px;border-radius:14px;font-size:16px;outline:none;
  }
  select,button{background:var(--chip);color:var(--ink);border:1px solid var(--ring);
    border-radius:14px;padding:10px 14px;font-size:14px;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  .pill{border-radius:999px}
  .btn-primary{background:#24406b}
  .btn-green{background:#1e7a56}
  .btn-danger{background:#7a2b2b}
  .btn-ghost{background:transparent;border-color:var(--ring)}
  .btn{padding:10px 14px}
  .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);
       background:var(--chip);border:1px solid var(--ring);border-radius:999px;padding:4px 10px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:720px){ .grid{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px}
  .fr{font-size:19px;font-weight:800;margin:0 0 4px}
  .de{margin:.2rem 0 10px;color:var(--ink-dim)}
  .hint{margin:.2rem 0 .6rem;color:var(--muted)}
  .actions{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
  .actions .btn{padding:12px 10px;border-radius:14px}
  .record{justify-self:start;background:#21a06d;border:1px solid #1d8a5f;color:#0b1f16}
  .bar{height:8px;background:#1a2031;border:1px solid var(--ring);border-radius:12px;overflow:hidden}
  .bar>i{display:block;height:100%;background:linear-gradient(90deg,#ff6a6a, #ffc857, #2dd881);width:0%}
  .scoreRow{display:flex;align-items:center;gap:10px;margin:.3rem 0 .4rem}
  .scoreVal{font-weight:800}
  .word{display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;margin:2px 4px;font-size:13px;border:1px solid var(--ring);background:#1b2132}
  .w-good{background:#173422;color:#baf2d6}
  .w-okay{background:#2b2a18;color:#ffe7a3}
  .w-bad{background:#341a1a;color:#ffc1bf}
  .understood{margin:.2rem 0 .6rem;padding:.6rem .8rem;border:1px dashed var(--ring);border-radius:12px;background:#121826;color:#dfe6ff}
  .understood small{display:block;color:var(--muted)}
  footer{color:var(--muted);font-size:12px;margin:20px 0 0;text-align:center}

  /* NEWS panel */
  .speedRow .btn{min-width:84px;text-align:center}
  .presetRow{display:grid;grid-template-columns:1fr auto auto;gap:8px;margin-top:8px}
  @media (min-width:720px){ .presetRow{grid-template-columns:1.2fr auto auto} }
  .bm-list{margin-top:8px}
  .bm-item{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;margin:6px 0}
  .bm-item a{display:inline-flex;align-items:center}

  /* floating tray */
  .tray{
    position:fixed;left:0;right:0;bottom:0;z-index:50;
    background:rgba(15,17,21,.94);backdrop-filter:saturate(1.2) blur(3px);
    border-top:1px solid var(--ring);
    padding:10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
  }
  .tray .row{justify-content:center}
  .tray .btn{min-width:120px}
  .tray .status{color:var(--muted);margin-left:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>FamLang – informell, familiär <small style="font-weight:500;color:var(--muted)">(FR ⇄ DE)</small></h1>
    <p>Französisch als Hauptsprache, deutsche Übersetzung als Hilfe. Alles läuft lokal im Browser.</p>
  </header>

  <!-- Controls -->
  <section class="panel">
    <h3 style="margin:4px 0 10px">Steuerung & Übersicht</h3>
    <div class="search" style="margin:10px 0">
      <input id="q" type="search" placeholder="Suche (FR/DE) …" autocomplete="off" />
      <button id="mic" class="pill">Mikrofon</button>
    </div>
    <div class="row" style="margin:6px 0 2px">
      <select id="category"><option value="">Alle Kategorien</option></select>
      <button id="btn-today" class="pill">Heute</button>
      <button id="btn-all" class="pill">Alle</button>
      <button id="btn-packs" class="pill">Packs</button>
      <button id="tts-toggle" class="pill">Auto-TTS: Aus</button>
    </div>
  </section>

  <!-- NEWS / AUDIO -->
  <section class="panel" id="news">
    <h3 style="margin:4px 0 10px">News / Audio auf Französisch</h3>

    <div class="row" style="align-items:stretch">
      <input id="audio-url" type="text" placeholder="MP3/Stream URL (Podcast, Bulletin, Radio …)" />
      <button id="audio-play" class="btn pill btn-primary">► Play</button>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="audio-stop" class="btn pill btn-danger">■ Stop</button>
      <button id="bm-save" class="btn pill btn-green" title="Aktuelle URL als Lesezeichen speichern">★ Speichern</button>
      <div class="row speedRow" style="margin-left:auto">
        <button data-rate="0.85" class="btn pill">0.85×</button>
        <button data-rate="1.0" class="btn pill btn-primary" id="rate-100">1.0×</button>
        <button data-rate="1.15" class="btn pill">1.15×</button>
        <button data-rate="1.30" class="btn pill">1.30×</button>
        <button id="last20" class="btn pill">Letzte 20 s</button>
      </div>
    </div>

    <!-- Presets -->
    <div class="presetRow">
      <input class="preset-title" value="RFI Monde – Live (Nachrichten/Talk)" />
      <button class="btn pill" data-preset="https://rfimonde64k.ice.infomaniak.ch/rfimonde-64.mp3">Play</button>
      <a class="btn pill btn-ghost" href="https://www.rfi.fr/fr/podcasts/" target="_blank" rel="noopener">Podcasts öffnen</a>
    </div>
    <div class="presetRow">
      <input class="preset-title" value="Franceinfo – Live (24/7 Nachrichten)" />
      <button class="btn pill" data-preset="https://stream.radiofrance.fr/franceinfo/franceinfo.mp3">Play</button>
      <a class="btn pill btn-ghost" href="https://www.radiofrance.fr/franceinfo/podcasts" target="_blank" rel="noopener">Podcasts öffnen</a>
    </div>
    <div class="presetRow">
      <input class="preset-title" value="France Inter – Live (Allgemein)" />
      <button class="btn pill" data-preset="https://stream.radiofrance.fr/franceinter/franceinter.mp3">Play</button>
      <a class="btn pill btn-ghost" href="https://www.radiofrance.fr/franceinter/podcasts" target="_blank" rel="noopener">Podcasts öffnen</a>
    </div>
    <div class="presetRow">
      <input class="preset-title" value="France Culture – Live (Kultur/Nachrichten)" />
      <button class="btn pill" data-preset="https://stream.radiofrance.fr/franceculture/franceculture.mp3">Play</button>
      <a class="btn pill btn-ghost" href="https://www.radiofrance.fr/franceculture/podcasts" target="_blank" rel="noopener">Podcasts öffnen</a>
    </div>
    <div class="presetRow">
      <input class="preset-title" value="RTL – Live (Généraliste)" />
      <button class="btn pill" data-preset="https://streaming.radio.rtl.fr/rtl-1-44-128">Play</button>
      <a class="btn pill btn-ghost" href="https://www.rtl.fr/podcast" target="_blank" rel="noopener">Podcasts öffnen</a>
    </div>
    <div class="presetRow">
      <input class="preset-title" value="Europe 1 – Live (Généraliste)" />
      <button class="btn pill" data-preset="https://stream.europe1.fr/europe1.mp3">Play</button>
      <a class="btn pill btn-ghost" href="https://www.europe1.fr/podcasts" target="_blank" rel="noopener">Podcasts öffnen</a>
    </div>
    <div class="presetRow">
      <input class="preset-title" value="France Bleu – Live (Réseau régional)" />
      <button class="btn pill" data-preset="https://stream.radiofrance.fr/francebleu/francebleu.mp3">Play</button>
      <a class="btn pill btn-ghost" href="https://www.radiofrance.fr/francebleu/podcasts" target="_blank" rel="noopener">Podcasts öffnen</a>
    </div>

    <!-- Bookmarks -->
    <div class="panel" style="margin:12px 0 0">
      <div class="row" style="justify-content:space-between">
        <strong>Bookmarks (lokal)</strong>
        <button id="bm-clear" class="btn pill btn-ghost">Alle löschen</button>
      </div>
      <div id="bm-list" class="bm-list"></div>
    </div>

    <audio id="audio" preload="none" crossorigin="anonymous"></audio>
  </section>

  <!-- Results -->
  <div id="results" class="grid" aria-live="polite"></div>
  <div id="empty" class="panel" style="display:none">Keine Einträge gefunden.</div>

  <footer>Manifest & JSON werden aus <code>/data</code> relativ zur Seite geladen (ohne führende Slashes).</footer>
</div>

<!-- Floating tray -->
<div class="tray" id="tray">
  <div class="row">
    <button id="stopAll" class="btn pill btn-danger">■ Stop</button>
    <button id="nextOne" class="btn pill btn-primary">► Nächste</button>
    <span class="status" id="shadowStatus">Shadow inaktiv</span>
    <span class="status" id="advStatus" style="cursor:pointer">Auto-Advance: An</span>
  </div>
</div>

<script>
(() => {
  // ---------- helpers
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const BASE = new URL('./', location.href);
  const urlFor = p => new URL(p, BASE).toString();
  const fetchJson = async (p)=>{const r=await fetch(urlFor(p),{cache:'no-store'}); if(!r.ok) throw new Error(p+': '+r.status); return r.json();};
  const esc = s => String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const preferGoogleVoice = (voices, want2) =>
      voices.find(v=>/google/i.test(v.name||'')&&(v.lang||'').toLowerCase().startsWith(want2))||
      voices.find(v=>(v.lang||'').toLowerCase().startsWith(want2))||null;

  // ---------- state
  const state = {
    primary:'fr', secondary:'de',
    show:'all', q:'', category:'',
    items:[], categories:new Set(), todaySet:new Set(),
    tts:{enabled:false, voices:[], ready:false}
  };
  const shadow = {active:false, autoAdvance:true};
  let lastShadowCard=null;

  // ---------- controls
  $('#btn-all').addEventListener('click',()=>setShow('all'));
  $('#btn-today').addEventListener('click',()=>setShow('today'));
  $('#btn-packs').addEventListener('click',()=>setShow('packs'));
  $('#tts-toggle').addEventListener('click',()=>{state.tts.enabled=!state.tts.enabled;updateTtsToggle();});
  $('#category').addEventListener('change',e=>{state.category=e.target.value;render();});
  $('#q').addEventListener('input',e=>{state.q=e.target.value.trim().toLowerCase();render();});
  function setShow(mode){
    state.show=mode;
    $('#btn-all').classList.toggle('btn-primary',mode==='all');
    $('#btn-today').classList.toggle('btn-primary',mode==='today');
    $('#btn-packs').classList.toggle('btn-primary',mode==='packs');
    render();
  }
  function updateTtsToggle(){
    $('#tts-toggle').textContent = state.tts.enabled ? 'Auto-TTS: An' : 'Auto-TTS: Aus';
  }

  // ---------- News/Audio panel
  const audio = $('#audio');
  const urlInput = $('#audio-url');
  let curRate = 1.0;

  $('#audio-play').addEventListener('click',()=>playUrl(urlInput.value.trim()));
  $('#audio-stop').addEventListener('click',()=>{ try{audio.pause(); audio.currentTime=0;}catch{} });
  $('#last20').addEventListener('click',()=>{ if(isFinite(audio.duration)) audio.currentTime = Math.max(0, audio.duration-20); });

  $$('#news [data-rate]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      curRate = parseFloat(btn.getAttribute('data-rate')||'1');
      audio.playbackRate = curRate;
      $$('#news [data-rate]').forEach(b=>b.classList.remove('btn-primary'));
      btn.classList.add('btn-primary');
    });
  });

  $$('#news [data-preset]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const src = btn.getAttribute('data-preset');
      urlInput.value = src;
      playUrl(src);
    });
  });

  function playUrl(src){
    if(!src) { urlInput.focus(); return; }
    try{ audio.src = src; audio.playbackRate = curRate; audio.play().catch(()=>{});}catch{}
  }

  // --- Bookmarks (local)
  const BM_KEY = 'frAudioBookmarks';
  const MAX_BM = 6;
  $('#bm-save').addEventListener('click', ()=>{
    const url = urlInput.value.trim(); if(!url) return;
    const list = loadBM();
    // move to top if already present
    const filtered = list.filter(x=>x.url!==url);
    filtered.unshift({title:shorten(url,60), url});
    saveBM(filtered.slice(0,MAX_BM));
    renderBM();
  });
  $('#bm-clear').addEventListener('click', ()=>{ saveBM([]); renderBM(); });

  function loadBM(){ try{return JSON.parse(localStorage.getItem(BM_KEY)||'[]');}catch{return [];} }
  function saveBM(arr){ try{localStorage.setItem(BM_KEY, JSON.stringify(arr||[]));}catch{} }
  function shorten(s,n){ return s.length>n? s.slice(0,n-1)+'…' : s; }

  function renderBM(){
    const box = $('#bm-list'); box.innerHTML='';
    const list = loadBM();
    if(!list.length){ box.innerHTML = '<div style="color:var(--muted)">Noch keine Bookmarks. Füge eine URL hinzu und klicke „Speichern“.</div>'; return; }
    for(const it of list){
      const row = document.createElement('div'); row.className='bm-item';
      row.innerHTML = `
        <div class="tag" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(it.title)}</div>
        <button class="btn pill" data-playbm>Play</button>
        <a class="btn pill btn-ghost" href="${esc(it.url)}" target="_blank" rel="noopener">Öffnen</a>
        <button class="btn pill btn-danger" data-delbm>Entfernen</button>
      `;
      row.querySelector('[data-playbm]').addEventListener('click',()=>{ urlInput.value = it.url; playUrl(it.url); });
      row.querySelector('[data-delbm]').addEventListener('click',()=>{ saveBM(loadBM().filter(x=>x.url!==it.url)); renderBM(); });
      box.appendChild(row);
    }
  }
  renderBM();

  // ---------- data loading
  async function loadAll(){
    try{
      const manifest = await fetchJson('data/manifest.json');
      const packs = manifest.packs||[];
      state.todaySet = new Set(manifest.todayPacks||[]);
      state.items=[]; state.categories=new Set();

      const results = await Promise.all(packs.map(p => fetchJson(p).then(raw=>({path:p,raw}))));

      for(const {path,raw} of results){
        const rows = Array.isArray(raw) ? raw : (raw && Array.isArray(raw.phrases) ? raw.phrases : []);
        const category = (manifest.categoryNames && manifest.categoryNames[path]) || (raw && raw.name) || guess(path);
        state.categories.add(category);
        rows.forEach((row, i)=>{
          state.items.push({
            id:`${path}#${i}`,
            category,
            fr:String(row.fr||''),
            de:String(row.de||row.en||''),
            hint:String(row.hint||''),
            pack:path,
            date:String(row.date||'')
          });
        });
      }
      buildCategorySelect();
      render();
    }catch(e){
      console.error(e);
      $('#empty').style.display='block';
      $('#empty').textContent='Fehler beim Laden: '+e.message;
    }
  }
  function guess(p){ return p.split('/').pop().replace(/_/g,' ').replace(/\..+$/,''); }
  function buildCategorySelect(){
    const sel=$('#category'), cur=sel.value;
    sel.innerHTML='<option value="">Alle Kategorien</option>' +
      Array.from(state.categories).sort().map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join('');
    sel.value=cur||'';
  }

  // ---------- render cards
  function render(){
    const list=$('#results'); const empty=$('#empty');
    list.innerHTML='';
    let view=[...state.items];

    if(state.category) view=view.filter(x=>x.category===state.category);
    if(state.q){
      const q=state.q;
      view=view.filter(x => (x.fr+x.de+x.category).toLowerCase().includes(q));
    }
    if(state.show==='today'){
      const todayISO=new Date().toISOString().slice(0,10);
      view=view.filter(x=> state.todaySet.size?state.todaySet.has(x.pack):(x.date && x.date.startsWith(todayISO)));
    }
    if(!view.length){ empty.style.display='block'; return; } else empty.style.display='none';

    const frag=document.createDocumentFragment();
    for(const item of view) frag.appendChild(cardEl(item));
    list.appendChild(frag);
  }
  function cardEl(item){
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`
      <div class="row" style="justify-content:space-between;margin-bottom:6px">
        <span class="tag">${esc(item.category)}</span>
        <span class="tag">${esc(item.pack.split('/').pop())}</span>
      </div>
      <div class="fr">${esc(item.fr)}</div>
      <div class="de">DE: ${esc(item.de)}</div>
      ${item.hint?`<div class="hint">Hinweis: ${esc(item.hint)}</div>`:''}

      <div class="scoreRow"><span class="scoreVal" data-score>–%</span>
        <span class="tag" style="background:#173422;color:#baf2d6">• gut</span>
        <span class="tag" style="background:#2b2a18;color:#ffe7a3">• okay</span>
        <span class="tag" style="background:#341a1a;color:#ffc1bf">• verbessern</span>
      </div>

      <div class="row" data-words style="flex-wrap:wrap;margin:.2rem 0 .5rem"></div>

      <div class="understood" data-understood hidden>
        <strong>Verstanden:</strong> <span data-u-text>–</span>
        <small>Konfidenz: <span data-u-conf>–</span></small>
      </div>

      <div class="bar"><i data-bar></i></div>

      <div class="actions">
        <button class="btn btn-ghost" data-play="normal">Abspielen</button>
        <button class="btn btn-ghost" data-play="slow">Langsam</button>
        <button class="btn record" data-record>Aufnehmen</button>
      </div>
    `;
    el.querySelector('[data-play="normal"]').addEventListener('click',()=>speak(item.fr,'fr-FR','normal'));
    el.querySelector('[data-play="slow"]').addEventListener('click',()=>speak(item.fr,'fr-FR','slow'));
    el.querySelector('[data-record]').addEventListener('click',()=>startRec(el, item.fr));
    el.dataset.fr=item.fr;
    return el;
  }

  // ---------- TTS
  function pickVoice(lang){
    const want=lang.slice(0,2).toLowerCase();
    return preferGoogleVoice(state.tts.voices||[], want);
  }
  function speak(text, lang='fr-FR', mode='normal', onend){
    if(!text) return;
    try{
      speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(text);
      const v=pickVoice(lang); if(v){u.voice=v; u.lang=v.lang;}
      u.rate = (mode==='slow') ? 0.75 : 1.0;
      u.onend = ()=>{ onend && onend(); };
      setTimeout(()=>speechSynthesis.speak(u),60);
    }catch(e){console.error(e);}
  }

  // ---------- Shadowing (auto-advance with slow pass + recording)
  function startShadowAt(card){
    shadow.active=true;
    lastShadowCard=card;
    $('#shadowStatus').textContent='Shadow aktiv';
    speak(card.dataset.fr,'fr-FR','normal', ()=>{
      speak(card.dataset.fr,'fr-FR','slow', ()=>{
        startRec(card, card.dataset.fr, /*auto*/true, ()=>{
          if(shadow.active && shadow.autoAdvance) setTimeout(()=>goNext(false), 800);
        });
      });
    });
  }
  function goNext(forceStart){
    const cards=$$('.card');
    let idx = cards.indexOf(lastShadowCard);
    if(idx<0) idx=0;
    if(idx>=cards.length-1){ shadow.active=false; $('#shadowStatus').textContent='Shadow inaktiv'; return; }
    const next=cards[idx+1];
    next.scrollIntoView({behavior:'smooth', block:'center'});
    lastShadowCard = next;
    if(forceStart || shadow.active){
      setTimeout(()=>startShadowAt(next), 400);
    }
  }
  function stopEverything(){
    shadow.active=false; $('#shadowStatus').textContent='Shadow inaktiv';
    try{ speechSynthesis.cancel(); }catch{}
    if(rec){ try{rec.stop();}catch{} }
    window.scrollTo({top:0,behavior:'smooth'});
  }
  $('#stopAll').addEventListener('click', stopEverything);
  $('#nextOne').addEventListener('click', ()=>goNext(true));
  $('#advStatus').addEventListener('click', ()=>{
    shadow.autoAdvance = !shadow.autoAdvance;
    $('#advStatus').textContent = shadow.autoAdvance ? 'Auto-Advance: An' : 'Auto-Advance: Aus';
  });

  // ---------- Recording & scoring
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec=null;
  function startRec(card, expected, auto=false, doneCb){
    if(!SR){ alert('Spracherkennung wird nicht unterstützt.'); return; }
    if(rec){ try{rec.stop();}catch{} }
    const scoreEl = card.querySelector('[data-score]');
    const wordsRow= card.querySelector('[data-words]');
    const bar = card.querySelector('[data-bar]');
    const uBox = card.querySelector('[data-understood]');
    const uText = card.querySelector('[data-u-text]');
    const uConf = card.querySelector('[data-u-conf]');

    scoreEl.textContent='…';
    wordsRow.innerHTML='';
    bar.style.width='0%';
    uBox.hidden=true;

    rec = new SR();
    rec.lang='fr-FR'; rec.interimResults=false; rec.continuous=false;
    try{ rec.start(); }catch{}
    rec.onresult = (e)=>{
      const said = Array.from(e.results).map(r=>r[0].transcript).join(' ');
      const conf = Math.round((Array.from(e.results).reduce((a,r)=>a+r[0].confidence,0)/e.results.length||0)*100);
      const percent = similarityPercent(normalize(expected), normalize(said));
      scoreEl.textContent = percent + '%';
      bar.style.width = Math.max(2,percent) + '%';

      uText.textContent = said;
      uConf.textContent = conf + '%';
      uBox.hidden=false;

      // word-level rough colouring:
      wordsRow.innerHTML='';
      const expW = tokenize(expected), saidW = tokenize(said);
      expW.forEach((w,i)=>{
        const t = document.createElement('span');
        t.className='word '+(wordScore(w, saidW[i]));
        t.textContent=w;
        wordsRow.appendChild(t);
      });

      doneCb && doneCb();
    };
    rec.onerror = ()=>{ doneCb && doneCb(); };
    rec.onend   = ()=>{ /* noop */ };
  }

  function normalize(s){
    return String(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z\d\s']/g,' ').replace(/\s+/g,' ').trim();
  }
  function tokenize(s){ return normalize(s).split(' ').filter(Boolean); }
  function wordScore(exp, got){
    if(!got) return 'w-bad';
    if(exp===got) return 'w-good';
    return levenshtein(exp,got)<=1 ? 'w-okay' : 'w-bad';
  }
  function similarityPercent(a,b){
    if(!a && !b) return 100;
    const d=levenshtein(a,b), m=Math.max(1,Math.max(a.length,b.length));
    return Math.max(0, Math.round((1 - d/m)*100));
  }
  function levenshtein(a,b){
    const m=a.length,n=b.length; const dp=Array.from({length:m+1},()=>new Array(n+1).fill(0));
    for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j;
    for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){
      const c=a[i-1]===b[j-1]?0:1;
      dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+c);
    }}
    return dp[m][n];
  }

  // ---------- Mic into search
  (function initMic(){
    const micBtn=$('#mic');
    const SRc = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SRc){ micBtn.disabled=true; micBtn.title='Spracherkennung nicht verfügbar'; return; }
    let active=false; const mic=new SRc(); mic.lang='de-DE'; mic.interimResults=false; mic.continuous=false;
    micBtn.addEventListener('click',()=>{
      if(active){ try{mic.stop();}catch{} return; }
      active=true; micBtn.textContent='Stoppen';
      try{ mic.start(); }catch{}
    });
    mic.onresult = (e)=>{ const t=Array.from(e.results).map(r=>r[0].transcript).join(' '); $('#q').value=t; state.q=t.toLowerCase(); render(); };
    mic.onerror = mic.onend = ()=>{ active=false; micBtn.textContent='Mikrofon'; };
  })();

  // ---------- TTS init + data load
  (function initTTS(){
    if('speechSynthesis' in window){
      const load=()=>{state.tts.voices=speechSynthesis.getVoices();state.tts.ready=true;};
      load(); speechSynthesis.onvoiceschanged=load;
    }
  })();

  // tap card to start shadow
  $('#results').addEventListener('click', e=>{
    const card=e.target.closest('.card'); if(!card) return;
    if(e.target.matches('[data-play="normal"], [data-play="slow"], [data-record]')) return;
    if(!shadow.active){ startShadowAt(card); }
  });

  // ---------- boot
  setShow('all');
  updateTtsToggle();
  loadAll();

})();
</script>
</body>
</html>
