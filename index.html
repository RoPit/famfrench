<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FamLang – informell, familiär (FR ⇄ DE)</title>
<style>
:root{
  --bg:#0f1117; --card:#141824; --muted:#98a2b3; --ring:#273149; --fg:#e8ecf2; --accent:#6aa9ff;
  --chip:#1c2233; --ok:#35d48a; --warn:#f1b84b; --bad:#f06c6c; --btn:#1b2232; --btnHi:#27324a;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;line-height:1.35}
.wrap{max-width:980px;margin:20px auto 120px;padding:0 14px}
h1{margin:0 0 6px;font-weight:800;letter-spacing:.2px}
.lead{margin:6px 0 14px;color:var(--muted)}
/* Panels */
.panel{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:14px;margin:12px 0}
.panel h3{margin:0 0 10px;font-size:18px}
.grid{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:720px){.grid-2{grid-template-columns:1fr 1fr}}
input,select,button{border-radius:14px;border:1px solid var(--ring);background:var(--chip);color:var(--fg);min-height:44px;padding:10px 14px;font-size:15px}
button{cursor:pointer}
button:active{transform:scale(.98)}
.pill{background:var(--btn);border-color:var(--ring)}
.pill.active,.pill[aria-pressed="true"]{background:var(--btnHi);outline:2px solid var(--accent)}
.small{min-height:38px;padding:8px 12px;font-size:14px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.grow{flex:1}
.badge{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--ring);color:var(--muted);border-radius:999px;padding:6px 10px;font-size:12px}
/* Cards */
.card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:14px;margin:10px 0}
.fr{font-size:20px;font-weight:800;margin:0 0 4px}
.de{color:#d7dbef;margin:0 0 4px}
.hint{color:var(--muted);font-size:13px;margin:4px 0 10px}
.btnrow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:6px 0}
.rec{background:#1d3a29;border-color:#2c6f50}
.rec.ready{background:#1d3a29}
.rec.recording{background:#114829;outline:2px solid var(--ok)}
.tokens{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0 4px}
.token{border-radius:999px;padding:6px 10px;border:1px solid var(--ring);background:#1c2233}
.token.ok{background:#143525;border-color:#205b40}
.token.mid{background:#3a2e12;border-color:#6a541b}
.token.bad{background:#3a1818;border-color:#6b2828}
.scoreRow{display:flex;align-items:center;gap:10px;margin:6px 0}
.score{font-weight:800}
.legend{display:flex;gap:10px;font-size:12px;color:var(--muted)}
.legend .dot{display:inline-block;width:8px;height:8px;border-radius:50%}
.bar{height:10px;border-radius:999px;background:linear-gradient(90deg,#e05c66,#f0b34f,#39d689);opacity:.9}
.transbox{border-radius:12px;border:1px solid var(--ring);background:#111827;padding:10px;margin-top:6px;color:#d7dbef}
.transbox h4{margin:0 0 4px;font-size:14px;color:var(--muted)}
/* Floating bottom bar */
.fab{position:fixed;left:0;right:0;bottom:0;background:#0e121b;box-shadow:0 -6px 18px rgba(0,0,0,.35);border-top:1px solid var(--ring);padding:10px 14px;z-index:50}
.fab .row{justify-content:space-between}
.fab .row>div{display:flex;gap:10px}
body.padBottom{padding-bottom:96px}
/* News list */
.newsItem{border:1px solid var(--ring);border-radius:14px;padding:12px;background:#111827;margin:10px 0}
.newsTop{display:flex;justify-content:space-between;align-items:center;gap:10px}
.newsBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.link{color:#bdddff}
/* Sticky helper */
.stickyTitle{position:sticky;top:0;background:linear-gradient(180deg,#0f1117 70%,transparent);padding-top:6px;margin-top:-6px;z-index:5}
.empty{color:var(--muted);text-align:center;margin:16px 0}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;background:#1a2435;border:1px solid var(--ring);color:#e9eff7;padding:10px 14px;border-radius:12px;font-size:14px;z-index:60;display:none}
.toast.show{display:block}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
</style>
</head>
<body>
<div class="wrap">
  <div class="stickyTitle">
    <h1>FamLang – informell, familiär <small style="font-weight:500;color:var(--muted)">(FR ⇄ DE)</small></h1>
    <p class="lead">Französisch als Hauptsprache, deutsche Übersetzung als Hilfe. Alles läuft lokal im Browser.</p>
  </div>

  <!-- Control panel -->
  <section class="panel">
    <h3>Steuerung & Übersicht</h3>
    <div class="row">
      <input id="q" class="grow" type="search" placeholder="Suche (FR/DE)…" autocomplete="off">
      <button id="mic" class="pill">Mikrofon</button>
    </div>
    <div class="row" style="margin-top:8px">
      <select id="category" class="grow">
        <option value="">Alle Kategorien</option>
      </select>
      <button id="btnToday" class="pill">Heute</button>
      <button id="btnAll" class="pill" aria-pressed="true">Alle</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnPacks" class="pill">Packs</button>
      <button id="ttsToggle" class="pill">Auto-TTS: Aus</button>
      <span id="dueBadge" class="badge" title="Anzahl Karten in aktueller Ansicht">0 fällig</span>
    </div>
    <div class="row" style="margin-top:10px">
      <span class="badge" id="bToday">Heute: 0 Versuche</span>
      <span class="badge" id="bAvg">Ø —% (letzte 10)</span>
    </div>
    <div class="row" style="margin-top:6px">
      <span class="badge" id="bStreakD">Tages-Streak: 0🔥</span>
      <span class="badge" id="bStreakW">Wochen-Streak: 0🔥</span>
      <span class="badge">Ziel: <span id="goalVal">30</span></span>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnExport" class="pill small">Log exportieren</button>
      <button id="btnReset" class="pill small">Log zurücksetzen</button>
    </div>
  </section>

  <!-- News / Audio -->
  <section class="panel" id="newsPanel">
    <h3>News / Audio auf Französisch</h3>
    <div class="row">
      <input id="newsUrl" class="grow mono" placeholder="MP3/Stream URL (Podcast, Bulletin, FR Radio)…">
      <button id="newsPlay" class="pill">► Play</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="newsStop" class="pill" style="background:#4a1e22;border-color:#6b2c32">■ Stop</button>
      <button id="newsSave" class="pill" style="background:#1f3a2a;border-color:#2d6b4e">★ Speichern</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="badge">Geschwindigkeit</span>
      <button class="pill small newsSpeed" data-rate="0.85">0.85×</button>
      <button class="pill small newsSpeed" data-rate="1">1.0×</button>
      <button class="pill small newsSpeed" data-rate="1.15">1.15×</button>
      <button class="pill small newsSpeed" data-rate="1.30">1.30×</button>
      <button id="newsBack20" class="pill small">Letzte 20 s</button>
    </div>

    <div id="newsList" style="margin-top:10px">
      <!-- Presets -->
    </div>
    <audio id="player" crossorigin="anonymous"></audio>
  </section>

  <div id="warn" class="empty" hidden></div>

  <!-- Cards -->
  <div id="results"></div>
  <div id="empty" class="empty" hidden>Keine Einträge gefunden.</div>
</div>

<!-- Floating bar -->
<div class="fab" id="fab">
  <div class="row">
    <div>
      <button id="btnStop" class="pill" style="background:#4a1e22;border-color:#6b2c32">■ Stop</button>
      <button id="btnNext" class="pill">► Nächste</button>
    </div>
    <div>
      <button id="shadowToggle" class="pill">Shadow inaktiv</button>
      <button id="advanceToggle" class="pill">Auto-Advance: <b id="advLabel">Aus</b></button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
(()=>{
// -------------- helpers
const $= (s,root=document)=>root.querySelector(s);
const $$=(s,root=document)=>Array.from(root.querySelectorAll(s));
const BASE= new URL('./', location.href);
const urlFor = p=> new URL(p, BASE).toString();
const toast = (msg,ms=1800)=>{ const t=$("#toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),ms); };
const fetchJson = async(p)=>{ const r=await fetch(urlFor(p),{cache:'no-store'}); if(!r.ok) throw new Error(p+': '+r.status); return r.json(); };
const esc=(s)=>String(s).replace(/[&<>"]/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

// -------------- state
const state = {
  show:'all',           // 'all' | 'today' | 'packs'
  category:'',
  q:'',
  items:[],             // cards
  categories:new Set(),
  todaySet:new Set(),
  tts:{enabled:false, voices:[], pref:'google'},
  autoAdvance:false,
  shadow:false,
  running:false,        // auto sequence flag
  currentCard:null,     // HTMLElement
  log:loadLog(),        // attempts
  goal:30
};

// -------------- LOG / streaks
function loadLog(){ try{ return JSON.parse(localStorage.getItem('ff_log')||'[]'); }catch{ return[]; } }
function saveLog(){ localStorage.setItem('ff_log', JSON.stringify(state.log.slice(-600))); }
function pushLog(entry){ state.log.push(entry); saveLog(); updateBadges(); }
function updateBadges(){
  const todayISO=new Date().toISOString().slice(0,10);
  const todayItems=state.log.filter(x=>x.date.startsWith(todayISO));
  const last10 = state.log.slice(-10);
  const avg = last10.length ? Math.round(last10.reduce((s,x)=>s+x.score,0)/last10.length) : NaN;
  $("#bToday").textContent=`Heute: ${todayItems.length} Versuche`;
  $("#bAvg").textContent = `Ø ${isNaN(avg)?'—':avg+'%'} (letzte 10)`;
  // Streaks
  const days=new Set(state.log.map(x=>x.date.slice(0,10)));
  let streak=0; for(let i=0;;i++){ const d=new Date(); d.setDate(d.getDate()-i); if(days.has(d.toISOString().slice(0,10))) streak++; else break; }
  $("#bStreakD").textContent=`Tages-Streak: ${streak}🔥`;
  // Weekly streak (consecutive weeks with >= goal attempts)
  const byWeek={};
  for(const x of state.log){ const d=new Date(x.date); const y=d.getUTCFullYear(); const w=Math.floor((d - new Date(Date.UTC(y,0,1)))/ (7*24*3600*1000)); const key=y+'-'+w; byWeek[key]=(byWeek[key]||0)+1; }
  let wst=0; for(let i=0;;i++){ const d=new Date(); d.setDate(d.getDate()-7*i); const y=d.getUTCFullYear(); const w=Math.floor((d - new Date(Date.UTC(y,0,1)))/ (7*24*3600*1000)); const key=y+'-'+w; if((byWeek[key]||0) >= state.goal) wst++; else break; }
  $("#bStreakW").textContent=`Wochen-Streak: ${wst}🔥`;
  $("#goalVal").textContent=state.goal;
}
// export/reset
$("#btnExport").addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(state.log,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='famlang-log.json'; a.click();
});
$("#btnReset").addEventListener('click',()=>{
  if(confirm('Log wirklich löschen?')){ state.log=[]; saveLog(); updateBadges(); }
});

// -------------- DATA load
async function loadAll(){
  try{
    const manifest = await fetchJson('data/manifest.json');
    const packs = Array.isArray(manifest.packs)?manifest.packs:[];
    state.todaySet = new Set(Array.isArray(manifest.todayPacks)?manifest.todayPacks:[]);
    const names = manifest.categoryNames||{};
    const labels= manifest.categoryLabels||{};
    const settled = await Promise.allSettled(packs.map(async p=>({path:p,raw:await fetchJson(p)})));
    state.items=[]; state.categories=new Set();
    const failed=[];
    for(const r of settled){
      if(r.status!=='fulfilled'){ failed.push(String(r.reason)); continue; }
      const {path,raw}=r.value;
      const rows = Array.isArray(raw)?raw:(Array.isArray(raw?.phrases)?raw.phrases:[]);
      const key  = names[path] || (raw && raw.name) || path.split('/').pop().replace(/\..+/,'');
      const label= labels[key] || key;
      state.categories.add(key);
      rows.forEach((row,idx)=>{
        state.items.push({
          id:`${path}#${idx}`,
          fr:String(row.fr||''),
          de:String(row.de||row.en||''),
          hint:String(row.hint||''),
          pack:path, categoryKey:key, categoryLabel:label,
          date:String(row.date||'')
        });
      });
    }
    buildCategorySelect();
    render();
    if(failed.length){ const w=$("#warn"); w.hidden=false; w.innerHTML='⚠️ Einige Dateien konnten nicht geladen werden.'; }
  }catch(e){ $("#warn").hidden=false; $("#warn").textContent='Fehler beim Laden: '+(e?.message||e); }
}
function buildCategorySelect(){
  const sel=$("#category"); const cur=sel.value;
  const keys=Array.from(state.categories).sort();
  sel.innerHTML='<option value="">Alle Kategorien</option>'+keys.map(k=>{
    const lab=state.items.find(x=>x.categoryKey===k)?.categoryLabel||k;
    return `<option value="${esc(k)}">${esc(lab)}</option>`;
  }).join('');
  sel.value=cur||'';
}

// -------------- RENDER cards
function render(){
  let view = state.items.slice();
  if(state.category) view=view.filter(x=>x.categoryKey===state.category);
  if(state.q){ const q=state.q; view=view.filter(x=>(x.fr+x.de).toLowerCase().includes(q)); }
  if(state.show==='today'){
    const todayISO=new Date().toISOString().slice(0,10);
    view=view.filter(x=> state.todaySet.size?state.todaySet.has(x.pack):(x.date && x.date.startsWith(todayISO)));
  }
  $("#dueBadge").textContent = view.length+' fällig';
  const list=$("#results"); list.innerHTML='';
  $("#empty").hidden = view.length>0;
  for(const it of view){ list.appendChild(renderCard(it)); }
}
function renderCard(item){
  const el=document.createElement('div'); el.className='card'; el.dataset.id=item.id;
  el.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <span class="badge">${esc(item.categoryLabel)}</span>
      <span class="badge">${esc(item.pack.split('/').pop())}</span>
    </div>
    <div class="fr">${esc(item.fr)}</div>
    <div class="de">DE: ${esc(item.de)}</div>
    ${item.hint?`<div class="hint">Hinweis: ${esc(item.hint)}</div>`:''}
    <div class="btnrow">
      <button class="pill say" data-rate="1">Abspielen</button>
      <button class="pill say" data-rate="0.9">Langsam</button>
      <button class="pill say" data-rate="0.75">Sehr langsam</button>
    </div>
    <button class="rec ready small" style="min-height:42px">● Aufnehmen</button>
    <div class="bar" style="margin-top:8px"></div>
    <div class="scoreRow"><span class="score">—%</span>
      <div class="legend">
        <span><span class="dot" style="background:var(--ok)"></span> gut</span>
        <span><span class="dot" style="background:var(--warn)"></span> okay</span>
        <span><span class="dot" style="background:var(--bad)"></span> verbessern</span>
      </div>
    </div>
    <div class="tokens"></div>
    <div class="transbox" hidden>
      <h4>Verstanden:</h4>
      <div class="understood mono"></div>
      <div class="muted" style="margin-top:4px;color:var(--muted)">Konfidenz: <span class="conf">—</span></div>
    </div>
  `;
  // events
  el.querySelectorAll('.say').forEach(b=>b.addEventListener('click',()=>{
    speak(item.fr, parseFloat(b.dataset.rate||'1'));
  }));
  const recBtn = el.querySelector('.rec');
  recBtn.addEventListener('click',()=>startRecognition(el,item));
  // tap card auto speak if enabled
  el.addEventListener('click',(e)=>{
    if(!state.tts.enabled) return;
    if(e.target.closest('button')) return;
    speak(item.fr,1);
  });
  return el;
}

// -------------- SEARCH / FILTERS
$("#q").addEventListener('input',e=>{state.q=e.target.value.trim().toLowerCase();render();});
$("#category").addEventListener('change',e=>{state.category=e.target.value;render();});
$("#btnToday").addEventListener('click',()=>{state.show='today'; setModeBtns(); render();});
$("#btnAll").addEventListener('click',()=>{state.show='all'; setModeBtns(); render();});
$("#btnPacks").addEventListener('click',()=>{state.show='packs'; setModeBtns(); render();});
function setModeBtns(){
  $("#btnToday").setAttribute('aria-pressed', state.show==='today');
  $("#btnAll").setAttribute('aria-pressed', state.show==='all');
  $("#btnPacks").setAttribute('aria-pressed', state.show==='packs');
}
$("#ttsToggle").addEventListener('click',()=>{
  state.tts.enabled=!state.tts.enabled;
  $("#ttsToggle").textContent = 'Auto-TTS: ' + (state.tts.enabled?'An':'Aus');
});

// -------------- TTS
function initTTS(){
  if(!('speechSynthesis' in window)) return;
  const load=()=>{ state.tts.voices = window.speechSynthesis.getVoices(); };
  load(); window.speechSynthesis.onvoiceschanged=load;
}
function pickVoiceFor(lang='fr-FR'){
  const want='fr';
  const vs=state.tts.voices||[];
  const isG=v=>/google/i.test(v.name);
  const isS=v=>/samsung/i.test(v.name);
  const starts=v=>(v.lang||'').toLowerCase().startsWith(want);
  return vs.find(v=>isG(v)&&starts(v)) || vs.find(v=>starts(v)&&!isS(v)) || vs.find(v=>starts(v)) || null;
}
function speak(text, rate=1){
  if(!text) return;
  try{
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text); u.rate=rate; u.pitch=1; const v=pickVoiceFor('fr-FR'); if(v){u.voice=v; u.lang=v.lang;}
    setTimeout(()=>speechSynthesis.speak(u),80);
  }catch(e){console.warn(e);}
}

// -------------- Speech Recognition + scoring
function startRecognition(card,item){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ toast('Spracherkennung nicht verfügbar'); return; }
  const rb = card.querySelector('.rec');
  rb.classList.add('recording'); rb.textContent='■ Aufnahme läuft…';
  const rec=new SR(); rec.lang='fr-FR'; rec.interimResults=false; rec.continuous=false;
  let done=false, said=''; let conf='—';
  try{ rec.start(); }catch{}
  rec.onresult=(e)=>{ said = Array.from(e.results).map(r=>r[0].transcript).join(' '); conf = Math.round((e.results?.[0]?.[0]?.confidence||0)*100)+'%'; };
  rec.onend = ()=>{
    rb.classList.remove('recording'); rb.textContent='● Aufnehmen';
    if(done) return; done=true;
    showScore(card, item.fr, said, conf);
  };
  rec.onerror=()=>{ rb.classList.remove('recording'); rb.textContent='● Aufnehmen'; toast('SR-Fehler'); };
}
function norm(s){ return String(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9\s']/g,' ').replace(/\s+/g,' ').trim(); }
function lev(a,b){ const m=a.length,n=b.length; const dp=Array.from({length:m+1},()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++)dp[i][0]=i; for(let j=0;j<=n;j++)dp[0][j]=j;
  for(let i=1;i<=m;i++) for(let j=1;j<=n;j++){const c=a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+c);} return dp[m][n];}
function showScore(card, expected, saidRaw, confStr){
  const said = norm(saidRaw); const exp = norm(expected);
  const dist = lev(exp,said); const score = Math.round((1 - dist/Math.max(1,exp.length)) * 100);
  const scoreEl = card.querySelector('.score'); scoreEl.textContent = clamp(score,0,100)+'%';
  // bar
  const bar = card.querySelector('.bar'); bar.style.background = `linear-gradient(90deg,#e05c66 0%,#e05c66 ${Math.max(0,50-score)}%,#f0b34f ${Math.max(0,50-score)}%,#39d689 ${score}%)`;
  // tokens
  const toksEl = card.querySelector('.tokens'); toksEl.innerHTML='';
  const expWords = exp.split(' ');
  const saidWords= said.split(' ');
  for(const w of expWords){
    let best=Infinity;
    for(const sw of saidWords){ best = Math.min(best, lev(w,sw)); }
    const cls = (best<=1)?'ok':(best<=3)?'mid':'bad';
    const t=document.createElement('span'); t.className='token '+cls; t.textContent=w; toksEl.appendChild(t);
  }
  // understood box
  const tb=card.querySelector('.transbox'); tb.hidden=false; card.querySelector('.understood').textContent= saidRaw||'—';
  card.querySelector('.conf').textContent = confStr||'—';
  // log
  pushLog({id:card.dataset.id, score:clamp(score,0,100), date:new Date().toISOString()});
}

// -------------- Auto-Advance / Shadowing
$("#advanceToggle").addEventListener('click',()=>{ state.autoAdvance=!state.autoAdvance; $("#advLabel").textContent=state.autoAdvance?'An':'Aus'; if(state.autoAdvance && !state.running){ nextCard(true); }});
$("#shadowToggle").addEventListener('click',()=>{ state.shadow=!state.shadow; $("#shadowToggle").textContent = state.shadow?'Shadow aktiv':'Shadow inaktiv'; });

$("#btnNext").addEventListener('click',()=> nextCard(true));
$("#btnStop").addEventListener('click',()=> stopSequence(true));

function stopSequence(scrollTop=false){ state.running=false; speechSynthesis.cancel(); if(scrollTop) window.scrollTo({top:0,behavior:'smooth'}); }

function nextCard(startSeq){
  const cards = $$('#results .card');
  if(!cards.length){ toast('Keine Karten'); return; }
  let idx = state.currentCard ? cards.indexOf(state.currentCard)+1 : 0;
  if(idx>=cards.length) idx=0;
  const card = cards[idx]; state.currentCard = card;
  card.scrollIntoView({behavior:'smooth', block:'center'});
  if(startSeq) runSequence(card);
}

async function runSequence(card){
  const text = $('.fr', card).textContent.trim();
  if(!text) return;
  state.running=true;
  try{
    // fast
    speak(text,1); await waitEnd(900 + Math.min(2500, text.length*55));
    // slow
    speak(text,0.8); await waitEnd(1200 + Math.min(3000, text.length*65));
    // shadowing (record)
    if(state.shadow){
      const btn = $('.rec', card);
      btn.click();
      await delay(2600);
    }
    // hold result briefly
    await delay(900);
    if(state.autoAdvance && state.running) nextCard(true);
  }catch{} 
}
function waitEnd(ms){ return new Promise(res=>setTimeout(res,ms)); }
function delay(ms){ return new Promise(res=>setTimeout(res,ms)); }

// -------------- Floating bar padding
(function manageFab(){
  const h=$("#fab").offsetHeight; document.body.classList.add('padBottom');
})();

// -------------- Mic → search
(function initMic(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ $("#mic").disabled=true; $("#mic").title='Spracherkennung nicht verfügbar'; return; }
  let active=false; const rec=new SR(); rec.lang='fr-FR'; rec.interimResults=false; rec.continuous=false;
  $("#mic").addEventListener('click',()=>{
    if(active){ rec.stop(); return; }
    active=true; $("#mic").textContent='Stoppen'; try{rec.start();}catch{}
  });
  rec.onresult=(e)=>{ const t=Array.from(e.results).map(r=>r[0].transcript).join(' '); $("#q").value=t; state.q=t.toLowerCase(); render(); };
  const end=()=>{ active=false; $("#mic").textContent='Mikrofon'; };
  rec.onerror=end; rec.onend=end;
})();

// -------------- NEWS / AUDIO
const presets = [
  {title:'RFI Monde – Live (Nachrichten/Talk)',   url:'https://rfimonde64k.ice.infomaniak.ch/rfimonde-64.mp3', site:'https://www.rfi.fr/fr/direct-monde'},
  {title:'franceinfo – Live (24/7 Nachrichten)', url:'https://icecast.radiofrance.fr/franceinfo-hifi.aac',     site:'https://www.francetvinfo.fr/son/'},
  {title:'France Inter – Live (Allgemein)',      url:'https://icecast.radiofrance.fr/franceinter-hifi.aac',   site:'https://www.radiofrance.fr/franceinter/direct'},
  {title:'France Culture – Live (Kultur)',       url:'https://icecast.radiofrance.fr/franceculture-hifi.aac', site:'https://www.radiofrance.fr/franceculture/direct'},
  {title:'RTL – Live (Généraliste)',             url:'https://streaming.radio.rtl.fr/rtl-1-44-128',           site:'https://www.rtl.fr/direct'},
  {title:'Europe 1 – Live (Info/Mag)',           url:'https://stream.europe1.fr/europe1.mp3',                 site:'https://www.europe1.fr/direct'},
  {title:'France Bleu – Live (Régions)',         url:'https://icecast.radiofrance.fr/francebleu-hifi.aac',    site:'https://www.francebleu.fr/direct'}
];
function renderNews(){
  const list=$("#newsList"); list.innerHTML='';
  presets.forEach(p=>{
    const item=document.createElement('div'); item.className='newsItem';
    item.innerHTML=`
      <div class="newsTop"><div><strong>${esc(p.title)}</strong><div style="color:var(--muted);font-size:12px">${esc(new URL(p.url).host)}</div></div></div>
      <div class="newsBtns">
        <button class="pill small playNews">► Play</button>
        <a class="pill small link" target="_blank" rel="noopener" href="${esc(p.site)}">Website</a>
        <a class="pill small link" target="_blank" rel="noopener" href="${esc(p.url)}">↗ Im Tab öffnen</a>
      </div>
    `;
    item.querySelector('.playNews').addEventListener('click',()=>playNews(p.url, p.title));
    list.appendChild(item);
  });
}
const player=$("#player");
function playNews(url,title){
  try{
    player.pause(); player.src=''; player.src=url; player.play().then(()=>{
      $("#newsUrl").value=url;
      toast('▶ Audio gestartet');
    }).catch(err=>{
      toast('⏳ Keine Daten (Timeout/CORS)'); 
    });
  }catch{ toast('Audio nicht ladbar'); }
}
$("#newsPlay").addEventListener('click',()=> playNews($("#newsUrl").value.trim(), 'Custom'));
$("#newsStop").addEventListener('click',()=>{ try{ player.pause(); }catch{} });
$("#newsSave").addEventListener('click',()=>{
  const u=$("#newsUrl").value.trim(); if(!u) return;
  presets.unshift({title:'Benutzer Link', url:u, site:u}); renderNews(); toast('Gespeichert (oben eingefügt)');
});
$$('.newsSpeed').forEach(b=>b.addEventListener('click',()=>{ player.playbackRate=parseFloat(b.dataset.rate||'1'); toast('Speed '+player.playbackRate+'×'); }));
$("#newsBack20").addEventListener('click',()=>{ try{ player.currentTime=Math.max(0,player.currentTime-20); }catch{} });

// -------------- EVENTS
document.addEventListener('click',(e)=>{
  const say = e.target.closest('.say'); if(say) return; // handled in renderCard
});

// -------------- BOOT
initTTS(); renderNews(); loadAll(); updateBadges(); setModeBtns();

})();
</script>
</body>
</html>
