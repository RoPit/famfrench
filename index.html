<!doctype html>

<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FamLang – Französisch (nur FR)</title>
  <style>
    :root{ --bg:#0f1115;--fg:#e8ebf0;--muted:#9aa3b2;--card:#151822;--accent:#5aa9ff;--chip:#232738;--ring:#2b3246;--ok:#45d483;--warn:#f5b942;--danger:#ff7676; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    header h1{margin:0 0 6px;font-weight:800;letter-spacing:.3px}
    header p{margin:4px 0;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .chip{background:var(--chip);border:1px solid var(--ring);padding:8px 10px;border-radius:999px;font-size:.9rem}
    .card{background:var(--card);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 2px 6px rgba(0,0,0,.35)}
    h2{margin:0 0 10px}
    textarea{width:100%;min-height:110px;background:#0c0f16;color:var(--fg);border:1px solid var(--ring);border-radius:12px;padding:10px}
    input, select{background:#0c0f16;color:var(--fg);border:1px solid var(--ring);border-radius:10px;padding:10px}
    button{background:var(--accent);color:#041023;border:0;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;color:var(--fg);border:1px solid var(--ring)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .ok{color:var(--ok);font-weight:700}
    .warn{color:var(--warn);font-weight:700}
    .danger{color:var(--danger);font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .phrase{border:1px solid var(--ring);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .meta{display:flex;gap:8px;flex-wrap:wrap}
    .meta .tag{border:1px solid var(--ring);border-radius:999px;padding:4px 8px;font-size:.8rem;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .fav{filter:grayscale(1);opacity:.85}
    .fav.active{filter:none}
    .de{color:var(--muted);font-size:.95rem}
    .small{font-size:.9rem;color:var(--muted)}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{accent-color:#5aa9ff}
    .wfw{display:block;margin-top:6px;font-family:ui-monospace,Consolas,monospace}
    .wfw .good{background:rgba(69,212,131,.18);border:1px solid rgba(69,212,131,.35);padding:1px 4px;border-radius:6px;margin:0 2px;display:inline-block}
    .wfw .bad{background:rgba(255,118,118,.18);border:1px solid rgba(255,118,118,.4);padding:1px 4px;border-radius:6px;margin:0 2px;display:inline-block}
    .wfw .miss{background:rgba(245,185,66,.18);border:1px solid rgba(245,185,66,.4);padding:1px 4px;border-radius:6px;margin:0 2px;display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>FamLang</h1>
      <p>Informell, familiär – Französisch **ohne Niederländisch**</p>
      <div class="row" style="margin-top:6px">
        <span class="chip">FR aktiv</span>
        <span class="chip" id="ttsState">TTS: wird geprüft…</span>
        <label class="chip" for="voiceSelect">Stimme
          <select id="voiceSelect" style="margin-left:8px"></select>
        </label>
        <label class="chip" for="rate">Geschwindigkeit
          <input id="rate" type="range" min="0.7" max="1.4" step="0.05" value="1" style="width:120px;vertical-align:middle;margin-left:8px"/>
        </label>
        <label class="chip switch"><input type="checkbox" id="toggleDE"/> Deutsche Übersetzung anzeigen</label>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="search" placeholder="Suche (z. B. Schlüssel, Abendessen)" style="flex:1" />
        <select id="filterCat">
          <option value="">Kategorie: alle</option>
        </select>
        <button id="randomBtn" class="ghost">Zufall</button>
      </div>
    </header><div class="card">
  <h2>Nützliche Sätze (Familie & Alltag)</h2>
  <div id="list" class="grid" aria-live="polite"></div>
  <div id="emptyMsg" class="warn" style="display:none;margin-top:8px">Kein Treffer. Anderes Stichwort/Kategorie probieren.</div>
</div>

<div class="card">
  <h2>Favoriten</h2>
  <div id="favs" class="grid"></div>
  <div id="noFavs" class="muted" style="color:var(--muted)">Noch keine Favoriten. ★ drücken, um hinzuzufügen.</div>
</div>

<div class="card">
  <h2>Notizbuch</h2>
  <p>Eigene Sätze/Vokabeln zum Üben:</p>
  <textarea id="notes" placeholder="Hier schreiben…"></textarea>
  <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
    <button id="saveBtn">Speichern</button>
    <span id="status" class="ok" aria-live="polite"></span>
  </div>
</div>

  </div>  <script>
    // ===== Daten (FR + DE) =====
    const DATA = [
      { id:1, fr:"Tu peux m’aider, s’il te plaît ?", de:"Kannst du mir bitte helfen?", cat:["hilfe","familie"], hint:"höflich" },
      { id:2, fr:"On mange à quelle heure ?", de:"Um wie viel Uhr essen wir?", cat:["haus","essen"] },
      { id:3, fr:"Où as‑tu mis les clés ?", de:"Wo hast du die Schlüssel hingelegt?", cat:["haus","objekte"] },
      { id:4, fr:"Je reviens tout de suite.", de:"Ich bin gleich wieder da.", cat:["alltag"] },
      { id:5, fr:"Bonne nuit, à demain !", de:"Gute Nacht, bis morgen!", cat:["familie","grüße"] },
      { id:6, fr:"Qui veut un café ?", de:"Wer möchte einen Kaffee?", cat:["küche","familie"] },
      { id:7, fr:"Peux‑tu baisser le volume ?", de:"Kannst du die Lautstärke leiser machen?", cat:["haus","technik"] },
      { id:8, fr:"Je m’en occupe.", de:"Ich kümmere mich darum.", cat:["arbeit","alltag"] },
      { id:9, fr:"N’oublie pas ton sac, s’il te plaît.", de:"Bitte vergiss deine Tasche nicht.", cat:["familie","objekte"] },
      { id:10, fr:"On part dans cinq minutes.", de:"Wir fahren in fünf Minuten los.", cat:["unterwegs","familie"] }
    ];

    const qs = sel => document.querySelector(sel);
    const list = qs('#list');
    const favsEl = qs('#favs');
    const noFavs = qs('#noFavs');
    const search = qs('#search');
    const filterCat = qs('#filterCat');
    const randomBtn = qs('#randomBtn');
    const notes = qs('#notes');
    const status = qs('#status');
    const saveBtn = qs('#saveBtn');
    const voiceSelect = qs('#voiceSelect');
    const rate = qs('#rate');
    const ttsState = qs('#ttsState');
    const toggleDE = qs('#toggleDE');

    const LS_KEYS = {
      favs: 'famlang_fr_favs_v2',
      notes: 'famlang_fr_notes_v2',
      voice: 'famlang_fr_voice',
      rate:  'famlang_fr_rate',
      showDE: 'famlang_show_de'
    };

    // ===== TTS (FR only) =====
    let voices = [];
    function loadVoices() {
      voices = window.speechSynthesis ? speechSynthesis.getVoices().filter(v => v.lang && v.lang.toLowerCase().startsWith('fr')) : [];
      voiceSelect.innerHTML = '';
      if (!voices.length) {
        const opt = document.createElement('option');
        opt.textContent = 'Keine FR‑Stimme gefunden';
        opt.value = '';
        voiceSelect.appendChild(opt);
        ttsState.textContent = 'TTS: FR‑Stimme fehlt (Google/Samsung FR installieren)';
        return;
      }
      voices.forEach((v)=>{
        const o = document.createElement('option');
        o.value = v.name; o.textContent = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(o);
      });
      const saved = localStorage.getItem(LS_KEYS.voice);
      if (saved) voiceSelect.value = saved;
      ttsState.textContent = 'TTS bereit';
    }
    if ('speechSynthesis' in window) {
      speechSynthesis.onvoiceschanged = loadVoices;
      setTimeout(loadVoices, 120);
    } else {
      ttsState.textContent = 'TTS nicht unterstützt';
    }

    function speak(text){
      if(!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      const name = voiceSelect.value;
      const v = voices.find(x=>x.name===name) || voices[0];
      if (v) u.voice = v;
      const r = parseFloat(rate.value || '1');
      u.rate = isNaN(r)?1:r;
      u.lang = (v && v.lang) || 'fr-FR';
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }

    voiceSelect.addEventListener('change', ()=>{
      localStorage.setItem(LS_KEYS.voice, voiceSelect.value);
    });
    rate.addEventListener('change', ()=>{
      localStorage.setItem(LS_KEYS.rate, rate.value);
    });

    // ===== Favoriten =====
    function getFavs(){
      try { return JSON.parse(localStorage.getItem(LS_KEYS.favs)||'[]'); } catch(e){ return []; }
    }
    function setFavs(arr){ localStorage.setItem(LS_KEYS.favs, JSON.stringify(arr)); }
    function toggleFav(id){
      const favs = new Set(getFavs());
      if (favs.has(id)) favs.delete(id); else favs.add(id);
      setFavs([...favs]);
      render();
    }

    // ===== Aussprache-Bewertung (Prozent + Wort-für-Wort) =====
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    function norm(s){
      if(!s) return '';
      return s
        .toLowerCase()
        .replace(/[’']/g, "'")
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z'\s]/g,' ')
        .replace(/\s+/g,' ').trim();
    }
    function levenshtein(a,b){
      const m=a.length,n=b.length; const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){
        for(let j=1;j<=n;j++){
          const cost = a[i-1]===b[j-1]?0:1;
          dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[m][n];
    }
    function similarity(a,b){
      a=norm(a); b=norm(b);
      if(!a||!b) return 0;
      const dist=levenshtein(a,b);
      return 1 - dist/Math.max(a.length,b.length);
    }
    function tokeniseFR(s){
      return norm(s).split(' ').filter(Boolean);
    }
    function wordForWord(expected, said){
      const exp = tokeniseFR(expected);
      const got = tokeniseFR(said);
      const used = new Array(got.length).fill(false);
      const parts = [];
      exp.forEach(w => {
        // finde bestes Match im gesprochenen Satz
        let bestIdx=-1, bestScore=0;
        for(let i=0;i<got.length;i++){
          if(used[i]) continue;
          const s = 1 - (levenshtein(w, got[i]) / Math.max(w.length, got[i].length));
          if(s>bestScore){ bestScore=s; bestIdx=i; }
        }
        if(bestIdx>-1 && bestScore>=0.75){
          used[bestIdx]=true;
          parts.push(`<span class="good">${w}</span>`);
        } else if(bestIdx>-1){
          used[bestIdx]=true;
          parts.push(`<span class="bad">${w}</span>`);
        } else {
          parts.push(`<span class="miss">${w}</span>`);
        }
      });
      return parts.join(' ');
    }

    function startEval(expectedFR, root){
      if(!SR){
        alert('Spracherkennung wird von diesem Browser nicht unterstützt. Bitte Chrome/Android verwenden.');
        return;
      }
      const recog = new SR();
      recog.lang='fr-FR';
      recog.interimResults=false; recog.maxAlternatives=1;
      const scoreEl = root.querySelector('.score');
      const heardEl = root.querySelector('.heard');
      const wfwEl = root.querySelector('.wfw');
      scoreEl.textContent='…'; scoreEl.className='score';
      heardEl.textContent=''; wfwEl.innerHTML='';
      recog.onresult = (e)=>{
        const said = e.results[0][0].transcript || '';
        const s = similarity(said, expectedFR);
        const pct = Math.round(s*100);
        scoreEl.textContent = pct + '%';
        scoreEl.classList.remove('ok','warn','danger');
        if (s>=0.88) scoreEl.classList.add('ok');
        else if (s>=0.72) scoreEl.classList.add('warn');
        else scoreEl.classList.add('danger');
        heardEl.textContent = 'Erkannt: "'+said+'"';
        wfwEl.innerHTML = wordForWord(expectedFR, said);
      };
      recog.onerror = ()=>{ scoreEl.textContent='Fehler'; scoreEl.classList.add('danger'); };
      recog.onend = ()=>{};
      recog.start();
    }

    // ===== Render =====
    let SHOW_DE = (localStorage.getItem(LS_KEYS.showDE)||'true')==='true';
    toggleDE.checked = SHOW_DE;
    toggleDE.addEventListener('change', ()=>{
      SHOW_DE = !!toggleDE.checked;
      localStorage.setItem(LS_KEYS.showDE, SHOW_DE);
      render();
    });

    function tag(t){ return `<span class="tag">#${t}</span>`; }
    function card(item){
      const favSet = new Set(getFavs());
      const isFav = favSet.has(item.id);
      return `
        <div class="phrase" data-id="${item.id}">
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:flex-start">
            <div style="font-size:1.05rem;line-height:1.35">${item.fr}</div>
            <button class="ghost fav ${isFav?'active':''}" title="Favorit umschalten" data-action="fav">${isFav?'★':'☆'}</button>
          </div>
          ${SHOW_DE && item.de ? `<div class="de">DE: ${item.de}</div>`:''}
          <div class="meta">${(item.cat||[]).map(tag).join(' ')}${item.hint?`<span class="tag">${item.hint}</span>`:''}</div>
          <div class="actions">
            <button data-action="speak">▶️ Vorlesen</button>
            <button class="ghost" data-action="copy">Kopieren</button>
            <button class="ghost" data-action="rec">🎤 Aussprechen</button>
            <span class="small">Bewertung: <span class="score">—</span></span>
          </div>
          <div class="small heard"></div>
          <div class="wfw"></div>
        </div>`;
    }

    function render(){
      const q = search.value.trim().toLowerCase();
      const c = filterCat.value;
      const filtered = DATA.filter(x => (!q || x.fr.toLowerCase().includes(q) || (x.de||'').toLowerCase().includes(q)) && (!c || x.cat?.includes(c)));
      list.innerHTML = filtered.map(card).join('');
      qs('#emptyMsg').style.display = filtered.length? 'none':'block';

      const favSet = new Set(getFavs());
      const favItems = DATA.filter(x=>favSet.has(x.id));
      favsEl.innerHTML = favItems.length ? favItems.map(card).join('') : '';
      if (document.getElementById('noFavs')) document.getElementById('noFavs').style.display = favItems.length ? 'none':'block';
    }

    // Kategorien befüllen
    [...new Set(DATA.flatMap(d=>d.cat||[]))].sort().forEach(c=>{
      const o=document.createElement('option'); o.value=c; o.textContent=c; filterCat.appendChild(o);
    });

    // Events
    search.addEventListener('input', render);
    filterCat.addEventListener('change', render);
    randomBtn.addEventListener('click', ()=>{
      const item = DATA[Math.floor(Math.random()*DATA.length)];
      speak(item.fr);
    });

    function handleActions(container){
      container.addEventListener('click', (e)=>{
        const root = e.target.closest('.phrase');
        if (!root) return;
        const id = parseInt(root.dataset.id,10);
        const action = e.target.getAttribute('data-action');
        const item = DATA.find(x=>x.id===id);
        if (action==='speak') speak(item.fr);
        if (action==='copy') {
          navigator.clipboard?.writeText(item.fr + (SHOW_DE && item.de? `\nDE: ${item.de}`:''));
          e.target.textContent='Kopiert'; setTimeout(()=> e.target.textContent='Kopieren', 900);
        }
        if (action==='rec') startEval(item.fr, root);
        if (action==='fav') toggleFav(id);
      });
    }

    handleActions(list);
    handleActions(favsEl);

    // Notizen
    try { notes.value = localStorage.getItem(LS_KEYS.notes) || ''; } catch(e){}
    saveBtn.addEventListener('click', ()=>{
      try { localStorage.setItem(LS_KEYS.notes, notes.value); status.textContent='Gespeichert'; setTimeout(()=> status.textContent='', 1500); } catch(e){ status.textContent='Fehler'; }
    });

    render();
  </script></body>
</html>
