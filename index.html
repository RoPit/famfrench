<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="color-scheme" content="dark">
<title>FamLang – informell, familiär (FR ⇄ DE)</title>
<style>
  :root{
    --bg:#0b0e14; --fg:#eff3fb; --muted:#b8c0d9;
    --card:#121624; --ring:#2e3750; --chip:#1a2134;
    --accent:#5aa9ff; --accent-strong:#2b8cff;
    --ok:#3ddc91; --bad:#ff6b6b; --tray:#0f1322; --tray-ring:#2b3752;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  .wrap{max-width:980px;margin:18px auto;padding:0 12px 120px}
  header h1{margin:0 0 4px;font-weight:800;font-size:28px}
  header p{margin:2px 0 6px;color:var(--muted);font-size:14px}

  /* compact controls */
  input,button,select{background:var(--chip);color:#eaf1ff;border:1px solid var(--ring);border-radius:12px;padding:8px 12px;font-size:14px;line-height:1}
  button{cursor:pointer}
  button:hover{background:#202946}
  button:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .grow{flex:1}

  .panel{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:10px;margin:12px 0}
  details.panel>summary{list-style:none;cursor:pointer;font-weight:750;font-size:16px;margin:0 0 6px}
  details[open]>summary{margin:0 0 6px}

  .bar{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  .search{display:flex;gap:6px;align-items:center;background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:6px 8px}
  .search input{flex:1;background:transparent;border:0;outline:none;color:var(--fg);font-size:15px}

  .grid{display:grid;gap:10px;margin:10px 0 18px}
  @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}

  .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:12px}
  .txt-main{font-size:17px;font-weight:750;margin:0 0 2px}
  .txt-sub{font-size:15px;color:#d7dbef;margin:0}
  .txt-de{font-size:12px;color:var(--muted);margin-top:6px}

  .play-group{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
  @media(max-width:520px){.play-group{grid-template-columns:1fr}}
  .pill-success{background:var(--ok);color:#062;display:inline-block}
  .rec-btn{margin-top:8px}

  .scorebar{height:8px;border-radius:5px;background:#283150;border:1px solid var(--ring);overflow:hidden;margin-top:8px}
  .scorebar>i{display:block;height:100%;background:linear-gradient(90deg,var(--bad),#ffb85c,var(--ok));width:0%}

  .empty{margin:14px 0;color:var(--muted);text-align:center}

  /* News/Audio compact */
  .speed-group{display:flex;gap:6px;flex-wrap:wrap}
  .preset-grid{display:grid;gap:8px;margin-top:8px}
  .preset{display:grid;gap:6px;grid-template-columns:minmax(0,1fr) minmax(0,2fr) auto auto;align-items:center}
  .preset input{width:100%}
  .preset button{white-space:nowrap}
  @media(max-width:760px){
    .preset{grid-template-columns:1fr}
    .preset .btns{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .preset button{width:100%}
  }
  .links{display:grid;gap:6px;margin-top:8px}
  .links a{color:#bfe0ff;text-decoration:none;font-size:14px}
  .links a:hover{text-decoration:underline}

  /* tray */
  .tray{position:fixed;left:0;right:0;bottom:0;background:var(--tray);border-top:1px solid var(--tray-ring);box-shadow:0 -6px 18px rgba(0,0,0,.35);padding:8px 12px;z-index:9999}
  .tray .inner{max-width:980px;margin:0 auto;display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap}
  .tray .status{color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>FamLang – informell, familiär <small style="font-weight:600;color:var(--muted)">(FR ⇄ DE)</small></h1>
    <p>Französisch als Hauptsprache, deutsche Übersetzung als Hilfe. Alles läuft lokal im Browser.</p>
  </header>

  <details class="panel" open>
    <summary>Steuerung & Übersicht</summary>
    <div class="bar">
      <div class="search"><input id="q" type="search" placeholder="Suche (FR/DE)…"><button id="mic">Mikrofon</button></div>
    </div>
    <div class="row" style="margin-top:6px">
      <select id="category"><option value="">Alle Kategorien</option></select>
      <button id="show-today">Heute</button>
      <button id="show-all">Alle</button>
      <button id="show-packs">Packs</button>
      <button id="tts-toggle">Auto-TTS: Aus</button>
    </div>
  </details>

  <details class="panel" open>
    <summary>News / Audio auf Französisch</summary>

    <div class="row">
      <input id="news-url" class="grow" placeholder="MP3/Stream URL (Podcast, Bulletin, RFI …)">
      <button id="news-play">► Play</button>
      <button id="news-stop">■ Stop</button>
    </div>

    <div class="row" style="margin-top:6px">
      <div class="speed-group">
        <span style="align-self:center;color:var(--muted);font-size:13px">Geschwindigkeit</span>
        <button class="speed" data-rate="0.85">0.85×</button>
        <button class="speed" data-rate="1.0">1.0×</button>
        <button class="speed" data-rate="1.15">1.15×</button>
        <button class="speed" data-rate="1.30">1.30×</button>
        <button id="news-back20">Letzte 20 s</button>
      </div>
    </div>

    <!-- Presets -->
    <div class="preset-grid" id="presets">
      <div class="preset">
        <input id="p1-title" value="RFI – Journal en français facile">
        <input id="p1-url"   value="https://www.rfi.fr/fr/podcasts/journal-en-fran%C3%A7ais-facile/">
        <div class="btns"><button data-slot="1" class="preset-save">Speichern</button></div>
        <div class="btns"><button data-slot="1" class="preset-play">Play / Öffnen</button></div>
      </div>
      <div class="preset">
        <input id="p2-title" value="franceinfo – Le journal (8h)">
        <input id="p2-url"   value="https://www.radiofrance.fr/franceinfo/podcasts/le-journal-de-8h">
        <div class="btns"><button data-slot="2" class="preset-save">Speichern</button></div>
        <div class="btns"><button data-slot="2" class="preset-play">Play / Öffnen</button></div>
      </div>
      <div class="preset">
        <input id="p3-title" value="ARTE Radio – Podcasts">
        <input id="p3-url"   value="https://www.arteradio.com/podcast">
        <div class="btns"><button data-slot="3" class="preset-save">Speichern</button></div>
        <div class="btns"><button data-slot="3" class="preset-play">Play / Öffnen</button></div>
      </div>
      <div class="preset">
        <input id="p4-title" value="Wikimedia – fr Sample (Test)">
        <input id="p4-url"   value="https://upload.wikimedia.org/wikipedia/commons/4/4e/Fr-Paris.ogg">
        <div class="btns"><button data-slot="4" class="preset-save">Speichern</button></div>
        <div class="btns"><button data-slot="4" class="preset-play">Play / Öffnen</button></div>
      </div>
    </div>

    <div class="links">
      <div style="color:var(--muted);font-size:13px">Schnell-Links:</div>
      <a href="#" data-url="https://www.rfi.fr/fr/podcasts/journal-en-fran%C3%A7ais-facile/">RFI – Journal en français facile</a>
      <a href="#" data-url="https://www.radiofrance.fr/franceinfo/podcasts">franceinfo – Podcasts</a>
      <a href="#" data-url="https://www.franceculture.fr/podcasts">France Culture – Podcasts</a>
      <a href="#" data-url="https://www.arteradio.com/podcast">ARTE Radio – Podcasts</a>
      <a href="#" data-url="https://www.tv5monde.com/fr/decouvrir/podcasts">TV5MONDE – Podcasts</a>
      <a href="#" data-url="https://upload.wikimedia.org/wikipedia/commons/4/4e/Fr-Paris.ogg">Wikimedia – Testaudio (Direkt)</a>
    </div>

    <audio id="news-audio" preload="none" crossorigin="anonymous"></audio>
  </details>

  <div id="results" class="grid"></div>
  <div id="empty" class="empty" hidden>Keine Einträge gefunden.</div>
</div>

<!-- floating tray -->
<div class="tray" aria-live="polite">
  <div class="inner">
    <button id="stop" style="background:#b64b4b;border:1px solid #a54242;color:#fff;border-radius:12px;padding:8px 14px">■ Stop</button>
    <button id="next" style="background:var(--accent-strong);border:1px solid #2a7bdd;color:#fff;border-radius:12px;padding:8px 14px">▶ Nächste</button>
    <span class="status" id="shadow-status">Shadow inaktiv</span>
  </div>
</div>

<script>
(() => {
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const BASE = new URL('./', location.href);
  const urlFor = p=> new URL(p, BASE).toString();
  const fetchJson = async p => { const res = await fetch(urlFor(p), {cache:'no-store'}); if(!res.ok) throw new Error(p+': '+res.status); return res.json(); };

  const state = {
    items:[], q:'', category:'', show:'all',
    tts:{voices:[],ready:false}, todaySet:new Set(),
    newsRate:1.0
  };

  /* ---------- Load all data from manifest ---------- */
  async function loadAll(){
    try{
      const manifest = await fetchJson('data/manifest.json');
      const packs = Array.isArray(manifest.packs) ? manifest.packs : [];
      const names = manifest.categoryNames || {};
      const labels= manifest.categoryLabels || {};
      const order = manifest.categoryOrder || [];
      state.todaySet = new Set(Array.isArray(manifest.todayPacks)?manifest.todayPacks:[]);

      const settled = await Promise.allSettled(packs.map(async p=>({path:p, raw:await fetchJson(p)})));

      const categories = new Map(); // key -> label
      state.items.length = 0;

      for(const r of settled){
        if(r.status!=='fulfilled') continue;
        const {path, raw} = r.value;
        const rows = Array.isArray(raw) ? raw : (Array.isArray(raw?.phrases)?raw.phrases:[]);
        const key = names[path] || raw?.name || path.split('/').pop().replace(/\..+$/,'');
        const label = labels[key] || key;
        categories.set(key, label);

        rows.forEach((row, idx)=>{
          state.items.push({
            id:`${path}#${idx}`,
            pack:path,
            categoryKey:key,
            categoryLabel:label,
            fr:String(row.fr ?? ''),
            de:String(row.de ?? row.en ?? ''),
            hint:String(row.hint ?? ''),
            date:String(row.date || '')
          });
        });
      }

      // build category select
      const sel=$('#category');
      const keys=Array.from(categories.keys());
      const ordered=[...order.filter(k=>keys.includes(k)), ...keys.filter(k=>!order.includes(k)).sort()];
      sel.innerHTML = '<option value="">Alle Kategorien</option>' +
        ordered.map(k=>`<option value="${k}">${categories.get(k)}</option>`).join('');

      render();
    }catch(e){
      $('#empty').hidden=false; $('#empty').textContent='Fehler beim Laden: '+e.message;
      console.error(e);
    }
  }

  /* ---------- Render ---------- */
  function esc(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}
  function attr(s){return esc(s).replace(/`/g,'&#96;');}

  function render(){
    const list=$('#results'); list.innerHTML='';
    let view=state.items.slice();

    if(state.category) view = view.filter(x=>x.categoryKey===state.category);

    if(state.q){
      const q = state.q.toLowerCase();
      view = view.filter(x=>(x.fr+x.de+x.categoryLabel).toLowerCase().includes(q));
    }

    if(state.show==='today'){
      const todayISO=new Date().toISOString().slice(0,10);
      view = view.filter(x => state.todaySet.size>0 ? state.todaySet.has(x.pack) : (x.date && x.date.startsWith(todayISO)));
    }

    if(!view.length){ $('#empty').hidden=false; return; } else $('#empty').hidden=true;

    view.forEach(item=>{
      const card=document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div class="txt-main">${esc(item.fr)}</div>
        <div class="txt-sub">DE: ${esc(item.de)}</div>
        <div class="play-group">
          <button class="play" data-text="${attr(item.fr)}" data-rate="1">Abspielen</button>
          <button class="play" data-text="${attr(item.fr)}" data-rate="0.9">Langsam</button>
          <button class="play" data-text="${attr(item.fr)}" data-rate="0.7">Sehr langsam</button>
        </div>
        <button class="rec rec-btn pill-success" data-text="${attr(item.fr)}">Aufnehmen</button>
        <div class="scorebar"><i></i></div>
        <div class="muted" data-role="heard" style="margin-top:6px"></div>
      `;
      list.appendChild(card);
    });
  }

  /* ---------- Search & filters ---------- */
  $('#q').addEventListener('input', e=>{ state.q = e.target.value.trim(); render(); });
  $('#category').addEventListener('change', e=>{ state.category = e.target.value; render(); });
  $('#show-today').addEventListener('click', ()=>{ state.show='today'; render(); });
  $('#show-all').addEventListener('click',   ()=>{ state.show='all'; render(); });
  $('#show-packs').addEventListener('click', ()=>{ state.show='packs'; render(); }); // placeholder: same list – packs header removed for compact UI

  /* ---------- TTS / SR ---------- */
  function speak(text, rate=1){
    try{
      speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(text);
      u.lang='fr-FR'; u.rate=rate;
      speechSynthesis.speak(u);
    }catch{}
  }
  const norm=s=>String(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z\' ]/g,' ').replace(/\s+/g,' ').trim();
  function scoreWords(a,b){ if(!a||!b) return 0; const wa=a.split(' '), wb=b.split(' '); let hit=0; wa.forEach(w=>{ if(wb.includes(w)) hit++; }); return Math.round(100*hit/wa.length); }

  $('#results').addEventListener('click', e=>{
    const t=e.target;
    if(t.classList.contains('play')){
      speak(t.dataset.text, parseFloat(t.dataset.rate||'1'));
      return;
    }
    if(t.classList.contains('rec')){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){ alert('Spracherkennung nicht verfügbar.'); return; }
      const expect=t.dataset.text; const card=t.closest('.card');
      const bar=card.querySelector('.scorebar i'); const out=card.querySelector('[data-role="heard"]');
      out.textContent='… hört zu …';
      const rec=new SR(); rec.lang='fr-FR'; rec.interimResults=false; rec.continuous=false;
      try{ rec.start(); }catch{}
      rec.onresult=(ev)=>{
        const said=Array.from(ev.results).map(r=>r[0].transcript).join(' ');
        const acc=scoreWords(norm(expect),norm(said));
        out.innerHTML=`<b>Verstanden:</b> ${esc(said)} &nbsp;(${acc}%)`;
        bar.style.width=acc+'%';
      };
      rec.onerror=()=>{ out.textContent='Fehler bei der Aufnahme'; };
      rec.onend=()=>{ if(out.textContent==='… hört zu …') out.textContent='—'; };
    }
  });

  /* ---------- Next / Stop ---------- */
  $('#next').addEventListener('click', ()=>{
    const cards=$$('.card'); if(!cards.length) return;
    const y=window.scrollY+80;
    let idx=cards.findIndex(c=>c.offsetTop>y);
    if(idx===-1) idx=0;
    const t=cards[idx];
    t.scrollIntoView({behavior:'smooth',block:'center'});
    const btn=t.querySelector('.play[data-rate="1"]'); if(btn) setTimeout(()=>btn.click(),300);
  });

  $('#stop').addEventListener('click', ()=>{
    try{ speechSynthesis.cancel(); }catch{}
    const a=$('#news-audio'); if(a && !a.paused){ try{ a.pause(); }catch{} }
    window.scrollTo({top:0,behavior:'smooth'});
  });

  /* ---------- Mic search ---------- */
  (()=>{
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    const mic=$('#mic');
    if(!SR){ mic.disabled=true; mic.title='Spracherkennung nicht verfügbar'; return; }
    let active=false; const r=new SR(); r.lang='fr-FR'; r.interimResults=false; r.continuous=false;
    mic.addEventListener('click', ()=>{
      if(active){ r.stop(); return; }
      active=true; mic.textContent='Stoppen';
      try{ r.start(); }catch{}
    });
    r.onresult=e=>{
      const t=Array.from(e.results).map(x=>x[0].transcript).join(' ');
      $('#q').value=t; state.q=t; render();
    };
    r.onerror=()=>{ active=false; mic.textContent='Mikrofon'; };
    r.onend  =()=>{ active=false; mic.textContent='Mikrofon'; };
  })();

  /* ---------- News / Audio ---------- */
  const audio=$('#news-audio');
  const isAudioUrl=u=>/\.(mp3|m4a|aac|ogg|oga|opus|wav)(\?|$)/i.test(u);
  function playFrom(url){
    if(!url){ alert('Bitte MP3/Stream-URL einfügen'); return; }
    if(!isAudioUrl(url)){ window.open(url,'_blank'); $('#news-url').value=url; return; }
    try{ audio.src=url; audio.playbackRate=state.newsRate; audio.play().catch(()=>alert('Konnte Audio nicht abspielen (CORS/URL prüfen).')); }catch{}
  }
  $('#news-play').addEventListener('click', ()=>playFrom($('#news-url').value.trim()));
  $('#news-stop').addEventListener('click', ()=>{ try{ audio.pause(); }catch{} });
  $('#news-back20').addEventListener('click', ()=>{ try{ audio.currentTime=Math.max(0,(audio.currentTime||0)-20); }catch{} });
  $$('.speed').forEach(b=>b.addEventListener('click', ()=>{
    state.newsRate=parseFloat(b.dataset.rate||'1'); audio.playbackRate=state.newsRate;
    $$('.speed').forEach(x=>x.style.outline='none'); b.style.outline='2px solid var(--accent)';
  }));
  $$('.links a').forEach(a=>a.addEventListener('click', e=>{
    e.preventDefault(); const url=a.getAttribute('data-url');
    if(isAudioUrl(url)) $('#news-url').value=url; else window.open(url,'_blank');
  }));
  const loadPresets=()=>{ const p=JSON.parse(localStorage.getItem('ff.presets')||'{}'); for(let i=1;i<=4;i++){ if(p['t'+i]) $('#p'+i+'-title').value=p['t'+i]; if(p['u'+i]) $('#p'+i+'-url').value=p['u'+i]; } };
  const savePreset=i=>{ const p=JSON.parse(localStorage.getItem('ff.presets')||'{}'); p['t'+i]=$('#p'+i+'-title').value.trim(); p['u'+i]=$('#p'+i+'-url').value.trim(); localStorage.setItem('ff.presets',JSON.stringify(p)); };
  const playPreset=i=>{ const url=$('#p'+i+'-url').value.trim(); if(!url){ alert('Preset-URL fehlt'); return; } $('#news-url').value=url; playFrom(url); };
  $$('.preset-save').forEach(b=>b.addEventListener('click',()=>savePreset(b.dataset.slot)));
  $$('.preset-play').forEach(b=>b.addEventListener('click',()=>playPreset(b.dataset.slot)));
  loadPresets();

  /* boot */
  loadAll();
})();
</script>
</body>
</html>
